<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <title>Budget Tracker</title>
  <meta name="theme-color" content="#4299e1">
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root {
      --primary-color: #4299e1;
      --accent-color: #7F9CF5;
      --background: #f9fafb;
      --text-dark: #1a202c;
      --text-light: #fff;
      --danger: #e53e3e;
      --success: #38a169;
      --card-bg: #fff;
      --border: #e2e8f0;
      --radius: 0.5rem;
      --focus: #3182ce;
      --input-bg: #edf2f7;
      --grey: #a0aec0;
      --max-width: 600px;
    }

    html, body {
      background: var(--background);
      color: var(--text-dark);
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
      height: 100%;
    }

    .container {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    h1 {
      font-size: 2.3rem;
      margin: 0 0 0.75rem;
      font-weight: 700;
      letter-spacing: -1px;
      color: var(--primary-color);
      text-align: center;
    }

    .summary-cards {
      display: flex;
      flex-direction: row;
      gap: 1rem;
      justify-content: space-between;
    }
    .summary-card {
      flex: 1;
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: 0 1px 3px rgba(50, 80, 200, 0.02);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1px solid var(--border);
      min-width: 0;
    }
    .summary-card.balance { border: 2px solid var(--primary-color); }
    .summary-card .label {
      font-size: 0.9rem;
      letter-spacing: 0.04em;
      margin-bottom: 0.1rem;
      color: var(--grey);
    }
    .summary-card .value {
      font-size: 1.35rem;
      font-weight: 600;
      color: var(--text-dark);
      word-break: break-all;
    }
    .summary-card.positive .value { color: var(--success); }
    .summary-card.negative .value { color: var(--danger); }

    .form-section {
      background: var(--card-bg);
      box-shadow: 0 1px 3px rgba(80,80,80,.04);
      border-radius: var(--radius);
      padding: 1.25rem;
      border: 1px solid var(--border);
      margin-bottom: 0.5rem;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 1rem;
      gap: 0.4rem;
      position: relative;
    }
    .form-group:last-child {
      margin-bottom: 0;
    }
    .form-label {
      font-size: 1rem;
      color: var(--text-dark);
      font-weight: 500;
      letter-spacing: 0.02em;
    }
    .input-icon {
      position: relative;
      display: flex;
      align-items: center;
    }
    .currency-symbol {
      position: absolute;
      left: 10px;
      color: var(--accent-color);
      pointer-events: none;
      font-size: 1.1em;
      top: 50%;
      transform: translateY(-50%);
      font-weight: 500;
    }
    .input-icon input[type="number"] {
      padding-left: 2em;
    }
    input, select {
      background: var(--input-bg);
      padding: 0.56em 0.8em;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      outline: none;
      font-size: 1.03rem;
      transition: border-color 0.14s, box-shadow 0.17s;
      width: 100%;
      margin-top: 2px;
      color: var(--text-dark);
      box-sizing: border-box;
    }
    input:focus, select:focus {
      border-color: var(--focus);
      box-shadow: 0 0 1px 2px rgba(66,153,225,0.04);
    }
    .form-error {
      color: var(--danger);
      font-size: 0.97em;
      margin-top: 1px;
      padding-left: 0.4em;
      display: block;
    }
    .button-row {
      display: flex;
      gap: 1rem;
      margin-left: -0.5em;
      margin-right: -0.5em;
      flex-wrap: wrap;
    }
    button, .btn {
      background: var(--primary-color);
      color: var(--text-light);
      border: none;
      border-radius: var(--radius);
      font-size: 1rem;
      font-weight: 500;
      padding: 0.72em 1.3em;
      margin: 0.2em 0;
      cursor: pointer;
      box-shadow: 0 2px 9px -6px var(--primary-color);
      letter-spacing: 0.04em;
      transition: background 0.17s, box-shadow 0.18s, transform .12s;
    }
    button:active { transform: scale(0.99);}
    button:focus {
      outline: 2px solid var(--focus);
      outline-offset: 2px;
    }
    .btn-secondary {
      background: var(--accent-color);
      color: #fff;
    }

    .transactions-section {
      background: var(--card-bg);
      padding: 1.25rem 0.8rem;
      border-radius: var(--radius);
      box-shadow: 0 0.5px 2px rgba(68, 70, 90, 0.04);
      border: 1px solid var(--border);
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.98rem;
      margin-top: 0.3rem;
    }
    th, td {
      text-align: left;
      padding: 0.6em 0.4em;
      border-bottom: 1px solid var(--border);
    }
    th {
      font-weight: 700;
      color: var(--primary-color);
      background: #f3f5fb;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .type-income {
      color: var(--success);
      font-weight: 600;
    }
    .type-expense {
      color: var(--danger);
      font-weight: 600;
    }
    .action-btns button {
      margin-right: 0.3em;
      border: none;
      background: var(--accent-color);
      color: #fff;
      padding: 0.35em 0.9em;
      border-radius: 0.3em;
      font-size: 0.93em;
      cursor: pointer;
      transition: background 0.15s;
    }
    .action-btns button:last-child { margin-right:0; }
    .action-btns button.delete { background: var(--danger); }
    .action-btns button:hover {
      background: var(--focus);
    }
    .action-btns button.delete:hover {
      background: #c53030;
    }

    /* Guided Mode Overlay  */
    .guided-overlay {
      position: fixed;
      top:0;left:0;right:0;bottom:0;
      background: rgba(66,153,225,0.1);
      z-index: 1000;
      display: flex;
      align-items:center;
      justify-content:center;
      transition:background .25s;
    }
    .guided-modal {
      background: #fff;
      border-radius: var(--radius);
      padding: 2.2rem 1.3rem 1.35rem;
      max-width: 90vw;
      box-shadow: 0 6px 24px -7px var(--primary-color);
      text-align: center;
      border: 2px solid var(--primary-color);
    }
    .guided-modal h2 {
      color: var(--primary-color);
      margin: 0 0 0.8em;
      font-size: 1.5rem;
    }
    .guided-modal p { color: var(--text-dark); font-size:1.06rem;}
    .guided-steps {
      margin: 0.7em 0 1.1em;
      color: var(--grey);
      font-size: 0.98em;
    }
    .guided-btn-row {
      display: flex;
      gap: 1em;
      justify-content:center;
    }
    .guided-btn {
      background:var(--primary-color);
      color:#fff;
      border:none;
      border-radius: var(--radius);
      padding:0.65em 1.2em;
      font-size:1em;
      font-weight:500;
      transition:background .13s;
      cursor:pointer;
    }
    .guided-btn.secondary { background:var(--accent-color);}
    .guided-btn:focus { outline:2px solid var(--focus);}
    .close-x {
      position: absolute; top: 15px; right: 15px; font-size:1.3em; font-weight:bold;
      color:var(--grey); cursor:pointer;
      background:none; border:none; outline:none;
    }
    .close-x:hover { color:var(--danger);}
    .hidden { display: none !important; }

    /* Miscellaneous polish */
    .category-badge {
      background: var(--accent-color);
      color: #fff;
      border-radius: 0.3em;
      padding: 0.1em 0.55em;
      font-size: 0.88em;
      font-weight: 500;
      margin-left: 0.12em;
      letter-spacing: 0.01em;
    }

    /* Responsive - mobile-first */
    @media (max-width: 660px) {
      .summary-cards {
        flex-direction: column;
        gap: 0.8rem;
      }
      .summary-card { min-width: 0; }
      .form-section, .transactions-section {
        border-radius: 0.28rem;
        padding: 0.7rem 0.45rem 0.7rem;
      }
      .transactions-section { font-size: 0.97rem;}
      .container { padding: 0.6rem; }
      th, td { padding: 0.44em 0.2em; }
    }

    /* Accessibility: visual high-contrast focus styles and error highlighting */
    input:invalid, select:invalid {
      border-color: var(--danger);
      box-shadow: 0 0 8px 0 #e53e3e22;
    }
    input:focus:invalid {
      border-color: var(--danger);
      box-shadow: 0 0 8px 0 #e53e3e22;
    }
    .announce {
      clip-path: inset(50%); position:absolute; left:-9999px; height:1px; width:1px;
    }
  </style>

</head>
<body>
  <main class="container" aria-label="Budget App Main Container">
    <h1>Budget Tracker</h1>
    <section class="summary-cards" aria-label="Budget Summary">
      <div class="summary-card positive">
        <span class="label">Total Income</span>
        <span class="value" id="total-income">₦0</span>
      </div>
      <div class="summary-card negative">
        <span class="label">Total Expenses</span>
        <span class="value" id="total-expenses">₦0</span>
      </div>
      <div class="summary-card balance">
        <span class="label">Balance</span>
        <span class="value" id="total-balance">₦0</span>
      </div>
    </section>

    <!-- Income Input Section -->
    <section class="form-section" aria-label="Add Income">
      <form id="income-form" autocomplete="off" novalidate>
        <fieldset>
          <legend>Add Income</legend>
          <div class="form-group">
            <label for="income-description" class="form-label">Description</label>
            <input id="income-description" type="text" maxlength="32" required aria-required="true" aria-describedby="income-desc-err" placeholder="E.g. Salary">
            <div class="form-error" id="income-desc-err" aria-live="polite"></div>
          </div>
          <div class="form-group">
            <label for="income-amount" class="form-label">Amount</label>
            <div class="input-icon">
              <span class="currency-symbol" aria-hidden="true">₦</span>
              <input id="income-amount" type="number" inputmode="decimal" pattern="^[0-9]+([.,][0-9]{1,2})?$" min="0" step="0.01" required aria-required="true" aria-describedby="income-amount-err" placeholder="0.00">
            </div>
            <div class="form-error" id="income-amount-err" aria-live="polite"></div>
          </div>
          <div class="button-row">
            <button type="submit" class="btn">Add Income</button>
          </div>
        </fieldset>
      </form>
    </section>

    <!-- Expenses Input Section -->
    <section class="form-section" aria-label="Add Expense">
      <form id="expense-form" autocomplete="off" novalidate>
        <fieldset>
          <legend>Add Expense</legend>
          <div class="form-group">
            <label for="expense-description" class="form-label">Description</label>
            <input id="expense-description" type="text" maxlength="32" required aria-required="true" aria-describedby="expense-desc-err" placeholder="E.g. Rent">
            <div class="form-error" id="expense-desc-err" aria-live="polite"></div>
          </div>
          <div class="form-group">
            <label for="expense-category" class="form-label">Category</label>
            <select id="expense-category" required aria-required="true" aria-describedby="expense-cat-err">
              <option value="">Select Category</option>
              <option value="Housing">Housing</option>
              <option value="Food">Food</option>
              <option value="Transportation">Transportation</option>
              <option value="Entertainment">Entertainment</option>
              <option value="Utilities">Utilities</option>
              <option value="Healthcare">Healthcare</option>
              <option value="Other">Other</option>
            </select>
            <div class="form-error" id="expense-cat-err" aria-live="polite"></div>
          </div>
          <div class="form-group">
            <label for="expense-amount" class="form-label">Amount</label>
            <div class="input-icon">
              <span class="currency-symbol" aria-hidden="true">₦</span>
              <input id="expense-amount" type="number" inputmode="decimal" pattern="^[0-9]+([.,][0-9]{1,2})?$" min="0" step="0.01" required aria-required="true" aria-describedby="expense-amount-err" placeholder="0.00">
            </div>
            <div class="form-error" id="expense-amount-err" aria-live="polite"></div>
          </div>
          <div class="button-row">
            <button type="submit" class="btn">Add Expense</button>
          </div>
        </fieldset>
      </form>
    </section>

    <!-- Transaction List Table -->
    <section class="transactions-section" aria-label="Transaction History">
      <h2 style="margin-bottom:0.2em;font-size:1.21rem;color:var(--primary-color);">Transaction History</h2>
      <table aria-label="History Table">
        <thead>
          <tr>
            <th scope="col">Description</th>
            <th scope="col">Category</th>
            <th scope="col">Amount</th>
            <th scope="col">Type</th>
            <th scope="col">Action</th>
          </tr>
        </thead>
        <tbody id="transaction-history">
          <!-- Populated dynamically -->
        </tbody>
      </table>
      <div aria-live="polite" id="transactions-empty" class="form-error" style="display:none;text-align:center;font-size:1.1em;font-weight:500;">No transactions yet.</div>
    </section>

    <!-- Controls -->
    <section class="form-section" style="margin-bottom:2em;">
      <div class="button-row" style="justify-content: space-between;">
        <button type="button" class="btn btn-secondary" id="guided-mode-btn" tabindex="0" aria-label="Show Guided Mode">Guided Mode</button>
        <button type="button" class="btn" id="clear-data-btn" tabindex="0" aria-label="Clear All Data">Clear All</button>
      </div>
    </section>
  </main>

  <!-- Guided Mode Overlay -->
  <div id="guided-modal-overlay" class="guided-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="guided-modal-title" aria-describedby="guided-modal-desc">
    <div class="guided-modal">
      <button class="close-x" id="guided-close-btn" aria-label="Close Guided Mode">&times;</button>
      <h2 id="guided-modal-title">Budget App Guided Mode</h2>
      <div id="guided-modal-content"></div>
      <div class="guided-steps" id="guided-modal-steps"></div>
      <div class="guided-btn-row">
        <button class="guided-btn" id="guided-next-btn">Next</button>
        <button class="guided-btn secondary" id="guided-skip-btn">Skip</button>
      </div>
    </div>
  </div>

  <!-- Aria Live Region for Success/Error Announcements -->
  <div class="announce" id="announce-msg" aria-live="polite"></div>

  <script>
    // Utility functions and state
    let transactions = [];
    let totalIncome = 0;
    let totalExpenses = 0;

    // Storage keys
    const LS_TRANSACTIONS = 'budget_transactions';
    const LS_INCOME = 'budget_total_income';
    const LS_EXPENSES = 'budget_total_expenses';
    const LS_GUIDED = 'budget_guided_seen';

    // - - - - Persistent Storage Helpers - - - -
    function saveData() {
      localStorage.setItem(LS_TRANSACTIONS, JSON.stringify(transactions));
      localStorage.setItem(LS_INCOME, '' + totalIncome);
      localStorage.setItem(LS_EXPENSES, '' + totalExpenses);
    }
    function loadData() {
      const tdata = localStorage.getItem(LS_TRANSACTIONS);
      transactions = tdata ? JSON.parse(tdata) : [];
      totalIncome = parseFloat(localStorage.getItem(LS_INCOME)) || 0;
      totalExpenses = parseFloat(localStorage.getItem(LS_EXPENSES)) || 0;
    }
    function clearData() {
      if (confirm('Are you sure you want to clear all data?')) {
        localStorage.removeItem(LS_TRANSACTIONS);
        localStorage.removeItem(LS_INCOME);
        localStorage.removeItem(LS_EXPENSES);
        transactions = [];
        totalIncome = 0;
        totalExpenses = 0;
        render();
        announce('All budget data cleared!');
      }
    }

    // - - - - Currency Formatting - - - -
    function showAmount(val) {
      return '₦' + (Number(val) || 0).toLocaleString(undefined, {minimumFractionDigits:2,maximumFractionDigits:2});
    }

    // - - - - Form Validation Helpers - - - -
    function validateInput(input, errorId, validator, message) {
      if (!validator(input.value)) {
        input.setAttribute('aria-invalid','true');
        document.getElementById(errorId).textContent = message;
        return false;
      } else {
        input.removeAttribute('aria-invalid');
        document.getElementById(errorId).textContent = '';
        return true;
      }
    }
    function clearFormValidation(form) {
      form.querySelectorAll('.form-error').forEach(e => e.textContent = '');
      form.querySelectorAll('input,select').forEach(i => i.removeAttribute('aria-invalid'));
    }

    // - - - - Transaction Operations - - - -
    function addTransaction(type, desc, amount, cat) {
      const created = new Date().toISOString();
      transactions.push({id: Date.now() + Math.random(), type, desc, amount: Number(amount), cat, created});
      if (type === 'income') totalIncome += Number(amount);
      else if (type === 'expense') totalExpenses += Number(amount);
      saveData();
      render();
      announce((type === 'income' ? 'Income' : 'Expense') + ' added!');
    }
    function removeTransaction(id) {
      const idx = transactions.findIndex(t => t.id === id);
      if (idx > -1) {
        const tx = transactions[idx];
        if (tx.type === 'income') totalIncome -= tx.amount;
        else totalExpenses -= tx.amount;
        transactions.splice(idx, 1);
        saveData();
        render();
        announce('Transaction removed!');
      }
    }

    // - - - - Rendering Functions - - - -
    function renderSummary() {
      document.getElementById('total-income').textContent = showAmount(totalIncome);
      document.getElementById('total-expenses').textContent = showAmount(totalExpenses);
      document.getElementById('total-balance').textContent = showAmount(totalIncome - totalExpenses);
      document.getElementById('total-balance').parentElement.className =
          'summary-card balance' + ((totalIncome - totalExpenses) < 0 ? ' negative':' positive');
    }
    function renderTransactions() {
      const history = document.getElementById('transaction-history');
      history.innerHTML = '';
      if (transactions.length === 0) {
        document.getElementById('transactions-empty').style.display = 'block';
        return;
      }
      document.getElementById('transactions-empty').style.display = 'none';
      const rows = transactions.slice().reverse().map(tx => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${tx.desc}</td>
          <td><span class="category-badge">${tx.cat || '-'}</span></td>
          <td>${showAmount(tx.amount)}</td>
          <td class="${tx.type === 'income' ? 'type-income' : 'type-expense'}">${tx.type.charAt(0).toUpperCase()+tx.type.slice(1)}</td>
          <td class="action-btns">
            <button class="delete" title="Delete" aria-label="Delete" onclick="removeTransactionConfirm(${tx.id})">🗑</button>
          </td>
        `;
        return tr;
      });
      rows.forEach(r => history.appendChild(r));
    }
    window.removeTransactionConfirm = function(id) {
      if (confirm('Are you sure you want to remove this transaction?')) removeTransaction(id);
    };

    // - - - - Initialization and Event Handlers - - - -
    function render() {
      renderSummary();
      renderTransactions();
    }

    function announce(msg) {
      document.getElementById('announce-msg').textContent = msg;
      setTimeout(() => document.getElementById('announce-msg').textContent = '', 2800);
    }

    function handleIncomeForm(e) {
      e.preventDefault();
      const desc = document.getElementById('income-description');
      const val = document.getElementById('income-amount');
      let valid = true;
      valid &= validateInput(desc, "income-desc-err", v => v.trim().length > 0, "Add a description");
      valid &= validateInput(val, "income-amount-err", v => /^\d+(\.\d{1,2})?$/.test(v.trim()) && Number(v) > 0, "Valid amount required");
      if (!valid) return;
      addTransaction('income', desc.value.trim(), val.value, '');
      e.target.reset();
      clearFormValidation(e.target);
      desc.focus();
    }

    function handleExpenseForm(e) {
      e.preventDefault();
      const desc = document.getElementById('expense-description');
      const cat = document.getElementById('expense-category');
      const val = document.getElementById('expense-amount');
      let valid = true;
      valid &= validateInput(desc, "expense-desc-err", v => v.trim().length > 0, "Add a description");
      valid &= validateInput(cat, "expense-cat-err", v => v.trim().length > 0, "Pick a category");
      valid &= validateInput(val, "expense-amount-err", v => /^\d+(\.\d{1,2})?$/.test(v.trim()) && Number(v) > 0, "Valid amount required");
      if (!valid) return;
      addTransaction('expense', desc.value.trim(), val.value, cat.value);
      e.target.reset();
      clearFormValidation(e.target);
      desc.focus();
    }

    // Input: only allow numbers and "soft" decimal
    document.addEventListener('input', function(e) {
      if (e.target.type === "number") {
        e.target.value = e.target.value.replace(/[^\d.]/g, '');
      }
    });

    // - - - - Guided Mode Implementation - - - -
    const guidedSteps = [
      {
        title: "Welcome to Budget Tracker!",
        desc: "Easily record income and expenses, and track your financial health.",
      },
      {
        title: "Step 1: Add Income",
        desc: "Use the <b>Add Income</b> form to record any source of funds (e.g., salary, business, etc). Enter a brief description and amount, then click <i>Add Income</i>.",
      },
      {
        title: "Step 2: Add Expenses",
        desc: "To log your expenses, use the <b>Add Expense</b> form. Describe the expense, pick a category, enter the amount, and click <i>Add Expense</i>.",
      },
      {
        title: "Step 3: View Transactions",
        desc: "Your income and expenses appear below in the <b>Transaction History</b>. Remove items by clicking the delete button.",
      },
      {
        title: "Step 4: Review Summary",
        desc: "At the top of the app, <b>totals</b> for income, expenses, and your current balance update automatically and persist across sessions.",
      },
      {
        title: "Step 5: Clear & Guided Mode",
        desc: "You can clear all saved data with the <b>Clear All</b> button. Replay this tutorial any time by clicking <b>Guided Mode</b>.",
      },
      {
        title: "That's it!",
        desc: "You're ready to take control of your finances. Enjoy the app!",
      }
    ];
    let guidedStep = 0;
    function showGuidedModal(step=0) {
      guidedStep = step;
      document.getElementById('guided-modal-content').innerHTML =
        `<p id="guided-modal-desc">${guidedSteps[guidedStep].desc}</p>`;
      document.getElementById('guided-modal-title').textContent = guidedSteps[guidedStep].title;
      document.getElementById('guided-modal-steps').textContent =
        `Step ${guidedStep+1} of ${guidedSteps.length}`;
      document.getElementById('guided-modal-overlay').classList.remove('hidden');
      document.getElementById('guided-next-btn').textContent =
        (guidedStep < guidedSteps.length-1) ? 'Next' : 'Finish';
      document.getElementById('guided-next-btn').focus();
    }
    function closeGuidedModal() {
      document.getElementById('guided-modal-overlay').classList.add('hidden');
      // Mark guided seen
      window.localStorage.setItem(LS_GUIDED,'yes');
    }
    document.getElementById('guided-next-btn').onclick = function() {
      if(guidedStep < guidedSteps.length-1){ showGuidedModal(guidedStep+1);}
      else closeGuidedModal();
    };
    document.getElementById('guided-skip-btn').onclick = closeGuidedModal;
    document.getElementById('guided-close-btn').onclick = closeGuidedModal;
    document.getElementById('guided-mode-btn').onclick = function() {
      showGuidedModal(0); window.localStorage.removeItem(LS_GUIDED);
    };
    document.body.addEventListener('keydown', function(e) {
      if(!document.getElementById('guided-modal-overlay').classList.contains('hidden')) {
        if(e.key=="Escape") closeGuidedModal();
        if(e.key=="Enter") document.getElementById('guided-next-btn').click();
      }
    });

    // - - - - Main Init - - - -
    window.addEventListener('DOMContentLoaded', function() {
      loadData();
      render();
      // Show guided mode if not seen before
      if(!window.localStorage.getItem(LS_GUIDED))
        setTimeout(()=>showGuidedModal(0), 420);
      // Set up form handlers
      document.getElementById('income-form').onsubmit = handleIncomeForm;
      document.getElementById('expense-form').onsubmit = handleExpenseForm;
      document.getElementById('clear-data-btn').onclick = clearData;
    });

    // For PWA: Optional service worker registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('sw.js').catch(()=>{});
      });
    }

  </script>
</body>
</html>
