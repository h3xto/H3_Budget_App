<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>H³ Budget Tool</title>
  <meta name="theme-color" content="#0f172a" />
  <link rel="icon" href="assets/h3-logo.png" />
  <style>
    :root {
      --bg: #0b0f19;
      --panel: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --primary: #60a5fa;
      --accent: #34d399;
      --warn: #fbbf24;
      --danger: #f87171;
      --border: #1f2937;
      --shadow: 0 6px 18px rgba(0,0,0,0.35);
      --input: #0f172a;
      --chip: #0b1220;
    }
    :root[data-theme="light"] {
      --bg: #f7fafc;
      --panel: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --primary: #2563eb;
      --accent: #059669;
      --warn: #b45309;
      --danger: #b91c1c;
      --border: #e5e7eb;
      --shadow: 0 6px 18px rgba(0,0,0,0.06);
      --input: #f1f5f9;
      --chip: #eef2ff;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .app {
      max-width: 720px;
      margin: 0 auto;
      padding: 12px 12px 28px;
    }
    header {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 12px;
      align-items: center;
      padding: 10px 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: saturate(1.2) blur(8px);
    }
    header img.logo {
      width: 40px; height: 40px; border-radius: 9px; display: block;
    }
    .title {
      display: flex; flex-direction: column; gap: 2px;
    }
    .title .name { font-weight: 800; letter-spacing: 0.2px; }
    .title .motto { color: var(--muted); font-size: 12px; letter-spacing: 0.3px; }
    .controls { display: flex; gap: 8px; align-items: center; }
    .chip {
      background: var(--chip); border: 1px solid var(--border); color: var(--text);
      border-radius: 999px; padding: 6px 10px; font-weight: 600; cursor: pointer;
    }

    .section {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      margin-top: 14px;
      padding: 12px;
      box-shadow: var(--shadow);
    }
    .section h2 {
      margin: 0 0 10px;
      font-size: 16px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    .row-4 { display: grid; grid-template-columns: 1.2fr .8fr .8fr .8fr; gap: 8px; }
    .row-5 { display: grid; grid-template-columns: 1fr .8fr .8fr .8fr .6fr; gap: 8px; }
    @media (max-width: 480px) {
      .row, .row-3, .row-4, .row-5 { grid-template-columns: 1fr; }
    }
    label { display: flex; flex-direction: column; gap: 6px; font-size: 12px; color: var(--muted); }
    input, select, button {
      border: 1px solid var(--border);
      background: var(--input);
      color: var(--text);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
    }
    input::placeholder { color: #8b97a8; }
    button.add { background: var(--primary); color: #fff; border: none; }
    button.minor { background: transparent; }
    .list { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
    .card {
      border: 1px solid var(--border); background: rgba(255,255,255,0.02);
      border-radius: 12px; padding: 10px; display: grid; gap: 8px;
    }
    .line {
      display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center;
    }
    .mono { font-variant-numeric: tabular-nums; font-feature-settings: "tnum"; }
    .muted { color: var(--muted); }
    .ok { color: var(--accent); }
    .danger { color: var(--danger); }
    .warn { color: var(--warn); }
    .totals { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 6px; }
    .badge {
      background: var(--chip); border: 1px solid var(--border);
      padding: 6px 8px; border-radius: 999px; font-weight: 700; font-size: 12px;
    }
    .summary p { margin: 6px 0; }
    .grid-2 { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 640px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
    .kpi {
      border: 1px dashed var(--border); border-radius: 12px; padding: 10px;
      background: rgba(255,255,255,0.02);
    }
    .kpi h3 { margin: 0 0 6px; font-size: 14px; }
    .right { text-align: right; }
    .tip-row { display: flex; flex-wrap: wrap; gap: 8px; }
    .tip-row button { background: var(--primary); color: #fff; border: none; }
    .hide { display: none !important; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <img class="logo" src="assets/h3-logo.png" alt="H3 Logo" />
      <div class="title">
        <div class="name">H³ Budget Tool</div>
        <div class="motto">Private • Goal‑Focused • Offline</div>
      </div>
      <div class="controls">
        <button id="themeToggle" class="chip" type="button">Light/Dark</button>
      </div>
    </header>

    <div class="section">
      <h2>Profile & cadence</h2>
      <div class="row">
        <label>
          Display name
          <input id="displayName" placeholder="Name for your plan" />
        </label>
        <label>
          Pay cadence
          <select id="cadence">
            <option value="52">Weekly (52/yr)</option>
            <option value="26">Bi‑Weekly (26/yr)</option>
            <option value="24">Bi‑Monthly (24/yr)</option>
          </select>
        </label>
      </div>
    </div>

    <div class="section" id="incomeSec">
      <h2>
        Income
        <button class="chip" id="addIncome" type="button">+ Add income source</button>
      </h2>
      <div id="incomeList" class="list"></div>
      <div class="totals">
        <div class="badge">Monthly income: <span id="incomeTotal" class="mono">$0.00</span></div>
      </div>
    </div>

    <div class="section" id="essentialsSec">
      <h2>
        Essentials
        <button class="chip" id="addEssential" type="button">+ Add expense</button>
      </h2>
      <div id="essentialsList" class="list"></div>
      <div class="totals">
        <div class="badge">Monthly essentials: <span id="essentialsTotal" class="mono">$0.00</span></div>
      </div>
    </div>

    <div class="section" id="debtsSec">
      <h2>
        Debts
        <button class="chip" id="addDebt" type="button">+ Add debt</button>
      </h2>
      <div id="debtsList" class="list"></div>
      <div class="totals">
        <div class="badge">Total balance: <span id="totBal" class="mono">$0.00</span></div>
        <div class="badge">Total minimums: <span id="totMin" class="mono">$0.00</span></div>
      </div>
    </div>

    <div class="section" id="goalsSec">
      <h2>
        Goal
        <button class="chip" id="addGoal" type="button">+ Add goal</button>
      </h2>
      <div id="goalsList" class="list"></div>
      <div class="totals">
        <div class="badge">Monthly required saving: <span id="reqSaveBadge" class="mono">$0.00</span></div>
        <div class="badge">Months to goal: <span id="monthsBadge" class="mono">—</span></div>
      </div>
    </div>

    <div class="section summary">
      <h2>Plan summary</h2>
      <div class="grid-2">
        <div class="kpi">
          <h3>Cash flow</h3>
          <p class="muted">Based on income − essentials − minimum debt − required saving</p>
          <p class="line">
            <span>Free cash each month</span>
            <span id="extraPool" class="mono right">$0.00</span>
          </p>
          <p class="line">
            <span>Debt‑to‑income (DTI)</span>
            <span id="dti" class="mono right">—</span>
          </p>
        </div>
        <div class="kpi">
          <h3>Recommendations</h3>
          <p class="line"><span>Strategy</span>
            <select id="strategy">
              <option value="avalanche">Avalanche (highest APR first)</option>
              <option value="snowball">Snowball (smallest balance first)</option>
            </select>
          </p>
          <p class="line"><span>Target debt this month</span> <span id="targetDebt" class="mono right">—</span></p>
          <p class="line"><span>Projected debt‑free date</span> <span id="projDone" class="mono right">—</span></p>
        </div>
      </div>
      <div id="flags" style="margin-top:10px;"></div>

      <div class="kpi" style="margin-top:10px;">
        <h3>Goal progress</h3>
        <p class="muted">Updates as you enter “Saved so far” and a target date.</p>
        <p class="line"><span>Required monthly saving</span> <span id="reqSave" class="mono right">$0.00</span></p>
        <p class="line"><span>Months to goal</span> <span id="monthsToGoal" class="mono right">—</span></p>
      </div>
    </div>

    <div class="section">
      <h2>Tip jar</h2>
      <p class="muted">If you find this tool helpful, consider a tip. On Google Play, tips use Play Billing. On the web, use the links below.</p>
      <div id="playTips" class="tip-row hide">
        <button class="chip" data-tip="tip_small">$1</button>
        <button class="chip" data-tip="tip_medium">$3</button>
        <button class="chip" data-tip="tip_large">$5</button>
        <span id="tipState" class="muted"></span>
      </div>
      <div id="webTips" class="tip-row">
        <a class="chip" id="tipCashApp" href="#" target="_blank" rel="noopener">Cash App</a>
        <a class="chip" id="tipPayPal" href="#" target="_blank" rel="noopener">PayPal</a>
        <a class="chip" id="tipVenmo" href="#" target="_blank" rel="noopener">Venmo</a>
      </div>
    </div>
  </div>

  <script>
    // ——— Currency: Force US dollars with "$" ———
    const CURRENCY = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', currencyDisplay: 'symbol' });
    const fmtMoney = v => CURRENCY.format(Number(v||0));

    // ——— Helpers ———
    const $ = id => document.getElementById(id);
    const todayISO = () => new Date().toISOString().slice(0,10);
    const monthsBetween = (a, b) => {
      const d1 = new Date(a), d2 = new Date(b);
      const years = d2.getFullYear() - d1.getFullYear();
      const months = d2.getMonth() - d1.getMonth();
      const total = years*12 + months + (d2.getDate() >= d1.getDate() ? 0 : -1);
      return Math.max(1, total); // avoid zero/negative
    };

    // ——— State ———
    const empty = () => ({
      displayName: '',
      cadence: 26,
      strategy: 'avalanche',
      incomes: [],     // [{name, amountMonthly}]
      essentials: [],  // [{name, amountMonthly}]
      debts: [],       // [{name, balance, apr, min, term}]
      goals: []        // [{name, goalAmt, goalDate, goalNow}]
    });
    let state = empty();

    function load() {
      try {
        const raw = localStorage.getItem('h3-budget');
        if (raw) state = { ...empty(), ...JSON.parse(raw) };
      } catch {}
      renderAll();
    }
    function save() {
      localStorage.setItem('h3-budget', JSON.stringify(state));
    }

    // ——— Theme toggle ———
    (function initTheme(){
      const saved = localStorage.getItem('h3-theme') || 'dark';
      document.documentElement.dataset.theme = saved;
      $('themeToggle').onclick = () => {
        const cur = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
        document.documentElement.dataset.theme = cur;
        localStorage.setItem('h3-theme', cur);
      };
    })();

    // ——— Orientation hint (best-effort; true lock requires installed context) ———
    (async function lockPortrait(){
      try { if (screen.orientation && screen.orientation.lock) await screen.orientation.lock('portrait'); } catch {}
    })();

    // ——— UI Builders ———
    function addIncomeRow(item = {name:'', amountMonthly:0}) {
      state.incomes.push(item); save(); renderIncomes();
    }
    function addEssentialRow(item = {name:'', amountMonthly:0}) {
      state.essentials.push(item); save(); renderEssentials();
    }
    function addDebtRow(item = {name:'', balance:0, apr:0, min:0, term:0}) {
      state.debts.push(item); save(); renderDebts();
    }
    function addGoalRow(item = {name:'', goalAmt:0, goalDate:todayISO(), goalNow:0}) {
      state.goals.push(item); save(); renderGoals();
    }

    function bindNumber(el, obj, key) {
      el.addEventListener('input', () => { obj[key] = parseFloat(el.value) || 0; compute(); save(); });
    }
    function bindText(el, obj, key) {
      el.addEventListener('input', () => { obj[key] = el.value; compute(); save(); });
    }
    function removeAt(list, i, after) {
      list.splice(i,1); save(); after(); compute();
    }

    // Income
    function renderIncomes() {
      const host = $('incomeList'); host.innerHTML = '';
      state.incomes.forEach((it, i) => {
        const div = document.createElement('div'); div.className = 'card';
        div.innerHTML = `
          <div class="row">
            <label>Source <input value="${it.name||''}" placeholder="e.g., Salary"/></label>
            <label>Monthly amount <input type="number" step="0.01" value="${it.amountMonthly||0}" /></label>
          </div>
          <div class="right"><button class="minor" type="button" data-del>Remove</button></div>`;
        const [src, amt] = div.querySelectorAll('input');
        bindText(src, it, 'name'); bindNumber(amt, it, 'amountMonthly');
        div.querySelector('[data-del]').onclick = () => removeAt(state.incomes, i, renderIncomes);
        host.appendChild(div);
      });
      $('incomeTotal').textContent = fmtMoney(totalIncome());
      compute();
    }

    // Essentials
    function renderEssentials() {
      const host = $('essentialsList'); host.innerHTML = '';
      state.essentials.forEach((it, i) => {
        const div = document.createElement('div'); div.className = 'card';
        div.innerHTML = `
          <div class="row">
            <label>Expense <input value="${it.name||''}" placeholder="e.g., Rent"/></label>
            <label>Monthly amount <input type="number" step="0.01" value="${it.amountMonthly||0}" /></label>
          </div>
          <div class="right"><button class="minor" type="button" data-del>Remove</button></div>`;
        const [name, amt] = div.querySelectorAll('input');
        bindText(name, it, 'name'); bindNumber(amt, it, 'amountMonthly');
        div.querySelector('[data-del]').onclick = () => removeAt(state.essentials, i, renderEssentials);
        host.appendChild(div);
      });
      $('essentialsTotal').textContent = fmtMoney(totalEssentials());
      compute();
    }

    // Debts
    function renderDebts() {
      const host = $('debtsList'); host.innerHTML = '';
      state.debts.forEach((d, i) => {
        const div = document.createElement('div'); div.className = 'card';
        div.innerHTML = `
          <div class="row-5">
            <label>Debt name <input value="${d.name||''}" placeholder="e.g., Visa"/></label>
            <label>Balance <input type="number" step="0.01" value="${d.balance||0}" /></label>
            <label>APR % <input type="number" step="0.01" value="${d.apr||0}" /></label>
            <label>Min (optional) <input type="number" step="0.01" value="${d.min||0}" /></label>
            <label>Term months (opt) <input type="number" step="1" value="${d.term||0}" /></label>
          </div>
          <div class="right"><button class="minor" type="button" data-del>Remove</button></div>`;
        const ins = div.querySelectorAll('input');
        bindText(ins[0], d, 'name');
        bindNumber(ins[1], d, 'balance');
        bindNumber(ins[2], d, 'apr');
        bindNumber(ins[3], d, 'min');
        bindNumber(ins[4], d, 'term');
        div.querySelector('[data-del]').onclick = () => removeAt(state.debts, i, renderDebts);
        host.appendChild(div);
      });
      compute();
    }

    // Goals (single primary goal supported, but UI allows multiple; we compute off the first one)
    function renderGoals() {
      const host = $('goalsList'); host.innerHTML = '';
      state.goals.forEach((g, i) => {
        const div = document.createElement('div'); div.className = 'card';
        div.innerHTML = `
          <div class="row-4">
            <label>Goal name <input value="${g.name||''}" placeholder="e.g., Emergency fund"/></label>
            <label>Target amount <input type="number" step="0.01" value="${g.goalAmt||0}" /></label>
            <label>Target date <input type="date" value="${g.goalDate||todayISO()}" /></label>
            <label>Saved so far <input type="number" step="0.01" value="${g.goalNow||0}" /></label>
          </div>
          <div class="right"><button class="minor" type="button" data-del>Remove</button></div>`;
        const [name, amt, date, now] = div.querySelectorAll('input');
        bindText(name, g, 'name');
        bindNumber(amt, g, 'goalAmt');
        date.addEventListener('change', () => { g.goalDate = date.value; compute(); save(); });
        bindNumber(now, g, 'goalNow');
        div.querySelector('[data-del]').onclick = () => removeAt(state.goals, i, renderGoals);
        host.appendChild(div);
      });
      compute();
    }

    // Totals
    const totalIncome = () => state.incomes.reduce((s, x) => s + (x.amountMonthly||0), 0);
    const totalEssentials = () => state.essentials.reduce((s, x) => s + (x.amountMonthly||0), 0);

    // ——— Math & Planning ———
    function compute() {
      // Profile
      $('displayName').value = state.displayName || '';
      $('cadence').value = String(state.cadence || 26);
      $('strategy').value = state.strategy || 'avalanche';

      // Goal math
      const g = state.goals[0] || {};
      const months = g.goalDate ? monthsBetween(new Date(), g.goalDate) : '';
      $('monthsToGoal').textContent = months || '—';
      $('monthsBadge').textContent = months || '—';

      const reqSave = (g.goalAmt > 0 && months) ? Math.max(0, ((g.goalAmt||0) - (g.goalNow||0)) / months) : 0;
      $('reqSave').textContent = fmtMoney(reqSave);
      $('reqSaveBadge').textContent = fmtMoney(reqSave);

      // Debts normalization
      let totBal = 0, totMin = 0;
      const normalized = state.debts
        .filter(d => (d.balance||0) > 0)
        .map(d => {
          const r = (d.apr||0) / 100 / 12;
          const amortMin = (d.term>0 && r>0) ? ((d.balance*r) / (1 - Math.pow(1+r, -d.term))) : 0;
          const floorMin = Math.min(d.balance||0, 25);
          const min = d.min>0 ? d.min : (amortMin>0 ? amortMin : floorMin);
          totBal += (d.balance||0);
          totMin += min;
          return { ...d, r, min };
        });
      $('totBal').textContent = fmtMoney(totBal);
      $('totMin').textContent = fmtMoney(totMin);

      const inc = totalIncome();
      const fixed = totalEssentials();
      const extraPool = (inc - fixed - totMin - reqSave);
      $('extraPool').textContent = fmtMoney(extraPool);

      // DTI (based on minimums vs income)
      const dti = inc > 0 ? (totMin / inc) : 0;
      $('dti').textContent = inc>0 ? (dti*100).toFixed(1)+'%' : '—';

      // Target debt (avalanche/snowball)
      let target = '—';
      if (normalized.length) {
        const sorted = normalized.slice().sort((a,b) =>
          (state.strategy === 'avalanche') ? (b.apr - a.apr) : ((a.balance||0) - (b.balance||0))
        );
        target = sorted[0]?.name || '—';
      }
      $('targetDebt').textContent = target;

      // Flags
      const flags = [];
      if (extraPool < 0) flags.push('⚠️ Negative cash flow — raise income, reduce essentials, delay goal, or adjust debt terms.');
      if ((g.goalAmt||0) > 0 && !g.goalDate) flags.push('ℹ️ Set a goal date to compute required monthly saving.');
      if (normalized.some(d => d.min < (d.balance||0) * d.r)) flags.push('⚠️ A minimum payment is below monthly interest (negative amortization).');
      $('flags').innerHTML = flags.length
        ? `<div class="${extraPool<0?'danger':'warn'}">${flags.join('<br>')}</div>`
        : `<div class="ok">✅ Plan is feasible based on current inputs.</div>`;

      // Projection
      $('projDone').textContent = projection(normalized, Math.max(0, extraPool), state.strategy);

      save();
    }

    function projection(debts, extra, strategy) {
      debts = debts.map(d => ({...d, bal: d.balance, alive: d.balance>0}));
      let month = 0, guard = 0;
      while (debts.some(d=>d.alive) && guard < 1200) {
        // Accrue + pay minimums
        debts.forEach(d => {
          if (!d.alive) return;
          const interest = d.bal * d.r;
          const due = d.bal + interest;
          const pay = Math.min(d.min, due);
          d.bal = due - pay;
          if (d.bal <= 0.01) { d.bal = 0; d.alive = false; }
        });
        // Direct extra to target
        const alive = debts.filter(d=>d.alive);
        if (!alive.length) break;
        alive.sort((a,b) => strategy==='avalanche' ? (b.apr - a.apr) : (a.bal - b.bal));
        let t = alive[0];
        if (extra > 0 && t.alive) {
          t.bal = Math.max(0, t.bal - extra);
          if (t.bal <= 0.01) { t.bal = 0; t.alive = false; }
        }
        month++; guard++;
      }
      if (guard >= 1200) return '—';
      const done = new Date(); done.setMonth(done.getMonth()+month);
      return done.toLocaleDateString();
    }

    // ——— Bind static controls ———
    $('displayName').addEventListener('input', e => { state.displayName = e.target.value; save(); });
    $('cadence').addEventListener('change', e => { state.cadence = parseInt(e.target.value,10); save(); compute(); });
    $('strategy').addEventListener('change', e => { state.strategy = e.target.value; save(); compute(); });

    // ——— Add buttons ———
    $('addIncome').onclick = () => addIncomeRow();
    $('addEssential').onclick = () => addEssentialRow();
    $('addDebt').onclick = () => addDebtRow();
    $('addGoal').onclick = () => addGoalRow({name:'', goalAmt:0, goalDate:todayISO(), goalNow:0});

    // ——— Initial lists ———
    function renderAll() {
      $('displayName').value = state.displayName || '';
      $('cadence').value = String(state.cadence || 26);
      $('strategy').value = state.strategy || 'avalanche';
      renderIncomes();
      renderEssentials();
      renderDebts();
      renderGoals();
      compute();
    }

    // ——— Tip Jar (Digital Goods API on Play; external links on web) ———
    // Set your links here for the web experience:
    const LINKS = {
      cashapp: 'https://cash.app/$YOUR_HANDLE',
      paypal: 'https://paypal.me/YOUR_HANDLE',
      venmo: 'https://venmo.com/u/YOUR_HANDLE'
    };
    (function initLinks(){
      const ca = $('tipCashApp'); const pp = $('tipPayPal'); const ve = $('tipVenmo');
      if (ca) ca.href = LINKS.cashapp;
      if (pp) pp.href = LINKS.paypal;
      if (ve) ve.href = LINKS.venmo;
    })();

    const PLAY_ORIGIN = 'https://play.google.com/billing';
    async function setupTips(){
      const hint = $('tipState');
      if (!('getDigitalGoodsService' in window)) {
        // Web context — keep external links shown
        $('playTips').classList.add('hide');
        $('webTips').classList.remove('hide');
        return;
      }
      try {
        const dgs = await getDigitalGoodsService(PLAY_ORIGIN);
        const items = await dgs.listPurchasableItems(['tip_small','tip_medium','tip_large']);
        $('webTips').classList.add('hide');
        $('playTips').classList.remove('hide');
        hint.textContent = (items && items.length) ? 'Tip products loaded.' : 'Tip products unavailable.';
        async function buy(id){
          try{
            const details = await dgs.getDetails([id]);
            if (!details || !details.length) return alert('Product not available.');
            const p = await dgs.launchBillingFlow({ itemId: id });
            if (p && p.purchaseToken){
              await dgs.acknowledge({ purchaseToken: p.purchaseToken });
              alert('Thanks for the tip! 🙏');
            }
          }catch{ alert('Purchase cancelled or failed.'); }
        }
        document.querySelectorAll('[data-tip]').forEach(b => b.onclick = () => buy(b.dataset.tip));
      } catch {
        hint.textContent = 'Play Billing not available.';
        $('playTips').classList.add('hide');
        $('webTips').classList.remove('hide');
      }
    }

    // ——— Boot ———
    load();
    setupTips();
  </script>
</body>
</html>
