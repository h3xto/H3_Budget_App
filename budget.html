<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>H¬≥ Budget Tool</title>
<link rel="manifest" href="/H3_Budget_App/manifest.webmanifest?v=3">
<link rel="icon" href="/H3_Budget_App/icons/icon-192-v3.png" sizes="192x192">
<link rel="apple-touch-icon" href="/H3_Budget_App/icons/icon-192-v3.png">
<style>
  :root{
    --bg:#0b0f14;--panel:#0f1520;--ink:#e6edf3;--muted:#9bb0c3;--accent:#0aa0a8;
    --ok:#1f7a42;--warn:#cf8a08;--bad:#c94141;--line:#1c2837;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  main{max-width:880px;margin:0 auto;padding:16px}
  .chip{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:#0e1a27;color:#bcd1e5;font-size:13px}
  header{display:flex;gap:12px;align-items:center;margin:6px 0 14px}
  header img{width:28px;height:28px;border-radius:8px}
  h1{font-size:22px;margin:0}
  .row{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:12px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
  .card h3{margin:0 0 10px}
  .hint{color:var(--muted);font-size:13px}
  label{display:block;font-size:13px;color:#c6d6e6;margin:6px 0 6px}
  input,select,button,textarea{
    width:100%;padding:11px 12px;border-radius:10px;border:1px solid var(--line);
    background:#0d1420;color:var(--ink);font:16px/1.3 system-ui;-webkit-appearance:none;appearance:none;
  }
  input::placeholder{color:#7e93a9}
  button{cursor:pointer;background:#0d2830;border-color:#143c47}
  button.primary{background:var(--accent);border-color:#159199;color:#001a1d;font-weight:600}
  .grid{display:grid;gap:10px}
  .grid.cols-4{grid-template-columns:minmax(0,1.4fr) minmax(0,1fr) minmax(0,1fr) minmax(0,0.9fr)}
  .grid.cols-3{grid-template-columns:minmax(0,1.2fr) minmax(0,1fr) minmax(0,1fr)}
  .inline-actions{display:flex;gap:10px;align-items:center}
  .trash{width:40px;aspect-ratio:1;border-radius:10px;display:inline-grid;place-items:center}
  .trash::before{content:"üóëÔ∏è"}
  .total{font-weight:700;text-align:right}
  .kpi{padding:12px;border-radius:12px;background:#0d1420;border:1px solid var(--line)}
  .bar{height:12px;background:#0e1825;border-radius:999px;overflow:hidden}
  .bar>span{display:block;height:100%;background:#1a7fb2}
  details{background:#0d1420;border:1px solid var(--line);border-radius:12px}
  details>summary{cursor:pointer;padding:12px 14px;font-weight:600;list-style:none}
  details>div{padding:0 14px 14px}
  .footer-actions{display:flex;gap:10px;justify-content:center;margin:24px 0 40px}
  .pill{border-radius:999px}
  /* responsive */
  @media (max-width:680px){
    .grid.cols-4{grid-template-columns:minmax(0,1.2fr) minmax(0,1fr) minmax(0,1fr) 56px}
  }
</style>
</head>
<body>
<main>
  <header>
    <img src="/H3_Budget_App/icons/icon-192-v3.png" alt="H¬≥ logo">
    <div>
      <h1>H¬≥ Budget Tool</h1>
      <div class="chip">Private ‚Ä¢ Goal-Focused ‚Ä¢ Offline</div>
    </div>
  </header>

  <!-- Profile -->
  <div class="row">
    <div class="card">
      <label>Display Name</label>
      <input id="name" placeholder="Your name">
    </div>
    <div class="card">
      <label>Payment cadence</label>
      <select id="cadence">
        <option value="monthly">Monthly</option>
        <option value="twice-monthly">Twice-Monthly (24/yr)</option>
        <option value="biweekly" selected>Bi-Weekly (26/yr)</option>
        <option value="weekly">Weekly (52/yr)</option>
      </select>
    </div>
  </div>

  <!-- Income -->
  <section class="card" id="sec-income">
    <h3>Income</h3>
    <p class="hint">Add each paycheck or income source (net / take-home).</p>
    <div class="grid cols-4" id="income-list"></div>
    <div class="inline-actions" style="margin-top:8px">
      <button class="primary pill" id="add-income">+ Add Income Source</button>
      <div class="total" style="flex:1">Monthly Income Total: <span id="income-total">$0.00</span></div>
    </div>
  </section>

  <!-- Essentials -->
  <section class="card" id="sec-essentials">
    <h3>Essentials</h3>
    <p class="hint">Add recurring monthly essentials (rent, utilities, insurance, etc.).</p>
    <div class="grid cols-3" id="essentials-list"></div>
    <div class="inline-actions" style="margin-top:8px">
      <button class="primary pill" id="add-essential">+ Add Expense</button>
      <div class="total" style="flex:1">Monthly Essentials Total: <span id="essentials-total">$0.00</span></div>
    </div>
  </section>

  <!-- Debts -->
  <section class="card" id="sec-debts">
    <h3>Debts</h3>
    <p class="hint">Add debts to get an <b>‚ÄúAvalanche‚Äù</b> recommendation (highest APR first). If a debt has a term, we‚Äôll estimate its minimum payment; if not, we assume 2% minimum.</p>
    <div class="grid cols-4" id="debts-list"></div>
    <div class="inline-actions" style="margin-top:8px">
      <button class="primary pill" id="add-debt">+ Add Debt</button>
    </div>
  </section>

  <!-- Goal -->
  <section class="card" id="sec-goal">
    <h3>Goal</h3>
    <div class="grid cols-3">
      <div>
        <label>Goal name</label>
        <input id="goal-name" placeholder="e.g., Emergency fund">
      </div>
      <div>
        <label>Amount</label>
        <input id="goal-amount" data-money placeholder="$0.00">
      </div>
      <div>
        <label>Target date</label>
        <input id="goal-date" type="date">
      </div>
    </div>
    <p class="hint" style="margin-top:8px">Tip: you can still use Avalanche for debts while saving toward a goal ‚Äî we‚Äôll show the free cash after essentials so you can split between them.</p>
  </section>

  <!-- Summary -->
  <section class="card">
    <h3>Plan Summary</h3>
    <div class="kpi" id="summary-line">Your plan.</div>

    <div class="card" style="margin:12px 0">
      <h3>DEBT-TO-INCOME (DTI) <span style="float:right" id="dti-pct">0%</span></h3>
      <div class="bar"><span id="dti-bar" style="width:0%"></span></div>
    </div>

    <div class="card" style="margin:12px 0">
      <h3>GOAL PROGRESS <span style="float:right" id="goal-pct">0%</span></h3>
      <div class="bar"><span id="goal-bar" style="width:0%"></span></div>
      <div class="hint" id="goal-line">$0.00 of $0.00 (0%)</div>
    </div>

    <div class="card" id="avalanche-card" style="margin:12px 0">
      <h3>Debt Recommendation (Avalanche)</h3>
      <div id="avalanche-main" class="kpi">Add a debt to see the recommendation.</div>
      <details id="why-avalanche" style="margin-top:10px">
        <summary>Why this recommendation?</summary>
        <div id="avalanche-why"></div>
      </details>
    </div>
  </section>

  <!-- Tip Jar -->
  <section class="card">
    <h3>Tip Jar (optional)</h3>
    <p class="hint">Support development via Google Play (one-time purchases). These are handled by Play Billing and respect refund policies.</p>
    <div class="row">
      <button class="primary pill" data-tip="tip_small">$1 ‚Ä¢ Small Tip</button>
      <button class="primary pill" data-tip="tip_medium">$3 ‚Ä¢ Medium Tip</button>
      <button class="primary pill" data-tip="tip_large">$5 ‚Ä¢ Large Tip</button>
    </div>
    <div class="hint" id="tip-status" style="margin-top:8px"></div>
  </section>

  <div class="footer-actions">
    <button id="save">Save</button>
    <button id="share">Share</button>
    <button id="export">Export JSON</button>
  </div>
</main>

<script>
/* ========= helpers ========= */
const $ = sel => document.querySelector(sel);
const fmt = n => (isFinite(n)? n:0).toLocaleString(undefined,{style:"currency",currency:"USD"});
const unmoney = s => +String(s||"").replace(/[^\d.-]/g,"") || 0;

/* money mask: focus = raw, blur = $1,234.56 */
function attachMoneyMask(input){
  input.addEventListener('focus', ()=>{ input.value = String(unmoney(input.value)||""); });
  input.addEventListener('blur', ()=>{ input.value = fmt(unmoney(input.value)); });
  // format initial if any
  if(input.value) input.value = fmt(unmoney(input.value));
}

/* frequency -> monthly */
function monthlyFrom(freq, perPay){
  switch(freq){
    case 'weekly': return perPay*52/12;
    case 'biweekly': return perPay*26/12;
    case 'twice-monthly': return perPay*2;
    case 'yearly': return perPay/12;
    default: return perPay; // monthly
  }
}

/* cadence -> per-pay from monthly */
function perPayFromMonthly(cadence, monthly){
  switch(cadence){
    case 'weekly': return monthly*12/52;
    case 'biweekly': return monthly*12/26;           // <-- fixed (was √∑2)
    case 'twice-monthly': return monthly/2;
    default: return monthly; // monthly
  }
}

/* debt minimum: term>0 exact amortization; else 2% of balance */
function minPayment(aprPct, bal, term){
  const apr = (aprPct||0)/100;
  if(term && term>0){
    const r = apr/12;
    if(r===0) return bal/term;
    return (r*bal)/(1-Math.pow(1+r, -term));
  }
  return bal*0.02;
}

/* ========= state ========= */
let model = {
  name:"", cadence:"biweekly",
  income:[],
  essentials:[],
  debts:[],
  goal:{ name:"", amount:0, date:"" }
};

/* ========= UI builders ========= */
const freqs = [
  ['weekly','Weekly (52/yr)'],
  ['biweekly','Bi-Weekly (26/yr)'],
  ['twice-monthly','Twice-Monthly (24/yr)'],
  ['monthly','Monthly'],
  ['yearly','Yearly']
];

function addIncomeRow(item={name:"",freq:"biweekly",perPay:0}){
  model.income.push(item);
  render();
}
function addEssentialRow(item={name:"",monthly:0}){
  model.essentials.push(item);
  render();
}
function addDebtRow(item={name:"",apr:0,term:0,balance:0}){
  model.debts.push(item);
  render();
}

function render(){
  // bind basics
  $('#name').value = model.name||"";
  $('#cadence').value = model.cadence||"biweekly";
  $('#goal-name').value = model.goal?.name||"";
  $('#goal-amount').value = fmt(model.goal?.amount||0);
  $('#goal-date').value = model.goal?.date||"";

  // income rows
  const il = $('#income-list'); il.innerHTML = "";
  model.income.forEach((it,idx)=>{
    const row = document.createElement('div'); row.className='grid cols-4';
    row.innerHTML = `
      <div><label>Name</label><input value="${it.name||""}" data-k="name"></div>
      <div><label>Frequency</label>
        <select data-k="freq">
          ${freqs.map(([v,t])=>`<option value="${v}" ${it.freq===v?'selected':''}>${t}</option>`).join('')}
        </select>
      </div>
      <div><label>Per pay</label><input data-money value="${fmt(it.perPay||0)}" data-k="perPay"></div>
      <div><label>Monthly</label><input disabled value="${fmt(monthlyFrom(it.freq, +it.perPay||0))}"></div>
      <div style="grid-column:1/-1;display:flex;justify-content:flex-end">
        <button class="trash" data-del="income:${idx}" title="Delete"></button>
      </div>`;
    il.appendChild(row);
    // bind
    row.querySelectorAll('input,select').forEach(inp=>{
      if(inp.dataset.money!=null) attachMoneyMask(inp);
      inp.oninput = ()=>{
        const k = inp.dataset.k;
        model.income[idx][k] = (k==='perPay') ? unmoney(inp.value) : inp.value;
        render();
      };
    });
  });

  // essentials rows
  const el = $('#essentials-list'); el.innerHTML = "";
  model.essentials.forEach((it,idx)=>{
    const row = document.createElement('div'); row.className='grid cols-3';
    row.innerHTML = `
      <div><label>Name</label><input value="${it.name||""}" data-k="name"></div>
      <div><label>Monthly</label><input data-money value="${fmt(it.monthly||0)}" data-k="monthly"></div>
      <div style="align-self:end"><button class="trash" data-del="ess:${idx}" title="Delete"></button></div>`;
    el.appendChild(row);
    row.querySelectorAll('input').forEach(inp=>{
      if(inp.dataset.money!=null) attachMoneyMask(inp);
      inp.oninput = ()=>{
        const k = inp.dataset.k;
        model.essentials[idx][k] = (k==='monthly') ? unmoney(inp.value) : inp.value;
        render();
      };
    });
  });

  // debts rows
  const dl = $('#debts-list'); dl.innerHTML = "";
  model.debts.forEach((it,idx)=>{
    const row = document.createElement('div'); row.className='grid cols-4';
    row.innerHTML = `
      <div><label>Name</label><input value="${it.name||""}" data-k="name"></div>
      <div><label>APR %</label><input value="${it.apr||0}" data-k="apr" inputmode="decimal"></div>
      <div><label>Balance</label><input data-money value="${fmt(it.balance||0)}" data-k="balance"></div>
      <div><label>Term (months)</label><input value="${it.term||0}" data-k="term" inputmode="numeric"></div>
      <div style="grid-column:1/-1;display:flex;justify-content:flex-end">
        <button class="trash" data-del="debt:${idx}" title="Delete"></button>
      </div>`;
    dl.appendChild(row);
    row.querySelectorAll('input').forEach(inp=>{
      if(inp.dataset.money!=null) attachMoneyMask(inp);
      inp.oninput = ()=>{
        const k = inp.dataset.k;
        let v = inp.value;
        if(k==='balance') v = unmoney(v);
        if(k==='apr'||k==='term') v = +v || 0;
        model.debts[idx][k] = (k==='name')? v : +v;
        render();
      };
    });
  });

  // totals & summary
  const incMonthly = model.income.reduce((s,i)=>s+monthlyFrom(i.freq, +i.perPay||0),0);
  const essMonthly = model.essentials.reduce((s,e)=>s+(+e.monthly||0),0);
  const free = incMonthly - essMonthly;
  $('#income-total').textContent = fmt(incMonthly);
  $('#essentials-total').textContent = fmt(essMonthly);
  $('#summary-line').textContent = `${model.name||"Your"}'s Plan: ${fmt(incMonthly)} income ‚Äì ${fmt(essMonthly)} essentials = ${fmt(free)} free cash.`;

  // DTI (essentials + min debt) / income
  const mins = model.debts.map(d=>minPayment(+d.apr||0, +d.balance||0, +d.term||0));
  const minsTotal = mins.reduce((a,b)=>a+b,0);
  const dti = incMonthly>0 ? ((essMonthly+minsTotal)/incMonthly) : 0;
  $('#dti-pct').textContent = Math.round(dti*100) + "%";
  $('#dti-bar').style.width = Math.min(100, Math.round(dti*100)) + "%";

  // goal progress (assume ‚Äú0 saved‚Äù in-app for now)
  const gAmt = +model.goal.amount||0;
  $('#goal-pct').textContent = (gAmt>0)? "0%" : "0%";
  $('#goal-bar').style.width = "0%";
  $('#goal-line').textContent = `${fmt(0)} of ${fmt(gAmt)} (0%)`;

  // Avalanche
  const debts = model.debts
    .map((d,i)=>({i,name:d.name||`Debt ${i+1}`,apr:+d.apr||0,balance:+d.balance||0,term:+d.term||0,min:mins[i]}))
    .filter(d=>d.balance>0 && d.apr>=0)
    .sort((a,b)=>b.apr-a.apr);

  const cadence = $('#cadence').value;
  const perPay = perPayFromMonthly(cadence, free);

  if(debts.length){
    const top = debts[0];
    $('#avalanche-main').innerHTML =
      `Free cash after essentials: <b>${fmt(free)}</b> per month. `+
      `Estimated minimums: <b>${fmt(minsTotal)}</b> per month. `+
      `Cadence: <b>${{
        'weekly':'Weekly',
        'biweekly':'Bi-Weekly',
        'twice-monthly':'Twice-Monthly',
        'monthly':'Monthly'
      }[cadence]}</b>.<br><br>`+
      `Pay <b>${fmt(free)}</b> / mo (‚âà <b>${fmt(perPay)}</b> per pay) toward <b>${top.name}</b> first (avalanche).`;

    $('#avalanche-why').innerHTML =
      `<p><b>Why ${top.name}?</b> With Avalanche we direct extra payments to the <b>highest APR</b> first: ${top.apr.toFixed(2)}% APR, balance ${fmt(top.balance)}.</p>
       <ul>
         <li>Keep paying <b>minimums</b> on every debt. Estimated minimum total: ${fmt(minsTotal)} / mo.</li>
         <li>Send your extra <b>${fmt(free)}</b> / mo to <b>${top.name}</b> until it‚Äôs paid off.</li>
         <li>Then roll that same amount to the next-highest APR (snowball effect on interest).</li>
       </ul>
       <p class="hint">Per-pay math: cadence ‚Äú${cadence}‚Äù converts monthly ‚Üí pay = monthly √ó ${cadence==='weekly'?'12/52':cadence==='biweekly'?'12/26':cadence==='twice-monthly'?'1/2':'1'}.</p>`;
    $('#why-avalanche').open = false;
  }else{
    $('#avalanche-main').textContent = 'Add a debt to see the recommendation.';
    $('#avalanche-why').innerHTML = '';
  }
}

/* ========= events ========= */
$('#name').oninput = e=>{ model.name = e.target.value; render(); };
$('#cadence').onchange = e=>{ model.cadence = e.target.value; render(); };
$('#goal-name').oninput = e=>{ model.goal.name = e.target.value; render(); };
attachMoneyMask($('#goal-amount'));
$('#goal-amount').addEventListener('input', e=>{ model.goal.amount = unmoney(e.target.value); });
$('#goal-date').onchange = e=>{ model.goal.date = e.target.value; render(); };

$('#add-income').onclick = ()=>addIncomeRow();
$('#add-essential').onclick = ()=>addEssentialRow();
$('#add-debt').onclick = ()=>addDebtRow();

document.body.addEventListener('click', e=>{
  const del = e.target.closest('[data-del]');
  if(del){
    const [kind,idx] = del.dataset.del.split(':');
    if(kind==='income') model.income.splice(+idx,1);
    if(kind==='ess') model.essentials.splice(+idx,1);
    if(kind==='debt') model.debts.splice(+idx,1);
    render();
  }
});

/* ========= persistence / share ========= */
const KEY='h3x-plan';
function save(){ localStorage.setItem(KEY, JSON.stringify(model)); }
function load(){
  try{ const j = JSON.parse(localStorage.getItem(KEY)||'{}'); if(j && typeof j==='object') model = Object.assign(model,j); }catch{}
}
function shareLink(){
  const url = new URL(location.href);
  url.hash = btoa(unescape(encodeURIComponent(JSON.stringify(model))));
  navigator.clipboard.writeText(url.toString());
  alert('Share link copied to clipboard!');
}
function exportJSON(){
  const blob = new Blob([JSON.stringify(model,null,2)], {type:'application/json'});
  const a = Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob),download:'h3-plan.json'});
  a.click(); URL.revokeObjectURL(a.href);
}
$('#save').onclick = ()=>{ save(); alert('Saved locally.'); };
$('#share').onclick = shareLink;
$('#export').onclick = exportJSON;

/* ========= Tip Jar (Digital Goods API) ========= */
(async function setupTips(){
  const status = $('#tip-status');
  try{
    // Is Play Billing available?
    const svc = await navigator?.digitalGoods?.getDigitalGoodsService?.('https://play.google.com/billing');
    if(!svc) throw new Error('Digital Goods service not available.');
    // Optionally query products
    // const details = await svc.getDetails(['tip_small','tip_medium','tip_large']);
    document.querySelectorAll('[data-tip]').forEach(btn=>{
      btn.disabled = false;
      btn.onclick = async ()=>{
        try{
          const productId = btn.dataset.tip;
          const {purchaseToken} = await svc.launchPurchaseFlow({itemId:productId});
          status.textContent = 'Thanks! Purchase complete.';
          // No server: we don‚Äôt verify here. Play handles refunds/ownership.
        }catch(err){ status.textContent = 'Purchase canceled or failed.'; }
      };
    });
    status.textContent = 'Tips handled by Google Play Billing.';
  }catch(err){
    document.querySelectorAll('[data-tip]').forEach(b=>{ b.disabled = true; });
    status.textContent = 'Tips unavailable on this device.';
  }
})();

/* ========= boot ========= */
load();
// Seed one row for convenience if nothing present
if(!model.income.length) addIncomeRow({name:"",freq:"biweekly",perPay:0}); else render();
if(!model.essentials.length) addEssentialRow({name:"",monthly:0});
if(!model.debts.length) addDebtRow({name:"",apr:0,balance:0,term:0});
render();
</script>
</body>
</html>
