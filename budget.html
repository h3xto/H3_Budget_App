<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>H³ Budget Tool</title>

  <!-- PWA / icons -->
  <meta name="theme-color" content="#0f9a9b" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <!-- IMPORTANT: absolute paths + version bump to force refresh -->
  <link rel="manifest" href="/H3_Budget_App/manifest.webmanifest?v=24">
  <link rel="icon" type="image/png" sizes="192x192" href="/H3_Budget_App/icons/icon-192-v3.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/H3_Budget_App/icons/icon-512-v3.png">
  <link rel="apple-touch-icon" href="/H3_Budget_App/icons/icon-192-v3.png">

  <style>
    :root{
      --brand:#0f9a9b; --brand-2:#16b5b7;
      --ink:#0a1b1c; --muted:#5c7a7b;
      --bg:#f6fbfb; --card:#ffffff; --line:#d4ebeb;
      --focus:#0f9a9b;
      --btn:#e8f3f3; --btn-line:#cfe6e6; --btn-ink:#174344;
      --chip-bg:#e9f6f6; --chip-line:#cdecec;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .container{max-width:720px;margin:0 auto;padding:14px}

    .topbar{position:sticky;top:0;z-index:20;
      background:linear-gradient(180deg,var(--brand),var(--brand-2));
      color:#fff;border-bottom:1px solid #0001}
    .topbar .inner{max-width:720px;margin:0 auto;padding:12px 14px;
      display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:center}
    .logo{height:26px;flex:0 0 auto}
    .titlebox{display:flex;flex-direction:column;gap:2px;align-items:center}
    .appname{font-weight:700;letter-spacing:.2px}
    .tagline{opacity:.95;font-size:12.5px}

    .pillbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 6px}
    .pill{background:var(--chip-bg);border:1px solid var(--chip-line);
      padding:6px 10px;border-radius:999px;font-size:12.5px}

    .card{background:var(--card);border:1px solid var(--line);
      border-radius:12px;padding:14px;margin:12px 0}
    .sec-title{font-weight:700;margin-bottom:10px}
    .row{display:grid;grid-template-columns:1fr 110px 120px 120px;
      gap:8px;align-items:center}
    .row.header{color:var(--muted);font-size:12px}
    .row+.row{margin-top:8px}
    .chipbtn{background:var(--btn);border:1px solid var(--btn-line);
      color:var(--btn-ink);padding:8px 12px;border-radius:10px;cursor:pointer}
    .chipbtn:focus{outline:2px solid var(--focus)}

    .monolabel{font-weight:700;color:var(--muted);margin:4px 0 8px}

    input,select{width:100%;box-sizing:border-box;border:1px solid var(--line);
      background:#fff;color:var(--ink);border-radius:10px;padding:10px;font-size:14px}
    input:focus,select:focus{outline:2px solid var(--focus)}

    .footbar{position:sticky;bottom:0;background:var(--card);
      border-top:1px solid var(--line);padding:10px;display:flex;gap:8px;justify-content:space-between}

    .help-fab{position:fixed;right:14px;bottom:88px;z-index:25;
      background:var(--brand);color:#fff;border:none;border-radius:999px;
      padding:12px 14px;box-shadow:0 6px 18px #0003}

    /* Guided overlay */
    .overlay{position:fixed;inset:0;background:#0008;display:none;z-index:30}
    .overlay .panel{position:absolute;left:0;right:0;bottom:0;background:#fff;
      color:#000;border-radius:18px 18px 0 0;padding:18px}
    .overlay h3{margin:0 0 6px}
    .overlay p{margin:0 0 12px;color:#333}
    .overlay .actions{display:flex;gap:10px}
    .overlay button{padding:10px 12px;border-radius:10px;border:1px solid #ddd;cursor:pointer}

    @media (max-width:480px){
      .row{grid-template-columns:1fr 90px 100px 100px}
    }
  </style>
</head>
<body>

  <!-- Top header -->
  <header class="topbar">
    <div class="inner">
      <img class="logo" src="icons/app-h3-cube-contrast-Hwhite.svg" alt="H³">
      <div class="titlebox">
        <div class="appname">H³ Budget Tool</div>
        <div class="tagline">Private • Goal-Focused • Offline •</div>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- Personalize -->
    <section class="card">
      <div class="sec-title">Personalize</div>
      <div class="row">
        <label>Display Name</label>
        <input id="displayName" placeholder="Your name">
        <div style="grid-column: span 2; display:flex;align-items:center;gap:10px">
          <label for="guidedToggle" style="font-weight:700;color:var(--muted)">Guided Mode</label>
          <select id="guidedToggle">
            <option value="on">ON</option>
            <option value="off">OFF</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Income -->
    <section class="card" id="sec-income">
      <div class="sec-title">Income</div>
      <div class="monolabel">Monthly Income</div>
      <div class="row header">
        <div>Source</div><div>Freq</div><div>Per Pay</div><div>Monthly</div>
      </div>
      <div id="incomeRows"></div>
      <div class="pillbar">
        <button class="chipbtn" id="addIncome">+ Add income source</button>
        <button class="chipbtn" id="editIncome">Edit</button>
      </div>
    </section>

    <!-- Essentials -->
    <section class="card" id="sec-essentials">
      <div class="sec-title">Essentials</div>
      <div class="monolabel">Monthly Essentials</div>
      <div class="row header">
        <div>Item</div><div>Freq</div><div>Per Pay</div><div>Monthly</div>
      </div>
      <div id="essRows"></div>
      <div class="pillbar">
        <button class="chipbtn" id="addEss">+ Add expense</button>
        <button class="chipbtn" id="editEss">Edit</button>
      </div>
    </section>

    <!-- Debts -->
    <section class="card" id="sec-debts">
      <div class="sec-title">Debts</div>
      <div class="row header">
        <div>Name</div><div>APR %</div><div>Balance</div><div>Min Pay</div>
      </div>
      <div id="debtRows"></div>
      <div class="pillbar">
        <button class="chipbtn" id="addDebt">+ Add debt</button>
        <button class="chipbtn" id="editDebt">Edit</button>
      </div>
    </section>

    <!-- Goal -->
    <section class="card" id="sec-goal">
      <div class="sec-title">Goal</div>
      <div class="row">
        <label>What are you saving for?</label>
        <input id="goalName" placeholder="e.g., Down payment">
        <label>Target date</label>
        <input id="goalDate" type="date">
      </div>
    </section>

    <!-- Summary -->
    <section class="card" id="sec-summary">
      <div class="sec-title">Plan Summary</div>
      <div id="summaryText">Enter income, essentials, debts, and a goal to see your plan.</div>
    </section>

  </main>

  <!-- Sticky footer actions -->
  <footer class="footbar">
    <button class="chipbtn" id="saveBtn">Save</button>
    <button class="chipbtn" id="shareBtn">Share</button>
    <button class="chipbtn" id="exportBtn">Export JSON</button>
  </footer>

  <!-- Help FAB -->
  <button class="help-fab" id="helpFab">?</button>

  <!-- Guided overlay -->
  <div class="overlay" id="guide">
    <div class="panel">
      <h3 id="guideTitle">Welcome</h3>
      <p id="guideBody">Guided Mode explains each field and takes you step-by-step.</p>
      <div class="actions">
        <button id="guideBack">Back</button>
        <button id="guideNext" style="background:#0f9a9b;color:#fff;border-color:#0f9a9b">Next</button>
        <button id="guideClose">Close</button>
      </div>
    </div>
  </div>

  <script>
  ;(()=>{

    const $ = s=>document.querySelector(s);
    const $$ = s=>document.querySelectorAll(s);

    // --- State ---
    let state = {
      name:"",
      guided:"on",
      income:[],
      essentials:[],
      debts:[],
      goal:{ name:"", date:"" }
    };

    // --- Load / Save ---
    const KEY='h3xt0.v1';
    function load(){
      try{
        const raw=localStorage.getItem(KEY);
        if(raw){ state=JSON.parse(raw); }
      }catch(e){}
      $('#displayName').value = state.name||"";
      $('#guidedToggle').value = state.guided||"on";
      $('#goalName').value = state.goal?.name||"";
      $('#goalDate').value = state.goal?.date||"";
      renderAll();
    }
    function save(){
      state.name = $('#displayName').value.trim();
      state.guided = $('#guidedToggle').value;
      state.goal = { name:$('#goalName').value.trim(), date:$('#goalDate').value };
      localStorage.setItem(KEY, JSON.stringify(state));
      renderAll();
    }

    // --- Formatters ---
    const fmtMoney = v => {
      const n = +v||0;
      return n.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
    };

    // --- Rows renderers ---
    function renderIncome(){
      const wrap = $('#incomeRows'); wrap.innerHTML='';
      (state.income||[]).forEach((r,i)=>{
        const row = document.createElement('div'); row.className='row';
        row.innerHTML = `
          <input value="${r.src||''}" placeholder="Employer / source">
          <select>
            <option value="monthly"${r.freq==='monthly'?' selected':''}>Monthly</option>
            <option value="biweekly"${r.freq==='biweekly'?' selected':''}>Bi-weekly</option>
            <option value="semimonthly"${r.freq==='semimonthly'?' selected':''}>Semi-monthly</option>
          </select>
          <input value="${r.per||''}" inputmode="decimal" placeholder="$ per pay">
          <input value="${r.mon||''}" inputmode="decimal" placeholder="$ monthly">
        `;
        wrap.appendChild(row);
      });
    }
    function renderEss(){
      const wrap = $('#essRows'); wrap.innerHTML='';
      (state.essentials||[]).forEach((r,i)=>{
        const row = document.createElement('div'); row.className='row';
        row.innerHTML = `
          <input value="${r.item||''}" placeholder="Bill / expense">
          <select>
            <option value="monthly"${r.freq==='monthly'?' selected':''}>Monthly</option>
            <option value="biweekly"${r.freq==='biweekly'?' selected':''}>Bi-weekly</option>
            <option value="semimonthly"${r.freq==='semimonthly'?' selected':''}>Semi-monthly</option>
          </select>
          <input value="${r.per||''}" inputmode="decimal" placeholder="$ per pay">
          <input value="${r.mon||''}" inputmode="decimal" placeholder="$ monthly">
        `;
        wrap.appendChild(row);
      });
    }
    function renderDebts(){
      const wrap = $('#debtRows'); wrap.innerHTML='';
      (state.debts||[]).forEach((r,i)=>{
        const row = document.createElement('div'); row.className='row';
        row.innerHTML = `
          <input value="${r.name||''}" placeholder="Debt name">
          <input value="${r.apr||''}" inputmode="decimal" placeholder="APR %">
          <input value="${r.bal||''}" inputmode="decimal" placeholder="Balance">
          <input value="${r.min||''}" inputmode="decimal" placeholder="Min pay">
        `;
        wrap.appendChild(row);
      });
    }
    function renderSummary(){
      const inc = (state.income||[]).reduce((s,r)=>s+(+r.mon||0),0);
      const ess = (state.essentials||[]).reduce((s,r)=>s+(+r.mon||0),0);
      const min = (state.debts||[]).reduce((s,r)=>s+(+r.min||0),0);
      const left = inc - ess - min;
      $('#summaryText').textContent =
        `Monthly: Income ${fmtMoney(inc)} • Essentials ${fmtMoney(ess)} • Debt mins ${fmtMoney(min)} → Leftover ${fmtMoney(left)}.`;
    }
    function renderAll(){
      $('.appname').textContent = 'H³ Budget Tool' + (state.name?` — ${state.name}`:'');
      renderIncome(); renderEss(); renderDebts(); renderSummary();
    }

    // --- Buttons ---
    $('#addIncome').onclick = ()=>{
      (state.income = state.income||[]).push({src:'',freq:'monthly',per:'',mon:''});
      save();
    };
    $('#editIncome').onclick = ()=> alert('Edit mode coming soon');
    $('#addEss').onclick = ()=>{
      (state.essentials = state.essentials||[]).push({item:'',freq:'monthly',per:'',mon:''});
      save();
    };
    $('#editEss').onclick = ()=> alert('Edit mode coming soon');
    $('#addDebt').onclick = ()=>{
      (state.debts = state.debts||[]).push({name:'',apr:'',bal:'',min:''});
      save();
    };
    $('#editDebt').onclick = ()=> alert('Edit mode coming soon');

    $('#saveBtn').onclick = save;
    $('#exportBtn').onclick = ()=>{
      save();
      const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'h3-budget.json';
      a.click();
      URL.revokeObjectURL(a.href);
    };
    $('#shareBtn').onclick = ()=>{
      save();
      const enc = encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(state)))));
      const url = location.origin + location.pathname + '#d=' + enc;
      if(navigator.share){
        navigator.share({title:'H³ Budget Tool', text:'My plan', url});
      }else{
        prompt('Copy this link', url);
      }
    };

    // Guided mode overlay (simple stepper)
    const steps = [
      {t:'Income', b:'Add your income sources. Use Per Pay or Monthly — whichever is easiest.'},
      {t:'Essentials', b:'Add your essential bills (rent, utilities, etc.).'},
      {t:'Debts', b:'List debts with APR, balance, and minimum payment.'},
      {t:'Goal', b:'Name your goal and choose a target date.'},
      {t:'Summary', b:'Review the monthly picture and adjust as needed.'}
    ];
    let ix=0;
    function showGuide(show){
      $('#guide').style.display = show?'block':'none';
      if(show){ ix=0; paintStep(); }
    }
    function paintStep(){
      $('#guideTitle').textContent = steps[ix].t;
      $('#guideBody').textContent  = steps[ix].b;
    }
    $('#guidedToggle').onchange = (e)=> {
      state.guided = e.target.value; save();
      if(state.guided==='on') showGuide(true); else showGuide(false);
    };
    $('#helpFab').onclick = ()=> showGuide(true);
    $('#guideBack').onclick = ()=>{ ix=Math.max(0,ix-1); paintStep(); };
    $('#guideNext').onclick = ()=>{ ix=Math.min(steps.length-1,ix+1); paintStep(); };
    $('#guideClose').onclick = ()=> showGuide(false);

    // Handle shared state via URL hash
    (function tryImportFromHash(){
      const m = location.hash.match(/#d=([^&]+)/);
      if(m){
        try{
          const json = decodeURIComponent(escape(atob(decodeURIComponent(m[1]))));
          const obj = JSON.parse(json);
          if(obj && typeof obj==='object'){ state = Object.assign(state,obj); save(); location.hash=''; }
        }catch(e){}
      }
    })();

    // Init
    load();

    // Register service worker (bump query to force update)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js?v=24').catch(()=>{});
    }

  })();
  </script>
</body>
</html>


