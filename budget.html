<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>H¬≥ Budget Tool</title>
  <meta name="theme-color" content="#0f172a" />
  <link rel="icon" href="https://github.com/h3xto/H3_Budget_App/blob/main/icons/app-h3-cube-contrast-Hwhite.svg?raw=true" />
  <style>
    /* ---- Design system (dark and light) ---- */
    :root {
      --bg: #0b0f19;
      --panel: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --primary: #60a5fa;
      --accent: #34d399;
      --warn: #fbbf24;
      --danger: #f87171;
      --border: #1f2937;
      --shadow: 0 6px 18px rgba(0,0,0,0.35);
      --input: #0f172a;
      --chip: #0b1220;
      --radius: 14px;
      --radius-sm: 10px;
      --radius-lg: 18px;
    }
    :root[data-theme="light"] {
      --bg: #f7fafc;
      --panel: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --primary: #2563eb;
      --accent: #059669;
      --warn: #b45309;
      --danger: #b91c1c;
      --border: #e5e7eb;
      --shadow: 0 6px 18px rgba(0,0,0,0.06);
      --input: #f1f5f9;
      --chip: #eef2ff;
    }

    /* ---- Base ---- */
    * { box-sizing: border-box; }
/* ---- Custom scrollbar ---- */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
::-webkit-scrollbar-track {
  background: var(--input);
  border-radius: 4px;
}
::-webkit-scrollbar-thumb {
  background: var(--primary);
  border-radius: 4px;
}
::-webkit-scrollbar-thumb:hover {
  background: var(--accent);
}
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 15px/1.5 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .app { max-width: 820px; margin: 0 auto; padding: 12px 12px 80px; }

    /* ---- Header ---- */
    header {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 12px;
      align-items: center;
      padding: 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: saturate(1.2) blur(8px);
    }
    header img.logo {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      display: block;
      cursor: zoom-in;
      transition: transform .2s ease, box-shadow .2s ease;
      box-shadow: 0 2px 10px rgba(0,0,0,.25);
      background: #fff;
    }
    header img.logo:hover { transform: translateY(-1px); }
    .title { display: flex; flex-direction: column; gap: 2px; }
    .title .name { font-weight: 900; letter-spacing: 0.2px; font-size: 22px; line-height: 1.2; }
    .title .motto { color: var(--muted); font-size: 12px; letter-spacing: 0.3px; }
    .controls { display: flex; gap: 8px; align-items: center; }

    /* Theme toggle */
    #themeToggle {
      width: 38px;
      height: 38px;
      padding: 0;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--panel);
      box-shadow: var(--shadow);
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #themeToggle:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }

    .chip {
      background: var(--chip); border: 1px solid var(--border); color: var(--text);
      border-radius: 999px; padding: 8px 12px; font-weight: 700; cursor: pointer;
    }
    .chip.primary { background: var(--primary); color: #fff; border: none; }
    .chip.ghost { background: transparent; }

    /* ---- Sections ---- */
    .section {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-top: 14px;
      padding: 12px;
      box-shadow: var(--shadow);
    }
.section:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
    .section h2 {
      margin: 0 0 10px;
      font-size: 16px;
      display: flex; justify-content: space-between; align-items: center;
    }

    /* ---- Layout ---- */
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .row-4 { display: grid; grid-template-columns: 1.2fr .8fr .8fr .8fr; gap: 10px; }
    .row-5 { display: grid; grid-template-columns: 1fr .8fr .8fr .8fr .6fr; gap: 10px; }
    @media (max-width: 520px) {
      .row, .row-3, .row-4, .row-5 { grid-template-columns: 1fr; }
    }

    /* ---- Form ---- */
    label { display: flex; flex-direction: column; gap: 6px; font-size: 12px; color: var(--muted); }
    input, select, button {
      border: 1px solid var(--border);
      background: var(--input);
      color: var(--text);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      font-size: 15px;
    }
    input::placeholder { color: #8b97a8; }
    button.add { background: var(--primary); color: #fff; border: none; }
    button.minor { background: transparent; }
    .right { text-align: right; }

    /* ---- Collections ---- */
    .list { display: flex; flex-direction: column; gap: 10px; margin-top: 8px; }
    .card {
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
      border-radius: var(--radius);
      padding: 10px;
      display: grid; gap: 8px;
    }
    .line { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }

    /* ---- Text & badges ---- */
    .mono { font-variant-numeric: tabular-nums; font-feature-settings: "tnum"; }
    .muted { color: var(--muted); }
    .ok { color: var(--accent); }
    .danger { color: var(--danger); }
    .warn { color: var(--warn); }
    .totals { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 6px; }
    .badge {
      background: var(--chip); border: 1px solid var(--border);
      padding: 6px 10px; border-radius: 999px; font-weight: 800; font-size: 12px;
    }

    /* ---- Summary & KPIs ---- */
    .grid-2 { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 680px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
    .kpi { border: 1px dashed var(--border); border-radius: var(--radius); padding: 10px; background: rgba(255,255,255,0.02); }
    .kpi h3 { margin: 0 0 6px; font-size: 14px; }

    /* ---- Tip rows ---- */
    .tip-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 16px;
      width: 100%;
      align-items: stretch;
    }
    .tip-col.brand {
      flex: 1 1 30%;
      max-width: 32%;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      text-align: center;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }
    .tip-col.brand img {
      display: block;
      margin: 0 auto;
      max-width: 80px;
      height: auto;
      object-fit: contain;
      background: transparent;
      border-radius: 10px;
    }
    .tip-info { display: flex; flex-direction: column; gap: 6px; align-items: center; }
    .nowrap { white-space: nowrap; }

    @media (max-width: 600px) {
      .tip-col.brand { flex: 1 1 100%; max-width: 100%; }
    }
    .hide { display: none !important; }

    /* ---- Guided Mode footer ---- */
    #guidedControls {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 20;
      background: rgba(17,24,39,0.98);
      border-top: 1px solid var(--border);
      padding: 8px 12px;
      display: none;
    }
    #guidedControls.show { display: block; }
    .guided-hint { color: var(--muted); font-size: 12px; }

    /* ---- Guided Mode fullscreen focus ---- */
    body.guided-enabled .section { display: none; }
    body.guided-enabled .section.guided-focus {
      display: block;
      position: fixed;
      top: 76px; /* below sticky header */
      left: 0; right: 0; bottom: 64px; /* above sticky footer */
      z-index: 19;
      overflow: auto;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: var(--shadow);
    }
    #guidedToggle.primary { background: var(--primary); color: #fff; }

    /* ---- Guided overlay header inside focused panel ---- */
    .guided-header {
      position: sticky;
      top: 0;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 10px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 21;
    }
    .guided-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
    }
    .guided-header button {
      font-size: 13px;
      padding: 6px 10px;
    }

    /* ---- Print/PDF view ---- */
    @media print {
      header, #themeToggle, #guidedControls { display: none !important; }
      body { background: #fff; color: #000; }
      .section { break-inside: avoid; box-shadow: none; border-color: #ccc; }
    }

    /* ---- Logo zoom overlay ---- */
    #logoOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      cursor: zoom-out;
    }
    #logoOverlay.show { display: flex; }
    #logoOverlay img {
      max-width: 80vw;
      max-height: 80vh;
      border-radius: 16px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
      background: #fff;
    }

    /* ---- IAP disclaimer ---- */
    .iap-note { margin: 8px 0 0; font-size: 12px; color: var(--muted); }
    .iap-error { margin-top: 6px; font-size: 12px; color: var(--warn); }
    .iap-disabled .chip { opacity: 0.6; pointer-events: none; }

    /* ---- Inline SVG trend icons ---- */
    .trend-icon {
      width: 80px;
      height: 80px;
      border-radius: 10px;
      background: transparent;
      display: block;
      margin: 0 auto;
    }

    /* ---- Guided footer light-mode contrast patch ---- */
    #guidedControls .chip.ghost {
      color: #ffffff;
      border-color: rgba(255,255,255,0.35);
      background: rgba(255,255,255,0.08);
    }
    :root[data-theme="light"] #guidedControls .chip.ghost {
      color: #ffffff;
      border-color: rgba(255,255,255,0.45);
      background: rgba(0,0,0,0.28);
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <img
        class="logo"
        id="logoImg"
        src="https://github.com/h3xto/H3_Budget_App/blob/main/icons/app-h3-cube-contrast-Hwhite.svg?raw=true"
        alt="H3 Logo" />
      <div class="title">
        <div class="name">H¬≥ Budget Tool</div>
        <div class="motto">Private ‚Ä¢ Goal‚ÄëFocused ‚Ä¢ Offline</div>
      </div>
      <div class="controls">
        <button id="guidedToggle" class="chip ghost" type="button" aria-pressed="false" title="Step-by-step mode">Guided Mode</button>
        <button id="themeToggle" class="chip" type="button" aria-label="Toggle theme"></button>
      </div>
    </header>

    <!-- Profile & cadence -->
    <div class="section" id="profileSec">
      <h2>Profile & cadence</h2>
      <div class="row">
        <label>Display name
          <input id="displayName" placeholder="Name for your plan" />
        </label>
        <label>Pay cadence
          <select id="cadence">
            <option value="52">Weekly (52/yr)</option>
            <option value="26">Bi‚ÄëWeekly (26/yr)</option>
            <option value="24">Twice‚Äëa‚Äëmonth (24/yr)</option>
          </select>
        </label>
      </div>
    </div>

    <!-- Income -->
    <div class="section" id="incomeSec">
      <h2>
        Income
        <span>
          <button class="chip ghost" id="filterIncome" type="button" disabled>All</button>
          <button class="chip" id="addIncome" type="button">+ Add income</button>
        </span>
      </h2>
      <div id="incomeList" class="list"></div>
      <div class="totals">
        <div class="badge">Monthly income: <span id="incomeTotal" class="mono">$0.00</span></div>
      </div>
    </div>

    <!-- Essentials -->
    <div class="section" id="essentialsSec">
      <h2>
        Essentials
        <span>
          <select id="essCatFilter" title="Filter by category"></select>
          <button class="chip" id="addEssential" type="button">+ Add expense</button>
        </span>
      </h2>
      <div id="essentialsList" class="list"></div>
      <div class="totals">
        <div class="badge">Monthly essentials: <span id="essentialsTotal" class="mono">$0.00</span></div>
      </div>
    </div>

    <!-- Debts -->
    <div class="section" id="debtsSec">
      <h2>
        Debts
        <span>
          <select id="debtCatFilter" title="Filter by category"></select>
          <button class="chip" id="addDebt" type="button">+ Add debt</button>
        </span>
      </h2>
      <div id="debtsList" class="list"></div>
      <div class="totals">
        <div class="badge">Total balance: <span id="totBal" class="mono">$0.00</span></div>
        <div class="badge">Total minimums: <span id="totMin" class="mono">$0.00</span></div>
      </div>
    </div>

    <!-- Savings Goals -->
    <div class="section" id="goalsSec">
      <h2>
        Savings Goal(s)
        <button class="chip" id="addGoal" type="button">+ Add goal</button>
      </h2>
      <div id="goalsList" class="list"></div>
      <div class="totals">
        <div class="badge">Monthly required saving: <span id="reqSaveBadge" class="mono">$0.00</span></div>
        <div class="badge">Months to goal: <span id="monthsBadge" class="mono">‚Äî</span></div>
      </div>
    </div>

    <!-- Plan summary -->
    <div class="section summary" id="summarySec">
      <h2>Plan summary</h2>
      <div class="grid-2">
        <div class="kpi">
          <h3>Cash flow</h3>
          <p class="muted">Income ‚àí Essentials ‚àí Debt minimums ‚àí Required saving</p>
          <p class="line"><span>Free cash each month</span><span id="extraPool" class="mono right">$0.00</span></p>
          <p class="line"><span>Debt‚Äëto‚Äëincome (DTI)</span><span id="dti" class="mono right">‚Äî</span></p>
        </div>
        <div class="kpi">
          <h3>Recommendations</h3>
          <p class="line"><span>Strategy</span>
            <select id="strategy">
              <option value="avalanche">Avalanche (highest APR first)</option>
              <option value="snowball">Snowball (smallest balance first)</option>
            </select>
          </p>
          <p class="line"><span>Target debt this month</span><span id="targetDebt" class="mono right">‚Äî</span></p>
          <p class="line"><span>Projected debt‚Äëfree date</span><span id="projDone" class="mono right">‚Äî</span></p>
        </div>
      </div>
      <div id="flags" style="margin-top:10px;"></div>
      <div id="planExplanation" class="muted" style="margin-top:8px;"></div>

      <div class="kpi" style="margin-top:10px;">
        <h3>Goal progress</h3>
        <p class="muted">Updates as you enter ‚ÄúSaved so far‚Äù and a target date.</p>
        <p class="line"><span>Required monthly saving</span><span id="reqSave" class="mono right">$0.00</span></p>
        <p class="line"><span>Months to goal</span><span id="monthsToGoal" class="mono right">‚Äî</span></p>
      </div>
    </div>

    <!-- Export / Import -->
    <div class="section" id="exportSec">
      <h2>Export & import</h2>
      <div class="export-controls">
        <div class="checks">
          <label><input type="checkbox" id="incChk" checked /> Income</label>
          <label><input type="checkbox" id="essChk" checked /> Essentials</label>
          <label><input type="checkbox" id="debChk" checked /> Debts</label>
          <label><input type="checkbox" id="goaChk" checked /> Goals</label>
          <label><input type="checkbox" id="sumChk" checked /> Plan summary</label>
        </div>
        <div class="tip-row">
          <button id="exportCsv" class="chip">Export CSV</button>
          <button id="exportPdf" class="chip">Export PDF</button>
          <button id="blankCsv" class="chip ghost">Download blank CSV template</button>
          <label class="chip ghost" for="importCsvInput" style="cursor:pointer;">Import CSV</label>
          <input id="importCsvInput" type="file" accept=".csv" style="display:none;" />
        </div>
        <div id="importErrors" class="muted"></div>
      </div>
      </div>
    </div>

    <!-- In-App Purchases (Play build only) -->
    <div class="section" id="iapSec">
      <h2 id="iapTitle">In‚ÄëApp Purchases</h2>
      <p class="iap-note" id="iapNote">Paying does not unlock or add any features or functionality to the app. It only helps keep the app completely ad‚Äëfree and support the developer.</p>
      <div id="playPurchases" class="tip-row">
        <div class="tip-col brand">
          <svg class="trend-icon" viewBox="0 0 64 64" aria-label="Upward trend icon (green)">
            <path d="M10 46 L26 30 L34 38 L52 20" fill="none" stroke="#10B981" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="52" cy="20" r="3" fill="#10B981"/>
          </svg>
          <button class="chip" data-tip="tip_small">$1</button>
        </div>
        <div class="tip-col brand">
          <svg class="trend-icon" viewBox="0 0 64 64" aria-label="Upward trend icon (blue)">
            <path d="M10 46 L26 30 L34 38 L52 20" fill="none" stroke="#3B82F6" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="52" cy="20" r="3" fill="#3B82F6"/>
          </svg>
          <button class="chip" data-tip="tip_medium">$3</button>
        </div>
        <div class="tip-col brand">
          <svg class="trend-icon" viewBox="0 0 64 64" aria-label="Upward trend icon (orange)">
            <path d="M10 46 L26 30 L34 38 L52 20" fill="none" stroke="#F59E0B" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="52" cy="20" r="3" fill="#F59E0B"/>
          </svg>
          <button class="chip" data-tip="tip_large">$5</button>
        </div>
      </div>
      <div id="iapError" class="iap-error hide">In‚Äëapp purchases are currently unavailable.</div>
    </div>

    <!-- Support the Developer (Web build only) -->
    <div class="section" id="tipSec">
      <h2>Support the Developer</h2>
      <div id="webTips" class="tip-row">
        <div class="tip-col brand">
          <img src="assets/icon-cashapp.png" alt="CashApp logo" />
          <div class="tip-info">
            <div class="nowrap">CashApp</div>
            <a class="chip" id="tipCashApp" href="https://cash.app/$h3xto" target="_blank" rel="noopener">Open link</a>
          </div>
        </div>
        <div class="tip-col brand">
          <img src="assets/icon-paypal.png" alt="PayPal logo" />
          <div class="tip-info">
            <div class="nowrap">PayPal</div>
            <a class="chip" id="tipPayPal" href="https://paypal.me/h3xto" target="_blank" rel="noopener">Open link</a>
          </div>
        </div>
        <div class="tip-col brand">
          <img src="assets/icon-venmo.png" alt="Venmo logo" />
          <div class="tip-info">
            <div class="nowrap">Venmo</div>
            <a class="chip" id="tipVenmo" href="https://www.venmo.com/u/HEXTO" target="_blank" rel="noopener">Open link</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Guided sticky controls -->
  <div id="guidedControls">
    <div class="app" style="padding-top:6px; padding-bottom:6px;">
      <div class="row" style="grid-template-columns: 1fr auto; align-items:center;">
        <div class="guided-hint">Guided Mode: fill this section, then click Next. You can exit anytime.</div>
        <div>
          <button id="guidedBack" class="chip ghost" type="button">Back</button>
          <button id="guidedNext" class="chip" type="button">Next</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Logo zoom overlay -->
  <div id="logoOverlay" aria-hidden="true">
    <img src="https://github.com/h3xto/H3_Budget_App/blob/main/icons/app-h3-cube-contrast-Hwhite.svg?raw=true" alt="H3 Logo Large" />
  </div>

  <script>
    // ---- Currency helpers ----
    const CURRENCY = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', currencyDisplay: 'symbol' });
    const fmtMoney = v => CURRENCY.format(Number(v||0));
    const parseMoney = s => {
      const n = parseFloat(String(s||'').replace(/[^0-9.-]/g, ''));
      return Number.isFinite(n) ? n : 0;
    };

    // ---- DOM helpers ----
    const $ = id => document.getElementById(id);
    const todayISO = () => new Date().toISOString().slice(0,10);
    const monthsBetween = (a, b) => {
      const d1 = new Date(a), d2 = new Date(b);
      const years = d2.getFullYear() - d1.getFullYear();
      const months = d2.getMonth() - d1.getMonth();
      const total = years*12 + months + (d2.getDate() >= d1.getDate() ? 0 : -1);
      return Math.max(1, total);
    };

    // ---- State ----
    const empty = () => ({
      displayName: '',
      cadence: 26,
      strategy: 'avalanche',
      incomes: [],
      essentials: [],
      debts: [],
      goals: []
    });
    let state = empty();

    function save(){ localStorage.setItem('h3-budget', JSON.stringify(state)); }
    function load(){
      try{
        const raw = localStorage.getItem('h3-budget');
        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed.incomes)) {
            parsed.incomes = parsed.incomes.map(x => {
              if (x && x.amountPerPeriod == null && x.amountMonthly != null) {
                const cad = Number(parsed.cadence || 26);
                const perMonth = Number(x.amountMonthly || 0);
                const perPeriod = cad ? perMonth * 12 / cad : perMonth;
                return { name: x.name || '', amountPerPeriod: perPeriod };
              }
              return { name: x?.name || '', amountPerPeriod: Number(x?.amountPerPeriod||0) };
            });
          }
          if (Array.isArray(parsed.essentials)) {
            parsed.essentials = parsed.essentials.map(e => ({ ...e, cadenceMonths: parseInt(e?.cadenceMonths)||1 }));
          }
          state = { ...empty(), ...parsed };
        }
      }catch{}
    }

    // ---- Theme ----
    (function initTheme(){
      const saved = localStorage.getItem('h3-theme') || 'dark';
      document.documentElement.dataset.theme = saved;
      // Set initial icon
      $('themeToggle').textContent = saved === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      $('themeToggle').onclick = () => {
        const cur = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
        document.documentElement.dataset.theme = cur;
        localStorage.setItem('h3-theme', cur);
        // Update icon when theme changes
        $('themeToggle').textContent = cur === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      };
    })();

    // ---- Orientation lock best-effort ----
    (async function lockPortrait(){ try { await screen.orientation?.lock?.('portrait'); } catch {} })();

    // ---- Binders ----
    function bindText(el, obj, key){ el.addEventListener('input', () => { obj[key] = el.value; compute(); save(); }); }
    function bindNumber(el, obj, key){ el.addEventListener('input', () => { obj[key] = parseMoney(el.value); compute(); save(); }); }
    function bindMoney(input, obj, key) {
      const syncState = () => { obj[key] = parseMoney(input.value); compute(); save(); };
      input.addEventListener('input', syncState);
      input.addEventListener('blur', () => {
        const v = obj[key] || 0;
        input.value = v ? fmtMoney(v) : '';
      });
      input.addEventListener('focus', () => {
        const v = obj[key] || 0;
        input.value = v ? String(v) : '';
      });
    }
    function removeAt(list, i, rerender){ list.splice(i,1); save(); rerender(); compute(); }

    // ---- Income ----
    function addIncomeRow(item={name:'', amountPerPeriod:0}){ state.incomes.push(item); save(); renderIncomes(); }
    function renderIncomes(){
      const host = $('incomeList'); host.innerHTML = '';
      state.incomes.forEach((it,i)=>{
        const div = document.createElement('div'); div.className='card';
        div.innerHTML = `
          <div class="row">
            <label>Source <input value="${it.name||''}" placeholder="e.g., Salary" /></label>
            <label>Paycheck amount (net) <input type="text" inputmode="decimal" class="currency-input" value="${it.amountPerPeriod||0}" /></label>
          </div>
          <div class="right"><button class="minor" type="button" data-del>Remove</button></div>`;
        const [src, amt] = div.querySelectorAll('input');
        bindText(src, it, 'name');
        bindMoney(amt, it, 'amountPerPeriod');
        amt.value = it.amountPerPeriod ? fmtMoney(it.amountPerPeriod) : '';
        div.querySelector('[data-del]').onclick=()=>removeAt(state.incomes,i,renderIncomes);
        host.appendChild(div);
      });
      $('incomeTotal').textContent = fmtMoney(totalIncomeMonthly());
      compute();
    }

    // ---- Essentials ----
    function addEssentialRow(item={name:'', category:'General', amountMonthly:0, cadenceMonths:1}){ state.essentials.push(item); save(); renderEssentials(); }
    function renderEssentials(){
      const host = $('essentialsList'); host.innerHTML = '';
      const filter = $('essCatFilter').value || 'All';
      state.essentials
        .filter(it => filter==='All' || (it.category||'General')===filter)
        .forEach((it,i)=>{
        const div = document.createElement('div'); div.className='card';
        const c = (+it.cadenceMonths||1);
        div.innerHTML = `
          <div class="row-4">
            <label>Expense <input value="${it.name||''}" placeholder="e.g., Rent" /></label>
            <label>Category
              <input list="essCats" value="${it.category||'General'}" placeholder="e.g., Housing" />
            </label>
            <label>Amount (gross) <input type="text" inputmode="decimal" class="currency-input" value="${it.amountMonthly||0}" /></label>
            <label>Cadence
              <select class="cadence-select">
                <option value="1" ${c===1?'selected':''}>Monthly</option>
                <option value="3" ${c===3?'selected':''}>Quarterly</option>
                <option value="6" ${c===6?'selected':''}>Bi-annual</option>
                <option value="12" ${c===12?'selected':''}>Annual</option>
              </select>
            </label>
          </div>
          <div class="right"><button class="minor" type="button" data-del>Remove</button></div>`;
        const inputs = div.querySelectorAll('input');
        const selCad = div.querySelector('.cadence-select');
        bindText(inputs[0], it, 'name');
        bindText(inputs[1], it, 'category');
        bindMoney(inputs[2], it, 'amountMonthly');
        inputs[2].value = it.amountMonthly ? fmtMoney(it.amountMonthly) : '';
        selCad.addEventListener('change', () => {
          it.cadenceMonths = parseInt(selCad.value, 10) || 1;
          compute(); save();
        });
        div.querySelector('[data-del]').onclick=()=>{ const idx = state.essentials.indexOf(it); removeAt(state.essentials, idx, renderEssentials); };
        host.appendChild(div);
      });
      $('essentialsTotal').textContent = fmtMoney(totalEssentialsMonthly());
      refreshEssCategories();
      compute();
    }

    // ---- Debts ----
    function addDebtRow(item={name:'', category:'General', balance:0, apr:0, min:0, term:0}){ state.debts.push(item); save(); renderDebts(); }
    function renderDebts(){
      const host = $('debtsList'); host.innerHTML = '';
      const filter = $('debtCatFilter').value || 'All';
      state.debts
        .filter(d => filter==='All' || (d.category||'General')===filter)
        .forEach((d,i)=>{
        const div = document.createElement('div'); div.className='card';
        div.innerHTML = `
          <div class="row-5">
            <label>Debt name <input value="${d.name||''}" placeholder="e.g., Visa"/></label>
            <label>Balance <input type="text" inputmode="decimal" class="currency-input" value="${d.balance||0}" /></label>
            <label>APR % <input type="number" step="0.01" value="${d.apr||0}" /></label>
            <label>Min (optional) <input type="text" inputmode="decimal" class="currency-input" value="${d.min||0}" /></label>
            <label>Term months (opt) <input type="number" step="1" value="${d.term||0}" /></label>
          </div>
          <div class="row">
            <label>Category <input list="debtCats" value="${d.category||'General'}" placeholder="e.g., Credit Card"/></label>
            <div class="right"><button class="minor" type="button" data-del>Remove</button></div>
          </div>`;
        const ins = div.querySelectorAll('input');
        bindText(ins[0], d, 'name');
        bindMoney(ins[1], d, 'balance');
        bindNumber(ins[2], d, 'apr');
        bindMoney(ins[3], d, 'min');
        bindNumber(ins[4], d, 'term');
        bindText(ins[5], d, 'category');
        ins[1].value = d.balance ? fmtMoney(d.balance) : '';
        ins[3].value = d.min ? fmtMoney(d.min) : '';
        div.querySelector('[data-del]').onclick=()=>{ const idx = state.debts.indexOf(d); removeAt(state.debts, idx, renderDebts); };
        host.appendChild(div);
      });
      refreshDebtCategories();
      compute();
    }

    // ---- Goals ----
    function addGoalRow(item={name:'', goalAmt:0, goalDate:todayISO(), goalNow:0}){ state.goals.push(item); save(); renderGoals(); }
    function renderGoals(){
      const host = $('goalsList'); host.innerHTML = '';
      state.goals.forEach((g,i)=>{
        const div = document.createElement('div'); div.className='card';
        div.innerHTML = `
          <div class="row-4">
            <label>Goal name <input value="${g.name||''}" placeholder="e.g., Emergency fund"/></label>
            <label>Target amount <input type="text" inputmode="decimal" class="currency-input" value="${g.goalAmt||0}" /></label>
            <label>Target date <input type="date" value="${g.goalDate||todayISO()}" /></label>
            <label>Saved so far <input type="text" inputmode="decimal" class="currency-input" value="${g.goalNow||0}" /></label>
          </div>
          <div class="right"><button class="minor" type="button" data-del>Remove</button></div>`;
        const [name, amt, date, now] = div.querySelectorAll('input');
        bindText(name, g, 'name');
        bindMoney(amt, g, 'goalAmt');
        date.addEventListener('change', ()=>{ g.goalDate = date.value; compute(); save(); });
        bindMoney(now, g, 'goalNow');
        amt.value = g.goalAmt ? fmtMoney(g.goalAmt) : '';
        now.value = g.goalNow ? fmtMoney(g.goalNow) : '';
        div.querySelector('[data-del]').onclick=()=>removeAt(state.goals
        , i, renderGoals);
        host.appendChild(div);
      });
      compute();
    }

    // ---- Totals ----
    const periodsPerMonth = () => (Number(state.cadence||26) / 12);
    const totalIncomeMonthly = () => state.incomes.reduce((s,x)=> s + (parseMoney(x.amountPerPeriod)||0) * periodsPerMonth(), 0);
    const totalEssentialsMonthly = () =>
      state.essentials.reduce((s, x) => {
        const amt = parseMoney(x.amountMonthly);
        const cad = parseInt(x.cadenceMonths, 10) || 1;
        return s + (amt / cad);
      }, 0);

    // ---- Categories ----
    function refreshEssCategories(){
      const sel = $('essCatFilter');
      const cats = Array.from(new Set(state.essentials.map(e=>e.category||'General')));
      const values = ['All', ...cats].filter((v,i,self)=>self.indexOf(v)===i);
      const cur = sel.value || 'All';
      sel.innerHTML = values.map(v=>`<option>${v}</option>`).join('');
      sel.value = values.includes(cur)?cur:'All';
    }
    function refreshDebtCategories(){
      const sel = $('debtCatFilter');
      const cats = Array.from(new Set(state.debts.map(d=>d.category||'General')));
      const values = ['All', ...cats].filter((v,i,self)=>self.indexOf(v)===i);
      const cur = sel.value || 'All';
      sel.innerHTML = values.map(v=>`<option>${v}</option>`).join('');
      sel.value = values.includes(cur)?cur:'All';
    }

    // ---- Recommendation explanation ----
    function buildRecommendationText() {
      const inc = totalIncomeMonthly();
      const fixed = totalEssentialsMonthly();
      const g = state.goals[0] || {};
      const months = g.goalDate ? monthsBetween(new Date(), g.goalDate) : null;
      const reqSave = (parseMoney(g.goalAmt) > 0 && months) ? Math.max(0, (parseMoney(g.goalAmt)-parseMoney(g.goalNow))/months) : 0;
      const totMin = state.debts.reduce((s,d)=>s+(parseMoney(d.min)||0),0);
      const extraPool = inc - fixed - totMin - reqSave;

      const target = $('targetDebt').textContent || '‚Äî';
      const projDate = $('projDone').textContent || '‚Äî';
      const strategy = state.strategy;

      let strategyText = '';
      if (strategy === 'avalanche') {
        strategyText = `Using the Avalanche strategy, your highest-interest debt (‚Äú${target}‚Äù) is prioritized first. This minimizes total interest paid and accelerates your debt-free date (${projDate}).`;
      } else {
        strategyText = `Using the Snowball strategy, your smallest balance debt (‚Äú${target}‚Äù) is prioritized first. This builds momentum and keeps motivation high, with a projected debt-free date of ${projDate}.`;
      }

      let goalText = '';
      if (g.name) {
        goalText = ` With ${fmtMoney(extraPool)} in free cash each month, you can meet your savings goal (‚Äú${g.name}‚Äù)${months ? ` in ${months} months` : ''} while staying on track financially.`;
      }

      return strategyText + goalText;
    }

    // ---- Math & planning ----
    function compute(){
      $('displayName').value = state.displayName || '';
      $('cadence').value = String(state.cadence || 26);
      $('strategy').value = state.strategy || 'avalanche';

      const g = state.goals[0] || {};
      const months = g.goalDate ? monthsBetween(new Date(), g.goalDate) : '';
      $('monthsToGoal').textContent = months || '‚Äî';
      $('monthsBadge').textContent = months || '‚Äî';
      const reqSave = (parseMoney(g.goalAmt) > 0 && months) ? Math.max(0, (parseMoney(g.goalAmt)-parseMoney(g.goalNow))/months) : 0;
      $('reqSave').textContent = fmtMoney(reqSave);
      $('reqSaveBadge').textContent = fmtMoney(reqSave);

      let totBal=0, totMin=0;
      const normalized = state.debts.filter(d=>(parseMoney(d.balance)||0)>0).map(d=>{
        const balance = parseMoney(d.balance);
        const minIn = parseMoney(d.min);
        const apr = parseMoney(d.apr);
        const term = parseInt(d.term)||0;
        const r = (apr||0)/100/12;
        const amortMin = (term>0 && r>0) ? ((balance*r)/(1 - Math.pow(1+r, -term))) : 0;
        const floorMin = Math.min(balance||0, 25);
        const min = minIn>0 ? minIn : (amortMin>0 ? amortMin : floorMin);
        totBal += (balance||0); totMin += min;
        return {...d, balance, apr, term, r, min};
      });
      $('totBal').textContent = fmtMoney(totBal);
      $('totMin').textContent = fmtMoney(totMin);

      const inc = totalIncomeMonthly();
      const fixed = totalEssentialsMonthly();
      const extraPool = (inc - fixed - totMin - reqSave);
      $('extraPool').textContent = fmtMoney(extraPool);

      const dti = inc>0 ? (totMin/inc) : 0;
      $('dti').textContent = inc>0 ? (dti*100).toFixed(1)+'%' : '‚Äî';

      let target='‚Äî';
      if (normalized.length){
        const sorted = normalized.slice().sort((a,b) => state.strategy==='avalanche' ? (b.apr - a.apr) : ((a.balance||0) - (b.balance||0)));
        target = sorted[0]?.name || '‚Äî';
      }
      $('targetDebt').textContent = target;

      const flags=[];
      if (extraPool < 0) flags.push('‚ö†Ô∏è Negative cash flow ‚Äî raise income, reduce essentials, delay goal, or adjust debt terms.');
      if ((parseMoney(g.goalAmt)||0)>0 && !g.goalDate) flags.push('‚ÑπÔ∏è Set a goal date to compute required monthly saving.');
      if (normalized.some(d=> (d.min||0) < (d.balance||0)*d.r)) flags.push('‚ö†Ô∏è A minimum payment is below monthly interest (negative amortization).');
      $('flags').innerHTML = flags.length
        ? `<div class="${extraPool<0?'danger':'warn'}">${flags.join('<br>')}</div>`
        : `<div class="ok">‚úÖ Plan is feasible based on current inputs.</div>`;

      $('projDone').textContent = projection(normalized, Math.max(0, extraPool), state.strategy);

      $('incomeTotal').textContent = fmtMoney(inc);
      $('essentialsTotal').textContent = fmtMoney(fixed);

      $('planExplanation').textContent = buildRecommendationText();

      save();
    }

    function projection(debts, extra, strategy){
      debts = debts.map(d=>({...d, bal:d.balance, alive:(d.balance||0)>0}));
      let month=0, guard=0;
      while(debts.some(d=>d.alive) && guard<1200){
        debts.forEach(d=>{
          if(!d.alive) return;
          const interest = d.bal * d.r;
          const due = d.bal + interest;
          const pay = Math.min(d.min, due);
          d.bal = due - pay;
          if (d.bal <= 0.01){ d.bal=0; d.alive=false; }
        });
        const alive = debts.filter(d=>d.alive);
        if (!alive.length) break;
        alive.sort((a,b)=> strategy==='avalanche' ? (b.apr - a.apr) : (a.bal - b.bal));
        let t = alive[0];
        if (extra>0 && t.alive){
          t.bal = Math.max(0, t.bal - extra);
          if (t.bal <= 0.01){ t.bal=0; t.alive=false; }
        }
        month++; guard++;
      }
      if (guard>=1200) return '‚Äî';
      const done = new Date(); done.setMonth(done.getMonth()+month);
      return done.toLocaleDateString();
    }

    // ---- Static controls ----
    $('displayName').addEventListener('input', e=>{ state.displayName = e.target.value; save(); });
    $('cadence').addEventListener('change', e=>{ state.cadence = parseInt(e.target.value,10); save(); compute(); });
    $('strategy').addEventListener('change', e=>{ state.strategy = e.target.value; save(); compute(); });

    // ---- Add buttons ----
    $('addIncome').onclick = ()=>addIncomeRow();
    $('addEssential').onclick = ()=>addEssentialRow();
    $('addDebt').onclick = ()=>addDebtRow();
    $('addGoal').onclick
=()=>addGoalRow({name:'', goalAmt:0, goalDate:todayISO(), goalNow:0});

    // ---- Filters ----
    $('essCatFilter').addEventListener('change', renderEssentials);
    $('debtCatFilter').addEventListener('change', renderDebts);

    // ---- Tip links (web) ----
    (function initLinks(){
      $('tipCashApp').href = 'https://cash.app/$h3xto';
      $('tipPayPal').href = 'https://paypal.me/h3xto';
      $('tipVenmo').href = 'https://www.venmo.com/u/HEXTO';
    })();

    // ---- Environment detection (Play vs Web) ----
    const isAndroid = /Android/i.test(navigator.userAgent);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || navigator.standalone === true;
    const isChrome = !!window.chrome && /Chrome/i.test(navigator.userAgent);
    const PLAY_ORIGIN = 'https://play.google.com/billing';

    // ---- Hardened Play/Web IAP setup ----
    async function setupTips() {
      const tipSec = document.getElementById('tipSec');
      const iapSec = document.getElementById('iapSec');
      const playPurchases = document.getElementById('playPurchases');
      const iapError = document.getElementById('iapError');
      const productIds = ['tip_small', 'tip_medium', 'tip_large'];

      // Default: Web view (show external links, hide IAP)
      tipSec?.classList.remove('hide');
      iapSec?.classList.add('hide');

      // Strict gate for Play build:
      if (!(isAndroid && isStandalone && isChrome)) return;

      // Hide web tips for Play build
      tipSec?.classList.add('hide');
      iapSec?.classList.remove('hide');

      // DGS presence check
      if (typeof getDigitalGoodsService !== 'function') {
        playPurchases?.classList.add('iap-disabled');
        iapError?.classList.remove('hide');
        return;
      }

      try {
        const dgs = await getDigitalGoodsService(PLAY_ORIGIN);

        // Prefetch product details and gate buttons
        let details = [];
        try { details = await dgs.getDetails(productIds); } catch {}
        const availableSet = new Set((details || []).map(d => d.itemId));

        const allAvailable = productIds.every(id => availableSet.has(id));
        if (!allAvailable) {
          playPurchases?.classList.add('iap-disabled');
          iapError?.classList.remove('hide');
          document.querySelectorAll('[data-tip]').forEach(b => { b.onclick = null; });
          return;
        }

        // Products available: enable buttons, hide error
        playPurchases?.classList.remove('iap-disabled');
        iapError?.classList.add('hide');

        async function buy(id) {
          try {
            const p = await dgs.launchBillingFlow({ itemId: id });
            if (p?.purchaseToken) {
              await dgs.acknowledge({ purchaseToken: p.purchaseToken });
              alert('Thank you for your support! üôè');
            } else {
              alert('Purchase cancelled or failed.');
            }
          } catch {
            alert('Purchase cancelled or failed.');
          }
        }

        // Bind buttons
        document.querySelectorAll('[data-tip]').forEach(b => {
          const id = b.dataset.tip;
          b.onclick = () => buy(id);
        });

      } catch {
        // DGS failed: show disabled IAP (policy-safe)
        playPurchases?.classList.add('iap-disabled');
        iapError?.classList.remove('hide');
        document.querySelectorAll('[data-tip]').forEach(b => { b.onclick = null; });
      }
    }

    // ---- Guided Mode ----
    const guided = {
      enabled: false,
      order: ['incomeSec','essentialsSec','debtsSec','goalsSec'],
      idx: 0
    };
    function applyGuided() {
      const isOn = guided.enabled;
      document.body.classList.toggle('guided-enabled', isOn);
      $('guidedControls').classList.toggle('show', isOn);
      const toggle = $('guidedToggle');
      toggle.setAttribute('aria-pressed', isOn ? 'true' : 'false');
      toggle.classList.toggle('primary', isOn);
      toggle.textContent = isOn ? 'Guided Mode (On)' : 'Guided Mode';

      const ids = ['profileSec','incomeSec','essentialsSec','debtsSec','goalsSec','summarySec','exportSec','iapSec','tipSec'];
      ids.forEach(id => {
        const sec = $(id);
        if (!sec) return;
        const activeId = guided.order[guided.idx];
        const focus = (id === activeId);
        sec.classList.toggle('guided-focus', isOn && focus);

        const existingHeader = sec.querySelector('.guided-header');
        if (isOn && focus) {
          if (!existingHeader) {
            const header = document.createElement('div');
            header.className = 'guided-header';
            const titleText = sec.querySelector('h2')?.textContent || '';
            header.innerHTML = `<h3>${titleText}</h3>
              <button class="chip ghost" type="button" id="exitGuided">Exit</button>`;
            sec.insertBefore(header, sec.firstChild);
            header.querySelector('#exitGuided').onclick = () => {
              guided.enabled = false;
              applyGuided();
            };
          }
        } else {
          if (existingHeader) existingHeader.remove();
        }
      });

      $('guidedNext').textContent = guided.idx === guided.order.length - 1 ? 'Finish Guided Mode' : 'Next';

      if (isOn) {
        const active = $(guided.order[guided.idx]);
        if (active) active.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }
    function nextStep() {
      if (guided.idx < guided.order.length - 1) {
        guided.idx++;
      } else {
        guided.enabled = false;
      }
      applyGuided();
    }
    function prevStep() { if (guided.idx > 0) guided.idx--; applyGuided(); }

    (function initGuided(){
      $('guidedToggle').addEventListener('click', () => {
        guided.enabled = !guided.enabled;
        if (guided.enabled) guided.idx = 0;
        applyGuided();
      });
      $('guidedBack').addEventListener('click', prevStep);
      $('guidedNext').addEventListener('click', nextStep);

      guided.order.forEach(id=>{
        const sec = $(id);
        if (sec) {
          sec.querySelector('h2')?.addEventListener('click', ()=>{
            if (!guided.enabled) return;
            const idx = guided.order.indexOf(id);
            if (idx >= 0) { guided.idx = idx; applyGuided(); }
          });
        }
      });
    })();

    // ---- Logo zoom overlay ----
    (function initLogoZoom(){
      const overlay = $('logoOverlay');
      const logo = $('logoImg');
      logo.addEventListener('click', ()=> overlay.classList.add('show'));
      overlay.addEventListener('click', ()=> overlay.classList.remove('show'));
      document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') overlay.classList.remove('show'); });
    })();

    // ---- Boot ----
    function renderAll(){
      $('displayName').value = state.displayName || '';
      $('cadence').value = String(state.cadence || 26);
      $('strategy').value = state.strategy || 'avalanche';
      refreshEssCategories();
      refreshDebtCategories();
      if (!$('essCatFilter').value) $('essCatFilter').value = 'All';
      if (!$('debtCatFilter').value) $('debtCatFilter').value = 'All';
      renderIncomes();
      renderEssentials();
      renderDebts();
      renderGoals();
      compute();
    }

    load();
    renderAll();
    setupTips();
  </script>
</body>
</html>
