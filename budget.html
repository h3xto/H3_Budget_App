<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>H¬≥ Budget Tool</title>

<!-- PWA -->
<link rel="manifest" href="/H3_Budget_App/manifest.webmanifest">
<link rel="icon" href="/H3_Budget_App/icons/icon-192-v3.png" sizes="192x192">
<link rel="apple-touch-icon" href="/H3_Budget_App/icons/icon-192-v3.png">
<meta name="theme-color" content="#0b0f14">

<style>
  :root{
    --bg:#0b0f14; --card:#10161f; --muted:#91a4b7; --ink:#e6edf3; --ink2:#cfd8e3;
    --ring:#233142; --accent:#19a7a8; --accent2:#11777a; --danger:#b34747; --shadow:0 6px 24px rgba(0,0,0,.35);
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;overflow-x:hidden}
  a{color:#9fd2ff;text-decoration:none}
  img,svg{max-width:100%;height:auto}

  .wrap{max-width:900px;width:100%;margin:0 auto;padding:22px 14px 120px}

  /* header */
  .topbar{display:flex;justify-content:center;align-items:center;gap:12px;margin-bottom:8px}
  .appicon{width:28px;height:28px;background:url(/H3_Budget_App/icons/icon-192-v3.png) center/cover;border-radius:6px;box-shadow:var(--shadow)}
  h1{font-size:28px;margin:0;text-align:center}
  .badges{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 18px;justify-content:center}
  .badge{background:#0f1a24;border:1px solid var(--ring);color:var(--ink2);padding:6px 10px;border-radius:999px;font-size:13px}

  /* cards */
  .card{background:var(--card);border:1px solid var(--ring);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);margin:14px 0}
  .card h2{margin:0 0 8px;font-size:22px}
  .sub{color:var(--muted);font-size:14px;margin:0 0 14px}

  /* rows & inputs (mobile-first) */
  .row{display:grid;grid-template-columns:1fr;gap:12px;align-items:center;margin:10px 0}
  .row.two{grid-template-columns:1fr}
  .row .trash{width:44px;height:44px;border-radius:12px;border:1px solid var(--ring);display:grid;place-items:center;color:#cbd5e1;background:#0f1a24;cursor:pointer;justify-self:end}
  .trash:hover{background:#13202e}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:0;border-radius:999px;padding:14px 18px;background:var(--accent);color:#032925;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
  .btn:active{transform:translateY(1px)}
  .btn.ghost{background:#0f1a24;color:var(--ink2);border:1px solid var(--ring)}
  .btn.danger{background:#8b2e2e;color:#fff}
  input,select{width:100%;min-width:0;height:44px;border-radius:12px;border:1px solid var(--ring);background:#0f1a24;color:var(--ink);padding:0 12px;font-size:16px}
  input.money{text-align:right;max-width:100%}

  /* debt row: name full width, then fields stack on phones */
  .row.debt{grid-template-columns:1fr}
  .row.debt .grid2{display:grid;grid-template-columns:1fr;gap:10px}
  .row.debt .grid2 .inline-last{display:grid;grid-template-columns:1fr 44px;gap:10px}

  /* grow to compact 4-col layout at >= 480px */
  @media (min-width:480px){
    .row{grid-template-columns:1fr 150px 56px}
    .row.two{grid-template-columns:1fr 150px 56px}
    .row.debt{grid-template-columns:1fr}
    .row.debt .grid2{grid-template-columns:110px minmax(0,1fr) 120px 44px}
    .row .trash{justify-self:auto}
  }

  /* totals line */
  .totals{display:flex;justify-content:flex-end;align-items:baseline;gap:8px;margin-top:6px}
  .totals b{font-size:16px}
  .totals .amt{font-weight:800}

  /* summary visuals */
  .pill{background:#0f1a24;border:1px solid var(--ring);border-radius:12px;padding:12px 14px;margin:10px 0}
  .bar{height:10px;border-radius:999px;background:#0f1a24;border:1px solid var(--ring);overflow:hidden}
  .bar > span{display:block;height:100%;background:linear-gradient(90deg,#2fb1b4,#0aa1a4)}

  /* footer */
  .footer{position:fixed;inset:auto 0 0;display:flex;justify-content:center;background:linear-gradient(180deg,transparent,rgba(0,0,0,.4));padding:14px}
  .footer .group{background:#0f1a24;border:1px solid var(--ring);border-radius:999px;padding:8px;display:flex;gap:8px}

  /* wizard */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none}
  .overlay.show{display:block}
  .wizard{position:fixed;inset:0;display:none;place-items:center;padding:18px}
  .wizard.show{display:grid}
  .sheet{max-width:920px;width:100%;background:var(--card);border:1px solid var(--ring);border-radius:18px;box-shadow:var(--shadow)}
  .sheet header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--ring)}
  .sheet .body{padding:16px}
  .sheet .nav{display:flex;gap:12px;justify-content:flex-end;padding:14px;border-top:1px solid var(--ring);background:#0f151d;border-radius:0 0 18px 18px}
  .step{display:none}
  .step.show{display:block}

  /* neutralize weird RTL underlines/ordering */
  .neutral{unicode-bidi:plaintext;direction:ltr}
</style>

<div class="wrap" id="app">

  <div class="topbar">
    <div class="appicon"></div>
    <h1>H¬≥ Budget Tool</h1>
  </div>

  <div class="badges">
    <span class="badge">Private</span>
    <span class="badge">Goal-Focused</span>
    <span class="badge">Offline</span>
    <span class="badge" id="guidedToggle">
      <label style="display:inline-flex;gap:8px;align-items:center;cursor:pointer">
        Guided Mode
        <input id="guided" type="checkbox" style="accent-color:#19a7a8;width:18px;height:18px">
      </label>
    </span>
  </div>

  <!-- Display + cadence -->
  <div class="card">
    <div class="row">
      <label>Display Name
        <input id="name" placeholder="Your name">
      </label>
      <label>Payment cadence
        <select id="cadence">
          <option value="monthly">Monthly</option>
          <option value="biweekly">Bi-Weekly (26/yr)</option>
          <option value="weekly">Weekly (52/yr)</option>
          <option value="twicemonthly">Twice-Monthly (24/yr)</option>
        </select>
      </label>
    </div>
  </div>

  <!-- Income -->
  <div class="card" id="incomeCard">
    <h2>Income</h2>
    <p class="sub">Add each paycheck or income source (net / take-home).</p>

    <div id="incomeList"></div>

    <div style="margin-top:8px">
      <button class="btn" id="addIncome">+ Add Income Source</button>
    </div>

    <div class="totals">
      <b>Monthly Income Total:</b>
      <span id="incomeTotal" class="amt">$0.00</span>
    </div>
  </div>

  <!-- Essentials -->
  <div class="card" id="essentialsCard">
    <h2>Essentials</h2>
    <p class="sub">Add recurring monthly essentials (rent, utilities, insurance, etc.).</p>

    <div id="essentialsList"></div>

    <div style="margin-top:8px">
      <button class="btn" id="addEssential">+ Add Expense</button>
    </div>

    <div class="totals">
      <b>Monthly Essentials Total:</b>
      <span id="essentialsTotal" class="amt">$0.00</span>
    </div>
  </div>

  <!-- Debts -->
  <div class="card" id="debtsCard">
    <h2>Debts</h2>
    <p class="sub">
      Add debts to get an <b>‚ÄúAvalanche‚Äù</b> recommendation (highest APR first).
      If a debt has a term, we‚Äôll estimate its minimum payment; if not, we assume 2% minimum.
    </p>

    <div id="debtList"></div>

    <div style="margin-top:8px">
      <button class="btn" id="addDebt">+ Add Debt</button>
    </div>
  </div>

  <!-- Goal -->
  <div class="card" id="goalCard">
    <h2>Goal</h2>
    <p class="sub">You can still use Avalanche for debts while saving toward a goal ‚Äî we show free cash after essentials so you can split it.</p>
    <div class="row">
      <label>Goal Name
        <input id="goalName" placeholder="e.g., Car fund">
      </label>
      <label>Amount
        <input id="goalAmount" class="money" inputmode="decimal" placeholder="$0.00">
      </label>
      <label>Target date
        <input id="goalDate" type="date">
      </label>
    </div>
  </div>

  <!-- Summary -->
  <div class="card" id="summaryCard">
    <h2>Plan Summary</h2>
    <div class="pill" id="planLine">Plan: $0.00 income ‚Äì $0.00 essentials = $0.00 free cash.</div>

    <div class="pill">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <b>DEBT-TO-INCOME (DTI)</b>
        <b id="dtiPct">0%</b>
      </div>
      <div class="bar"><span id="dtiBar" style="width:0%"></span></div>
    </div>

    <div class="pill">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <b>GOAL PROGRESS</b>
        <b id="goalPct">0%</b>
      </div>
      <div class="bar"><span id="goalBar" style="width:0%"></span></div>
      <div id="goalLine" class="sub" style="margin-top:6px">$0.00 of $0.00 (0%)</div>
      <!-- NEW: concise per-pay suggestion -->
      <div id="goalAdvice" class="sub" style="margin-top:6px"></div>
    </div>

    <div class="pill" id="avalancheBox">
      <h3 style="margin:0 0 8px">Debt Recommendation (Avalanche)</h3>
      <div id="avalancheText" class="sub">Add at least one debt to see the recommendation.</div>
      <details class="sub" style="margin-top:8px">
        <summary>Why this?</summary>
        Avalanche prioritizes the highest APR debt. If a debt has a fixed term, we estimate its minimum using an amortization formula; otherwise we assume 2% of balance (min $25). Free cash after essentials and minimums goes to the highest APR until paid, then rolls to the next.
      </details>
    </div>
  </div>

  <!-- Tip jar -->
  <div class="card">
    <h2>Tip Jar</h2>
    <p class="sub">Optional one-time tips processed by Google Play (when available). Thanks for supporting H¬≥!</p>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn ghost" data-tip="tip_small">$1 Small Tip</button>
      <button class="btn ghost" data-tip="tip_medium">$3 Medium Tip</button>
      <button class="btn ghost" data-tip="tip_large">$5 Large Tip</button>
      <span id="tipState" class="sub" style="align-self:center"></span>
    </div>
  </div>

  <!-- footer -->
  <div class="footer">
    <div class="group">
      <button class="btn ghost" id="save">Save</button>
      <button class="btn ghost" id="share">Share</button>
      <button class="btn ghost" id="export">Export JSON</button>
    </div>
  </div>
</div>

<!-- Wizard overlay -->
<div class="overlay" id="overlay"></div>
<div class="wizard" id="wizard">
  <div class="sheet">
    <header>
      <div id="wizTitle" style="font-weight:800">Step</div>
      <button class="btn danger" id="wizExit">Exit</button>
    </header>
    <div class="body">
      <section class="step" id="s1">
        <h2>Income</h2><p class="sub">Add each paycheck or income source (net / take-home).</p>
        <div id="wizIncome"></div>
        <button class="btn" id="wizAddIncome">+ Add Income Source</button>
      </section>

      <section class="step" id="s2">
        <h2>Essentials</h2><p class="sub">Add recurring monthly essentials (rent, utilities, insurance, etc.).</p>
        <div id="wizEss"></div>
        <button class="btn" id="wizAddEss">+ Add Expense</button>
      </section>

      <section class="step" id="s3">
        <h2>Debts</h2><p class="sub">Add debts to get an <b>Avalanche</b> recommendation (highest APR first).</p>
        <div id="wizDebts"></div>
        <button class="btn" id="wizAddDebt">+ Add Debt</button>
      </section>

      <section class="step" id="s4">
        <h2>Goal</h2>
        <div class="row">
          <label>Goal Name <input id="wizGoalName" placeholder="e.g., Car fund"></label>
          <label>Amount <input id="wizGoalAmount" class="money" inputmode="decimal" placeholder="$0.00"></label>
          <label>Target date <input id="wizGoalDate" type="date"></label>
        </div>
      </section>

      <section class="step" id="s5">
        <h2>Review</h2>
        <div id="wizReview" class="sub"></div>
      </section>
    </div>
    <div class="nav">
      <button class="btn ghost" id="wizBack">Back</button>
      <button class="btn" id="wizNext">Next</button>
    </div>
  </div>
</div>

<script>
/* ---------- helpers ---------- */
const $ = q => document.querySelector(q);
const fmt = new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'});
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
const toNum = v => Number(String(v??'').replace(/[^0-9.-]/g,''))||0;
const escapeHTML = s => (s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

/* expand only money fields (name fields remain full-width) */
function moneyifyInput(el){
  function grow(){
    const s=document.createElement('span');
    s.style.visibility='hidden'; s.style.position='fixed'; s.style.whiteSpace='pre';
    s.style.font=getComputedStyle(el).font;
    s.textContent=el.value||el.placeholder||'';
    document.body.appendChild(s);
    const px=Math.min(el.parentElement.clientWidth-6, Math.max(90, s.getBoundingClientRect().width+24));
    el.style.width= px+'px';
    document.body.removeChild(s);
  }
  el.addEventListener('focus',()=>{ el.value=String(toNum(el.value)||''); grow(); });
  el.addEventListener('input',grow);
  el.addEventListener('blur',()=>{ el.value=fmt.format(toNum(el.value)); calc(); grow();});
  grow();
}

/* ---------- state ---------- */
let state = {
  name:'', cadence:'biweekly',
  income:[{name:'', perPay:0}],
  essentials:[{name:'', monthly:0}],
  debts:[{name:'', apr:0, balance:0, term:0}],
  goal:{name:'', amount:0, date:''}
};
const LSKEY='h3.budget.v1';

/* ---------- rows (shared for main + wizard) ---------- */
function incomeRow(i){
  const r=document.createElement('div'); r.className='row';
  r.innerHTML = `
    <input placeholder="Name" value="${state.income[i].name}">
    <input class="money" inputmode="decimal" placeholder="$0.00" value="${fmt.format(state.income[i].perPay)}">
    <div class="trash" title="Remove">üóë</div>`;
  const [name,per]=r.querySelectorAll('input');
  name.oninput=()=>{ state.income[i].name=name.value; save(); };
  moneyifyInput(per);
  per.onblur=()=>{ state.income[i].perPay=toNum(per.value); save(); calc(); };
  r.querySelector('.trash').onclick=()=>{ state.income.splice(i,1); render(); };
  return r;
}
function essentialRow(i){
  const r=document.createElement('div'); r.className='row two';
  r.innerHTML=`
    <input placeholder="Name" value="${state.essentials[i].name}">
    <input class="money" inputmode="decimal" placeholder="$0.00" value="${fmt.format(state.essentials[i].monthly)}">
    <div class="trash" title="Remove">üóë</div>`;
  const [name,amt]=r.querySelectorAll('input');
  name.oninput=()=>{ state.essentials[i].name=name.value; save(); };
  moneyifyInput(amt);
  amt.onblur=()=>{ state.essentials[i].monthly=toNum(amt.value); save(); calc(); };
  r.querySelector('.trash').onclick=()=>{ state.essentials.splice(i,1); render(); };
  return r;
}
function debtRow(i){
  const d=state.debts[i];
  const r=document.createElement('div'); r.className='row debt';
  r.innerHTML=`
    <input placeholder="Name" value="${d.name}">
    <div class="grid2">
      <input class="apr" inputmode="decimal" placeholder="APR %" value="${d.apr||''}">
      <input class="money bal" inputmode="decimal" placeholder="Balance" value="${fmt.format(d.balance)}">
      <div class="inline-last">
        <input class="term" inputmode="numeric" placeholder="Term (mo)" value="${d.term||''}">
        <div class="trash" title="Remove">üóë</div>
      </div>
    </div>`;
  const name = r.querySelector('input[placeholder="Name"]');
  const apr  = r.querySelector('.apr');
  const bal  = r.querySelector('.bal');
  const term = r.querySelector('.term');

  name.oninput =()=>{ d.name=name.value; save(); };
  apr.oninput  =()=>{ d.apr=toNum(apr.value); save(); calc(); };
  moneyifyInput(bal);
  bal.onblur   =()=>{ d.balance=toNum(bal.value); save(); calc(); };
  term.oninput =()=>{ d.term=toNum(term.value); save(); calc(); };

  r.querySelector('.trash').onclick=()=>{ state.debts.splice(i,1); render(); };
  return r;
}

/* build list into container (fresh DOM) */
function buildList(container, kind){
  const el=$(container); el.innerHTML='';
  const arr=state[kind];
  if (arr.length===0){
    if (kind==='income') arr.push({name:'',perPay:0});
    if (kind==='essentials') arr.push({name:'',monthly:0});
    if (kind==='debts') arr.push({name:'',apr:0,balance:0,term:0});
  }
  arr.forEach((_,i)=>{
    el.appendChild(
      kind==='income' ? incomeRow(i) :
      kind==='essentials' ? essentialRow(i) :
      debtRow(i)
    );
  });
}

/* ---------- calc & visuals ---------- */
function perYearFactor(){
  switch(state.cadence){
    case 'weekly': return 52;
    case 'biweekly': return 26;
    case 'twicemonthly': return 24;
    default: return 12;
  }
}
function incomeMonthly(){const f=perYearFactor();return state.income.reduce((s,x)=>s+(toNum(x.perPay)*(f/12)),0)}
function essentialsMonthly(){return state.essentials.reduce((s,x)=>s+toNum(x.monthly),0)}
function debtMinimum(d){
  const bal=toNum(d.balance), apr=toNum(d.apr), term=toNum(d.term);
  if (bal<=0) return 0;
  if (term>0){
    const r=(apr/100)/12;
    if (r===0) return bal/term;
    return (r*bal)/(1-Math.pow(1+r,-term));
  }
  return Math.max(25, bal*0.02);
}
const debtMinimums = ()=> state.debts.reduce((s,d)=>s+debtMinimum(d),0);
function avalanchePick(){
  const list=state.debts.filter(d=>toNum(d.balance)>0);
  if (!list.length) return null;
  return list.sort((a,b)=>toNum(b.apr)-toNum(a.apr))[0];
}

/* months between now and date (ceil, min 1) */
function monthsUntil(dateStr){
  const d = new Date(dateStr);
  const now = new Date();
  if (!dateStr || isNaN(d) || d <= now) return 0;
  const ms = d - now;
  const months = ms / (1000*60*60*24*(365.2425/12));
  return Math.max(1, Math.ceil(months));
}

function calc(){
  const inc=incomeMonthly(), ess=essentialsMonthly();
  $('#incomeTotal').textContent=fmt.format(inc);
  $('#essentialsTotal').textContent=fmt.format(ess);

  const mins=debtMinimums();
  const free=Math.max(0, inc - ess);
  $('#planLine').textContent=`Plan: ${fmt.format(inc)} income ‚Äì ${fmt.format(ess)} essentials = ${fmt.format(free)} free cash.`;

  const dti = inc>0 ? ((ess+mins)/inc)*100 : 0;
  $('#dtiPct').textContent=`${Math.round(dti)}%`;
  $('#dtiBar').style.width = clamp(dti,0,100)+'%';

  const goalAmt=toNum(state.goal.amount), saved=0;
  const gpct = goalAmt>0 ? Math.round((saved/goalAmt)*100):0;
  $('#goalPct').textContent=`${gpct}%`; $('#goalBar').style.width=gpct+'%';
  $('#goalLine').textContent=`${fmt.format(saved)} of ${fmt.format(goalAmt)} (${gpct}%)`;

  /* NEW: per-pay suggestion for the goal */
  let advice = '';
  const monthsLeft = monthsUntil(state.goal.date);
  if (!goalAmt){
    advice = '';
  } else if (!state.goal.date){
    advice = 'Set a target date to get a per-pay savings suggestion.';
  } else if (monthsLeft===0){
    advice = 'Pick a future target date to get a per-pay savings suggestion.';
  } else {
    const paysLeft = Math.ceil(monthsLeft * (perYearFactor()/12));
    const requiredPerPay = goalAmt / paysLeft;
    const requiredPerMonth = requiredPerPay * (perYearFactor()/12);
    const freePerPay = state.cadence==='monthly' ? free : (perYearFactor()/12>0 ? free/(perYearFactor()/12) : free);
    advice = `To reach <b>${escapeHTML(state.goal.name||'your goal')}</b> by ${new Date(state.goal.date).toLocaleDateString()}: save <b>${fmt.format(requiredPerPay)}</b> per pay (‚âà <b>${fmt.format(requiredPerMonth)}</b>/mo).`;
    if (requiredPerPay > freePerPay + 1e-6){
      advice += ` <span class="sub">Note: this exceeds your free cash (~${fmt.format(freePerPay)}/pay). Consider a later date or reducing expenses.</span>`;
    }
  }
  $('#goalAdvice').innerHTML = advice;

  const cadenceLabel={monthly:'Monthly',biweekly:'Bi-Weekly',weekly:'Weekly',twicemonthly:'Twice-Monthly'}[state.cadence]||'Monthly';
  const pick=avalanchePick();
  const perPay = state.cadence==='monthly' ? free : free/(perYearFactor()/12);

  let text = `Free cash after essentials: <b>${fmt.format(free)}</b> per month. `
           + `Estimated minimums: <b>${fmt.format(mins)}</b> per month. `
           + `Cadence: <b>${cadenceLabel}</b>.`;

  if (pick){
    const nameHTML = `<span class="neutral">${escapeHTML(pick.name||'highest-APR debt')}</span>`;
    text += `<p>Pay <b>${fmt.format(free)}</b> / mo (‚âà <b>${fmt.format(perPay)}</b> per pay) toward ${nameHTML} first (avalanche).</p>`;
  }else{
    text += `<p>Add at least one debt to see a recommendation.</p>`;
  }

  /* add goal advice into Review panel too */
  if (advice) text += `<p>${advice}</p>`;

  $('#avalancheText').innerHTML=text;
  $('#wizReview').innerHTML=text;

  save();
}

/* ---------- save / load / share ---------- */
const save = ()=> localStorage.setItem(LSKEY, JSON.stringify(state));
function load(){
  try{ const x=JSON.parse(localStorage.getItem(LSKEY)||'null'); if (x && typeof x==='object') state=Object.assign(state,x); }catch{}
}

/* ---------- render ---------- */
function render(){
  $('#name').value = state.name||'';
  $('#cadence').value = state.cadence;

  buildList('#incomeList','income');
  buildList('#essentialsList','essentials');
  buildList('#debtList','debts');

  // wizard mirrors
  buildList('#wizIncome','income');
  buildList('#wizEss','essentials');
  buildList('#wizDebts','debts');

  $('#goalName').value=state.goal.name||'';
  $('#goalAmount').value=fmt.format(state.goal.amount||0);
  $('#goalDate').value=state.goal.date||'';
  moneyifyInput($('#goalAmount'));

  $('#wizGoalName').value=state.goal.name||'';
  $('#wizGoalAmount').value=fmt.format(state.goal.amount||0);
  $('#wizGoalDate').value=state.goal.date||'';
  moneyifyInput($('#wizGoalAmount'));

  calc();
}

/* ---------- bind ---------- */
$('#name').oninput = ()=>{ state.name=$('#name').value; save(); };
$('#cadence').onchange = ()=>{ state.cadence=$('#cadence').value; calc(); };

$('#addIncome').onclick   = ()=>{ state.income.push({name:'',perPay:0}); render(); };
$('#addEssential').onclick= ()=>{ state.essentials.push({name:'',monthly:0}); render(); };
$('#addDebt').onclick     = ()=>{ state.debts.push({name:'',apr:0,balance:0,term:0}); render(); };

$('#goalName').oninput    = ()=>{ state.goal.name=$('#goalName').value; save(); };
$('#goalAmount').onblur   = ()=>{ state.goal.amount=toNum($('#goalAmount').value); calc(); };
$('#goalDate').onchange   = ()=>{ state.goal.date=$('#goalDate').value; save(); calc(); };

$('#wizGoalName').oninput = ()=>{ state.goal.name=$('#wizGoalName').value; $('#goalName').value=state.goal.name; save(); };
$('#wizGoalAmount').onblur= ()=>{ state.goal.amount=toNum($('#wizGoalAmount').value); $('#goalAmount').value=fmt.format(state.goal.amount); calc(); };
$('#wizGoalDate').onchange= ()=>{ state.goal.date=$('#wizGoalDate').value; $('#goalDate').value=state.goal.date; save(); calc(); };

$('#save').onclick   = ()=>{ save(); alert('Saved locally on this device.'); };
$('#export').onclick = ()=>{
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='h3-plan.json'; a.click();
};
$('#share').onclick  = ()=>{
  const url=new URL(location.href);
  url.hash=btoa(unescape(encodeURIComponent(JSON.stringify(state))));
  navigator.clipboard.writeText(url.toString()); alert('Share link copied.');
};

/* ---------- wizard ---------- */
let step=1;
function openWizard(){ step=1; updateStep(); $('#overlay').classList.add('show'); $('#wizard').classList.add('show'); }
function closeWizard(){ $('#overlay').classList.remove('show'); $('#wizard').classList.remove('show'); $('#guided').checked=false; }
function updateStep(){
  document.querySelectorAll('.step').forEach(s=>s.classList.remove('show'));
  $('#s'+step).classList.add('show');
  const titles={1:'Income (Step 1 of 5)',2:'Essentials (Step 2 of 5)',3:'Debts (Step 3 of 5)',4:'Goal (Step 4 of 5)',5:'Review (Step 5 of 5)'};
  $('#wizTitle').textContent=titles[step];
}
$('#guided').onchange=e=> e.target.checked ? openWizard() : closeWizard();
$('#wizExit').onclick=closeWizard;
$('#wizBack').onclick=()=>{ step=Math.max(1,step-1); updateStep(); };
$('#wizNext').onclick=()=>{ step=Math.min(5,step+1); updateStep(); };
$('#wizAddIncome').onclick=()=>{ state.income.push({name:'',perPay:0}); render(); };
$('#wizAddEss').onclick   =()=>{ state.essentials.push({name:'',monthly:0}); render(); };
$('#wizAddDebt').onclick  =()=>{ state.debts.push({name:'',apr:0,balance:0,term:0}); render(); };

/* ---------- Tip Jar (Digital Goods API) ---------- */
const PLAY_ORIGIN='https://play.google.com/billing';
async function setupTips(){
  const hint=$('#tipState');
  if (!('getDigitalGoodsService' in window)){
    hint.textContent='Tips require Google Play (not available in this browser).';
    document.querySelectorAll('[data-tip]').forEach(b=>b.disabled=true);
    return;
  }
  try{
    const dgs=await getDigitalGoodsService(PLAY_ORIGIN);
    const items=await dgs.listPurchasableItems(['tip_small','tip_medium','tip_large']);
    hint.textContent=items?.length ? 'Tip products loaded.' : 'Tip products unavailable.';
    async function buy(id){
      try{
        const details=await dgs.getDetails([id]);
        if(!details?.length) return alert('Product not available.');
        const p=await dgs.launchBillingFlow({itemId:id});
        if(p?.purchaseToken){ await dgs.acknowledge({purchaseToken:p.purchaseToken}); alert('Thanks for the tip! üôè'); }
      }catch{ alert('Purchase cancelled or failed.'); }
    }
    document.querySelectorAll('[data-tip]').forEach(b=> b.onclick=()=>buy(b.dataset.tip));
  }catch{
    hint.textContent='Play Billing not available.'; document.querySelectorAll('[data-tip]').forEach(b=>b.disabled=true);
  }
}

/* ---------- boot ---------- */
(function init(){
  try{
    if(location.hash.startsWith('#')){ const h=location.hash.slice(1); const json=JSON.parse(decodeURIComponent(escape(atob(h)))); Object.assign(state,json); }
  }catch{}
  load();
  render();
  setupTips();
})();
</script>
