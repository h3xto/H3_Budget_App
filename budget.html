<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>H³ Budget App</title>
  <meta name="theme-color" content="#097bf7">
  <meta name="description" content="H³ Budget App – simple, privacy-first budgeting for everyone">
  <link rel="icon" type="image/png" href="assets/icon-trend-blue.png">
  <!-- Print-friendly stylesheet is included via @media print rules inside <style> below -->
  <style>
    :root {
      --color-bg: #f9fafc;
      --color-fg: #091247;
      --color-accent: #097bf7;
      --color-card: #fff;
      --color-border: #dce2e8;
      --color-header: #097bf7;
      --color-section: #e8f0fa;
      --color-footer: #22263a;
      --color-danger: #f73939;
      --color-success: #0fa850;
      --color-warning: #f7a309;
      --color-muted: #838fa2;
      --color-link: #0966c2;
    }
    [data-theme="dark"] {
      --color-bg: #181c26;
      --color-fg: #f5f8fd;
      --color-accent: #81cafe;
      --color-card: #202432;
      --color-border: #2f344b;
      --color-header: #0d274b;
      --color-section: #232b3a;
      --color-footer: #10131c;
      --color-danger: #f27575;
      --color-success: #1fdba2;
      --color-warning: #f5c146;
      --color-muted: #69718f;
      --color-link: #61aaff;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Inter', system-ui, Arial, sans-serif;
      background: var(--color-bg);
      color: var(--color-fg);
      min-height: 100vh;
      transition: background 0.2s, color 0.2s;
    }
    body {
      min-height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-width: 320px;
    }
    /* Header */
    header {
      display: flex;
      align-items: center;
      padding: .8rem 1rem .8rem .8rem;
      background: var(--color-header);
      color: #fff;
      position: relative;
      user-select: none;
      box-shadow: 0 2px 8px 0 #09124718;
      z-index: 3;
    }
    #app-logo {
      height: 2.2rem;
      width: 2.2rem;
      margin-right: .92rem;
      border-radius: 12%;
      cursor: pointer;
      box-shadow: 0 1px 4px 0 #1237d840;
      transition: box-shadow .15s;
      background: #fff;
      object-fit: cover;
    }
    @media (max-width: 480px) {
      #app-logo { height: 2rem; width: 2rem; margin-right: .6rem; }
      header { padding: .6rem; }
    }
    h1 {
      font-size: 1.25rem;
      font-weight: 650;
      letter-spacing: 0.01em;
      margin: 0 .25rem 0 0;
      flex: 1 1 auto;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #theme-toggle {
      background: none;
      border: none;
      color: inherit;
      font-size: 1.25rem;
      margin-right: .1rem;
      cursor: pointer;
      padding: .5rem .7rem;
      line-height: 1;
      outline: none;
      border-radius: 8px;
      transition: background .15s;
    }
    #theme-toggle:hover, #theme-toggle:focus {
      background: #ffffff1d;
    }
    #github-link {
      display: flex;
      align-items: center;
      gap: 0.2rem;
      padding: 0 .5rem;
      color: inherit;
      text-decoration: none;
      margin-left: .1rem;
      border-radius: 8px;
      font-size: 1.2rem;
    }
    #github-link:hover {
      background: #fff2;
    }
    /* Main App Layout */
    main {
      background: var(--color-bg);
      padding: 1.6rem 1.4rem 2.6rem;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    @media (max-width: 768px) {
      main { padding: 1.3rem 0.3rem 2.6rem; }
    }
    section {
      background: var(--color-card);
      border-radius: 1.2rem;
      box-shadow: 0 2px 6px #0953a614;
      margin: 0 auto 1.65rem auto;
      max-width: 690px;
      width: 100%;
      padding: 1.2rem 1.5rem 1.3rem;
      border: 1.5px solid var(--color-border);
      position: relative;
      transition: background .13s;
    }
    section + section { margin-top: 0; }
    @media (max-width: 630px) {
      section {margin: 1rem auto 1.4rem auto; padding: 1.2rem 6px 1.2rem 5px; }
    }
    .section-title {
      font-size: 1.12rem;
      font-weight: 590;
      margin-bottom: .3rem;
      color: var(--color-accent);
      letter-spacing: 0.01em;
    }
    .section-desc {
      font-size: 1rem;
      color: var(--color-muted);
      margin-bottom: 0.6rem;
    }
    hr {
      border: 0;
      border-top: 1.5px solid var(--color-border);
      margin: 1rem 0 1.2rem 0;
      opacity: 0.65;
    }
    /* Budget Forms & Table Styles */
    .budget-form, .import-form {
      display: flex;
      flex-wrap: wrap;
      gap: .8rem;
      margin: 0 0 .4rem 0;
      align-items: flex-end;
      justify-content: flex-start;
    }
    .budget-form label,
    .import-form label {
      display: block;
      font-weight: 550;
      color: var(--color-fg);
      margin-bottom: .26rem;
      font-size: 1rem;
    }
    .budget-form input[type="text"], .budget-form input[type="number"], .budget-form select,
    .budget-form input[type="date"], .import-form input[type="file"], .import-form input[type="text"] {
      padding: .5rem .77rem;
      border: 1.5px solid var(--color-border);
      background: var(--color-bg);
      border-radius: 0.7rem;
      font-size: 1rem;
      color: var(--color-fg);
      margin-bottom: .07rem;
      min-width: 0;
      width: 100%;
      box-sizing: border-box;
      transition: border-color .16s;
    }
    .budget-form input[type="text"]:focus, .budget-form input[type="number"]:focus, .budget-form select:focus,
    .budget-form input[type="date"]:focus, .import-form input[type="file"]:focus {
      outline: none;
      border-color: var(--color-accent);
    }
    .budget-form button, .import-form button, .btn {
      background: var(--color-accent);
      color: #fff;
      border: none;
      padding: .53rem 1.15rem;
      border-radius: .65rem;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: .07rem;
      transition: background 0.12s, color 0.12s;
    }
    .btn-danger, .error {
      background: var(--color-danger) !important;
      color: #fff !important;
    }
    .btn-outline {
      background: transparent;
      border: 1.5px solid var(--color-accent);
      color: var(--color-accent);
    }
    .btn[disabled], .budget-form button[disabled] {
      opacity: 0.65 !important; cursor: not-allowed;
    }
    .budget-table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.1rem 0 0.5rem 0;
      font-size: 1.03rem;
      background: var(--color-card);
      border-radius: 1.1rem;
      overflow-x: auto;
    }
    .budget-table th, .budget-table td {
      border: none;
      padding: .55rem .5rem;
      text-align: left;
      vertical-align: middle;
    }
    .budget-table thead th {
      font-weight: 680;
      color: var(--color-accent);
      border-bottom: 2px solid var(--color-border);
      letter-spacing: 0.01em;
    }
    .budget-table tbody td {
      border-bottom: 1.2px solid var(--color-border);
    }
    .budget-table tbody tr:last-child td {
      border-bottom: none;
    }
    .budget-table [data-type="income"] { color: var(--color-success);}
    .budget-table [data-type="essential"] { color: var(--color-accent);}
    .budget-table [data-type="debt"] { color: var(--color-warning);}
    .budget-table [data-type="goal"] { color: var(--color-link);}
    .budget-table .del-btn { 
      background: transparent; 
      color: var(--color-danger); 
      font-size: 1rem; 
      padding: .05rem .9rem; 
      border: none; 
      cursor: pointer;
      border-radius: 6px;
      transition: background .12s;
    }
    .budget-table .del-btn:hover { background: #f7a6a6a8;}
    /* Projections and Progressbar */
    .proj-bar {
      display: flex;
      align-items: center;
      width: 100%;
      max-width: 330px;
      position: relative;
      height: 1.1rem;
      background: var(--color-border);
      border-radius: .5rem;
      margin: .68rem 0 1rem 0;
      overflow: hidden;
    }
    .proj-bar-fill {
      background: var(--color-success);
      height: 100%;
      border-radius: inherit;
      transition: width 0.5s;
    }
    .proj-bar-label {
      position: absolute;
      left: 48%;
      top: 50%;
      transform: translate(-50%,-50%);
      font-size: .93rem;
      font-weight: 590;
      color: var(--color-fg);
      z-index: 1;
      pointer-events: none;
    }
    /* Datalist, category filter */
    input[list] {
      background-repeat: no-repeat;
      background-position: right 0.5em top 50%;
      background-size: 1.2em auto;
    }
    datalist { display: none; }
    /* Footer */
    footer {
      background: var(--color-footer);
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-end;
      gap: .08rem;
      padding: .6rem 0 .36rem 0;
      font-size: 1rem;
      z-index: 3;
      position: relative;
    }
    .footer-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 1.8rem;
      width: 100%;
      margin-bottom: 0.09rem;
    }
    .footer-logo {
      height: 2.1rem; width: 2.1rem; margin: 0 .65rem 0 0;
      border-radius: 10%;
      object-fit: cover;
      background: #fff;
      cursor: pointer;
      box-shadow:0 1px 4px #09124738;
    }
    .support-links, .iap-links {
      display: flex;
      gap: 1.5rem;
      align-items: center;
      justify-content: center;
      margin: .2rem 0;
      flex-wrap: wrap;
    }
    .support-link,
    .iap-product-btn {
      display: inline-flex;
      align-items: center;
      gap: .46rem;
      background: #fff1;
      padding: .57rem .85rem;
      margin: .0rem;
      border-radius: .6rem;
      color: #fff;
      font-weight: 580;
      text-decoration: none;
      box-shadow: 0 1px 4px #09124714;
      font-size: 1.08rem;
      border: none;
      cursor: pointer;
      min-width: 88px;
      transition: background .15s, color .18s;
      outline: none;
    }
    .support-link:hover { background: #fff2; color: #cfffef;}
    .support-link img, .iap-product-btn img {
      width: 1.65rem;
      height: 1.65rem;
      object-fit: contain;
      margin-right: .32rem;
      border-radius: 7px;
      background: #fff;
      box-shadow: 0 1px 2px #19478326;
    }
    .iap-product-btn {
      justify-content: flex-start; gap: 0.6rem;
      font-size: 1rem;
      background: #277e2e20;
      border: 1.5px solid #fff5;
      color: #fff;
      font-weight: 600;
      min-width: 108px;
      margin-top: .15rem;
      transition: background .16s, border-color .17s;
    }
    .iap-product-btn.success {
      background: #139f2b;
      color: #fff;
      border-color: #139f2b;
      pointer-events: none;
    }
    .iap-icon {
      width: 2.02rem;
      height: 2.02rem;
      background: #fff;
      border-radius: .71rem;
      object-fit: contain;
      margin-right: .23rem;
      box-shadow: 0 1px 4px #3020f726;
    }
    .iap-thankyou {
      color: #fff;
      background: #1fbb4dc9;
      padding: .44rem 1.1rem;
      border-radius: .65rem;
      margin-left: .88rem;
    }
    .iap-fallback, .iap-disclaimer {
      color: #fffaa7;
      padding: .21rem 0 .2rem 1.6rem;
      font-size: .97rem;
      letter-spacing: .01em;
      text-align: left;
      font-weight: 400;
    }
    .iap-disclaimer { font-size: 1.01rem; }
    .thankyou-popup {
      position: fixed; left: 50%; top: 17%; z-index: 999;
      background: #1aad43ed; color: #fff;
      font-size:1.15rem; font-weight: 660;
      padding: 1.4rem 2.4rem;
      border-radius: 1.5rem;
      box-shadow: 0 2px 28px #21a91044;
      transform: translate(-50%, 0);
      animation: fadeinout 2.2s;
      pointer-events: none;
    }
    @keyframes fadeinout {
      0% {opacity:0;transform:translate(-50%,-60px);}
      22%{opacity:1;transform:translate(-50%,0);}
      68%{opacity:1;}
      100%{opacity:0;}
    }
    /* Guided Mode Overlay */
    .guided-overlay {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: 1200;
      background: rgba(18,30,60,.72);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      pointer-events: auto;
      animation: fadein .18s;
    }
    @keyframes fadein { from { opacity: 0; } to { opacity: 1; } }
    .guided-header {
      background: #fff;
      padding: 1.5rem 2.2rem 1.2rem 2.2rem;
      width: calc(min(95vw, 492px));
      margin-top: 3.5rem;
      border-radius: 1.3rem 1.3rem 1.1rem 1.1rem;
      color: var(--color-header);
      font-weight: 650;
      font-size: 1.16rem;
      box-shadow: 0 1px 8px #13286930;
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      gap: 1.04rem;
    }
    .guided-header .step-count {
      background: #3778ea;
      color:#fff;
      border-radius: .8rem;
      padding: .23em .86em;
      font-size: 1.08em;
      margin: .08rem .76rem 0 0;
      font-weight: 600;
      letter-spacing:.02em;
    }
    .guided-header .close-btn {
      margin-left: auto; 
      color: #263155;
      background: transparent;
      border: none; 
      font-size: 1.2rem; 
      cursor: pointer;
      border-radius: .4rem;
      padding: .3rem .7rem;
    }
    .guided-footer {
      background: #fff;
      position: fixed;
      bottom: 0;
      left: 0; width: 100vw;
      box-shadow: 0 -5px 36px #13286935;
      border-radius: 1.04rem 1.04rem 0 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1203;
      min-height: 3.3rem;
      padding: .7rem 0 .7rem 0;
    }
    .guided-footer .btn {
      margin: 0 .65rem;
      font-size: 1.06rem;
      font-weight: 600;
      padding: .59rem 1.22rem;
    }
    /* Logo Zoom Overlay */
    .logo-zoom-bg {
      position: fixed; z-index: 1500; left:0; top:0; width:100vw; height:100vh;
      background: rgba(24,30,78,.90);
      display: flex; align-items: center; justify-content: center;
      animation: fadein .21s;
    }
    .logo-zoom-img {
      display: block;
      max-width: 82vw;
      max-height: 78vh;
      border-radius: 1.5rem;
      box-shadow: 0 2px 34px #097bf7bb, 0 0 0 7px #fff5;
      transition: transform .29s;
    }
    .logo-zoom-close {
      position: fixed; z-index: 1502; top:2rem; right:3.2vw;
      background:#fff;
      color:#243579;
      font-size:1.7rem;
      border: none; border-radius:.75rem;
      padding:.6rem 1.2rem;
      cursor:pointer;
      font-weight: 600;
      box-shadow: 0 2px 20px #24357931;
    }
    @media (max-width: 768px) {
      .logo-zoom-close {right:1vw; top:.8rem; font-size:1.3rem;}
    }
    /* Error & Status Toasts */
    .toast {
      position: fixed;
      left: 50%;
      top: 15%;
      z-index: 1001;
      background: #ff3860;
      color: #fff;
      font-size: 1.08rem;
      font-weight: 590;
      padding: .96rem 2.1rem;
      border-radius: 1.04rem;
      transform: translate(-50%,0);
      box-shadow: 0 2px 13px #bf1b4573;
      animation: fadeinout 2.5s;
      pointer-events: none;
    }
    /* Print-only (appends to file for @media print) */
    @media print {
      header, .footer-row, #theme-toggle, #github-link, .support-links, .iap-links, .error, .btn, .del-btn, .guided-overlay, .logo-zoom-bg, .logo-zoom-close {
        display: none !important;
      }
      html, body { background: #fff !important; color: #000 !important; }
      section { background: #fff !important; color: #000 !important; box-shadow:none !important;}
      .budget-table th, .budget-table td { color: #000 !important; }
      main { padding: 0.2in 0.2in 0.18in 0.2in !important; }
      .proj-bar, .proj-bar-label, .proj-bar-fill { color: #000 !important; background: #e0e0e0 !important;}
      a[href]:after { content: " [" attr(href) "]"; }
    }
  </style>
  <!-- jsPDF and html2canvas for PDF export (CDN, current as of 2025) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

<header>
  <img id="app-logo" src="assets/icon-trend-blue.png" alt="H³ Budget App logo" title="Click to zoom" tabindex="0">
  <h1 title="H³ Budget App">H³ Budget App</h1>
  <button id="theme-toggle" title="Toggle light/dark mode" aria-label="Toggle theme">&#9788;</button>
  <a id="github-link" href="https://github.com/h3xto/budget-app" title="View on GitHub" target="_blank" rel="noopener noreferrer">
    <svg height="1.18em" viewBox="0 0 16 16" width="1.13em" style="margin-right:2px;vertical-align:sub;" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49C3.86 14.91 3.37 13.73 3.23 13.3c-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-2.22-.25-4.56-1.11-4.56-4.95 0-1.09.39-1.98 1.03-2.68-.1-.25-.45-1.27.1-2.65 0 0 .84-.27 2.75 1.03A9.56 9.56 0 018 3.3c.85.004 1.71.115 2.51.337 1.91-1.29 2.75-1.03 2.75-1.03.55 1.38.2 2.4.1 2.65.64.7 1.03 1.59 1.03 2.68 0 3.85-2.34 4.7-4.56 4.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
  </a>
</header>

<main id="main-content">
  <!-- Dynamic overlay header for Guided Mode injected here -->
  <!-- Sections: Budget input, essentials, debts, goals -->
  <section id="income-section">
    <div class="section-title">Income & Essentials</div>
    <div class="section-desc">Start by adding your monthly <b>income</b> and recurring <b>essential expenses</b> (e.g., rent, food, utilities). Use categories for better overview.</div>
    <form class="budget-form" id="income-form" autocomplete="off">
      <input type="text" id="income-cat" list="cat-datalist" placeholder="Category (e.g., Salary)" required>
      <datalist id="cat-datalist"></datalist>
      <input type="number" min="0" step="1" id="income-amt" placeholder="Amount" required>
      <button type="submit" class="btn">+ Add Income</button>
    </form>
    <form class="budget-form" id="essential-form" autocomplete="off">
      <input type="text" id="ess-cat" list="cat-datalist" placeholder="Essential (e.g., Rent)">
      <input type="number" min="0" step="1" id="ess-amt" placeholder="Amount" required>
      <button type="submit" class="btn">+ Add Expense</button>
    </form>
    <table class="budget-table" id="ess-table">
      <thead><tr>
        <th>Type</th><th>Category</th><th>Amount</th><th></th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="debts-section">
    <div class="section-title">Debts & Loans</div>
    <div class="section-desc">Track outstanding debts or loans. Include minimum payment and (optional) interest rate for accurate projections.</div>
    <form class="budget-form" id="debt-form" autocomplete="off">
      <input type="text" id="debt-cat" list="cat-datalist" placeholder="Debt (e.g., Credit Card)">
      <input type="number" min="1" step="1" id="debt-amt" placeholder="Total Owed" required>
      <input type="number" min="0" step="1" id="debt-min" placeholder="Min Pay't" required>
      <input type="number" min="0" step="0.01" id="debt-int" placeholder="Interest %" title="Annual interest rate">
      <button type="submit" class="btn">+ Add Debt</button>
    </form>
    <table class="budget-table" id="debt-table">
      <thead><tr>
        <th>Debt</th><th>Total</th><th>Min</th><th>Int%</th><th></th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="goals-section">
    <div class="section-title">Goals & Savings</div>
    <div class="section-desc">
      Create savings goals or plan future purchases. Set a target and an (optional) deadline to see progress and estimates.
    </div>
    <form class="budget-form" id="goal-form" autocomplete="off">
      <input type="text" id="goal-cat" list="cat-datalist" placeholder="Goal (e.g., Emergency Fund)">
      <input type="number" min="1" step="1" id="goal-amt" placeholder="Target Amount" required>
      <input type="date" id="goal-date" placeholder="Deadline (optional)">
      <button type="submit" class="btn">+ Add Goal</button>
    </form>
    <table class="budget-table" id="goal-table">
      <thead><tr>
        <th>Goal</th><th>Target</th><th>Saved</th><th>Est. Date</th><th></th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="proj-section">
    <div class="section-title">Projections & Analysis</div>
    <div class="section-desc">
      Your predicted progress for goals, payoff timelines, and discretionary spending at a glance. All estimates auto-update with every edit.
    </div>
    <div id="proj-summary"></div>
    <div class="proj-bar" style="margin-top:1.4rem;">
      <div class="proj-bar-fill" id="proj-bar-fill" style="width:0%"></div>
      <span class="proj-bar-label" id="proj-bar-label">0%</span>
    </div>
    <div id="proj-details" style="margin-top:.9rem;"></div>
  </section>

  <section id="history-section">
    <div class="section-title">Transaction History</div>
    <div class="section-desc">
      Track changes, manual entries, and replay budget modifications. Undo/redo actions anytime.
    </div>
    <table class="budget-table" id="trans-table">
      <thead>
        <tr><th>Date</th><th>Type</th><th>Category</th><th>Δ Amount</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="importexport-section">
    <div class="section-title">Import / Export / Print</div>
    <div class="section-desc">
      Download or restore your entire budget as CSV or PDF. Print a clean summary for your records.
    </div>
    <form class="import-form" id="import-form" enctype="multipart/form-data">
      <label for="import-csv">Restore from CSV</label>
      <input type="file" id="import-csv" accept=".csv,text/csv"/>
      <button type="button" class="btn" id="import-csv-btn">Import CSV</button>
      <span style="width:2em;"></span>
      <button type="button" class="btn" id="export-csv-btn">Export CSV</button>
      <button type="button" class="btn" id="export-pdf-btn">Export PDF</button>
      <button type="button" class="btn btn-outline" id="print-btn">Print</button>
    </form>
    <div id="import-export-status" class="section-desc"></div>
  </section>
</main>

<footer>
  <!-- Dynamic Support/IAP links or disclaimers inserted here by JS -->
  <div class="footer-row">
    <!-- App logo, support, IAP, links rendered dynamically -->
    <span id="footer-logo-area"></span>
    <span id="footer-support-area"></span>
  </div>
  <div style="text-align:center;margin-top:.22rem;font-size:.95em;opacity:.85">
    © <span id="curr-year"></span> <a href="https://github.com/h3xto/budget-app" style="color:#8effff;" target="_blank">HEXTO</a> | <a href="https://github.com/h3xto/budget-app" style="color:#f3b247;" target="_blank">Open Source</a>
  </div>
</footer>

<!-- LOGO ZOOM overlay (hidden by default, shown via JS) -->
<div id="logo-zoom-overlay" style="display:none;">
  <div class="logo-zoom-bg" tabindex="-1" role="dialog" aria-modal="true" aria-label="App logo">
    <img class="logo-zoom-img" src="assets/icon-trend-blue.png" alt="H³ Budget App" />
    <button class="logo-zoom-close" id="logo-zoom-close-btn" aria-label="Close">×</button>
  </div>
</div>

<!-- GUIDED MODE overlay (hidden by default, shown via JS) -->
<div id="guided-overlay" class="guided-overlay" style="display:none;">
  <div class="guided-header" id="guided-header">
    <!-- Step count, message, and dismiss injected by JS -->
  </div>
  <div style="flex:1;"></div>
  <div class="guided-footer" id="guided-footer">
    <!-- Next/prev/cancel btns injected -->
  </div>
</div>

<!-- Toast / Thank You Popup -->
<div id="thankyou-popup" class="thankyou-popup" style="display:none;"></div>
<div id="toast-msg" class="toast" style="display:none;"></div>

<script>
// ---- UTILITIES ----
function byId(id){ return document.getElementById(id);}
function showToast(msg, duration=2200){
  var toast = byId('toast-msg');
  toast.textContent = msg;
  toast.style.display="block";
  setTimeout(()=>{toast.style.display="none";}, duration);
}

// ---- THEME PERSISTENCE ----
(function(){
  const themeToggle = byId('theme-toggle');
  function applyTheme(mode){
    document.body.setAttribute('data-theme', mode);
    themeToggle.innerHTML = (mode==="dark") ? '&#9728;' : '&#9790;';
    themeToggle.title = (mode==="dark") ? "Switch to light mode" : "Switch to dark mode";
    window.localStorage.setItem("theme", mode);
  }
  function detectPrefTheme(){
    if(localStorage.getItem("theme")) return localStorage.getItem("theme");
    if(window.matchMedia('(prefers-color-scheme: dark)').matches) return "dark";
    return "light";
  }
  applyTheme(detectPrefTheme());
  themeToggle.onclick = function(){
    const curr = document.body.getAttribute('data-theme');
    applyTheme(curr=="dark" ? "light" : "dark");
  };
})();

// ---- LOGO ZOOM OVERLAY ----
(function(){
  const logoBtn = byId('app-logo'), zoomOverlay = byId('logo-zoom-overlay'),
    closeBtn = byId('logo-zoom-close-btn');
  function openOverlay(){
    zoomOverlay.style.display="block";
    closeBtn.focus();
  }
  function closeOverlay(){
    zoomOverlay.style.display="none";
    logoBtn.focus();
  }
  logoBtn.addEventListener('click', openOverlay);
  logoBtn.addEventListener('keydown', (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault();openOverlay(); }});
  closeBtn.onclick = closeOverlay;
  zoomOverlay.onclick = function(e){
    if(e.target===zoomOverlay||e.target===closeBtn) closeOverlay();
  };
  document.addEventListener("keydown", (e)=>{
    if(zoomOverlay.style.display==="block"&&(e.key==="Escape"||e.key==="Esc"))
      closeOverlay();
  });
})();

// ---- DYNAMIC YEAR IN FOOTER ----
byId('curr-year').textContent = String(new Date().getFullYear());

// ---- CSV, PDF EXPORT/IMPORT HANDLERS ----
(function(){
  // Budget state and serialization
  let budgetData = { income: [], essentials: [], debts: [], goals: [], transactions: [] };
  function serializeCSV(){
    let csv = [["Type","Category","Amount","Extra1","Extra2","Date"]];
    let combine = (_arr, typ) => _arr.map(entry=>{
      if(typ=="income") return [typ, entry.cat, entry.amt, "", "", entry.date||""];
      if(typ=="essentials") return [typ, entry.cat, entry.amt, "", "", entry.date||""];
      if(typ=="debts") return [typ, entry.cat, entry.amt, entry.min||"", entry.intRate||"", entry.date||""];
      if(typ=="goals") return [typ, entry.cat, entry.amt, entry.deadline||"", entry.saved||"", entry.date||""];
      return [];
    });
    ["income","essentials","debts","goals"].forEach(t=>{
      csv = csv.concat(combine(budgetData[t], t));
    });
    return csv.map(row=>row.map(v=>'"'+(v||"").replace(/"/g,'""')+'"').join(",")).join("\r\n");
  }
  function downloadFile(content, filename, mime){
    let blob = new Blob([content], {type: mime});
    let a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download=filename;
    a.style.display="none";
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{document.body.removeChild(a);},1116);
  }
  // EXPORT CSV
  byId('export-csv-btn').onclick = function(){
    downloadFile(serializeCSV(), "h3-budget.csv", "text/csv");
    showToast("Budget CSV exported.");
  };
  // PDF EXPORT/PRINT
  byId('export-pdf-btn').onclick = function(){
    let doc = window.jspdf.jsPDF ? new window.jspdf.jsPDF({unit:'pt'}) : new jsPDF({unit:'pt'});
    html2canvas(document.body, {backgroundColor:null, useCORS:true}).then(function(canvas){
      const imgData = canvas.toDataURL('image/png');
      doc.addImage(imgData, 'PNG', 18, 18, doc.internal.pageSize.getWidth()-36, 0);
      doc.save('h3-budget.pdf');
    });
    showToast("PDF download started.");
  };
  byId('print-btn').onclick = function(){ window.print(); };
  // IMPORT CSV
  byId('import-csv-btn').onclick = function(){
    let file = byId('import-csv').files[0];
    if(!file){showToast("No file selected!");return;}
    let reader = new FileReader();
    reader.onload = function(e){
      let rows = e.target.result.split(/\r?\n/).map(s=>s.split(","));
      // Skipping header, map to budgetData, simple
      if(rows.length<2){ showToast("File too short!");return;}
      try{
        let newData = { income:[], essentials:[], debts:[], goals:[], transactions:[]};
        rows.slice(1).forEach(row=>{
          let [typ,cat,amt,e1,e2,date] = row.map(s=>s.replace(/^"|"$/g,"").replace(/""/g,'"'));
          if(typ=="income") newData.income.push({cat, amt:Number(amt), date});
          else if(typ=="essentials") newData.essentials.push({cat,amt:Number(amt),date});
          else if(typ=="debts") newData.debts.push({cat, amt:Number(amt), min:Number(e1)||0, intRate:Number(e2)||0, date});
          else if(typ=="goals") newData.goals.push({cat, amt:Number(amt), deadline:e1, saved:Number(e2)||0, date});
        });
        budgetData = newData;
        showToast("Budget restored from CSV.");
        renderAll(); // update UI
      } catch(e){
        showToast("File import error!");
      }
    };
    reader.readAsText(file);
  };
})();

// ---- BUDGET LOGIC, PROJECTIONS ----
(function(){
  // Example default state for demo if empty
  let budgetData = window.budgetData = {
    income: [ {cat:"Salary",amt:3500,date:""}, {cat:"Freelance",amt:800,date:""} ],
    essentials: [ {cat:"Rent",amt:1200,date:""}, {cat:"Groceries",amt:400,date:""}, {cat:"Utilities",amt:105,date:""} ],
    debts: [ {cat:"Credit Card",amt:2200,min:55,intRate:15.9,date:""}, {cat:"Student Loan",amt:13000,min:170,intRate:5.2,date:""} ],
    goals: [ {cat:"Emergency Fund",amt:2000,saved:500,deadline:""}, {cat:"Vacation",amt:1800,saved:200,deadline:""} ],
    transactions: []
  };
  const catSet = new Set();
  function gatherCategories(){
    ["income","essentials","debts","goals"].forEach(t=>{
      for(let it of budgetData[t]) if(it.cat) catSet.add(it.cat);
    });
    let datalist = byId('cat-datalist');
    datalist.innerHTML = "";
    Array.from(catSet).sort().forEach(cat=>{
      let opt = document.createElement('option');
      opt.value = cat;
      datalist.appendChild(opt);
    });
  }
  function addIncome(evt){
    evt.preventDefault();
    let cat = byId('income-cat').value.trim(), amt = Number(byId('income-amt').value.trim());
    if(!cat||!amt||amt<1){ showToast("Valid income required"); return;}
    budgetData.income.push({cat,amt,date:new Date().toISOString().slice(0,10)});
    byId('income-cat').value=""; byId('income-amt').value="";
    budgetData.transactions.unshift({type:"income",cat,amt,delta:amt,date:new Date().toLocaleDateString()});
    renderAll();
  }
  function addEssential(evt){
    evt.preventDefault();
    let cat = byId('ess-cat').value.trim(), amt = Number(byId('ess-amt').value.trim());
    if(!cat||!amt||amt<1){ showToast("Expense required"); return;}
    budgetData.essentials.push({cat,amt,date:new Date().toISOString().slice(0,10)});
    byId('ess-cat').value=""; byId('ess-amt').value="";
    budgetData.transactions.unshift({type:"essential",cat,amt:amt,delta:-amt,date:new Date().toLocaleDateString()});
    renderAll();
  }
  function addDebt(evt){
    evt.preventDefault();
    let cat = byId('debt-cat').value.trim(), amt = Number(byId('debt-amt').value.trim());
    let min = Number(byId('debt-min').value.trim())||0, ir = Number(byId('debt-int').value.trim())||0;
    if(!cat||!amt||amt<1||!min){ showToast("Valid debt info required"); return;}
    budgetData.debts.push({cat,amt,min,intRate:ir,date:new Date().toISOString().slice(0,10)});
    [ 'debt-cat','debt-amt','debt-min','debt-int' ].forEach(id=>byId(id).value="");
    budgetData.transactions.unshift({type:"debt",cat,amt,delta:-min,date:new Date().toLocaleDateString()});
    renderAll();
  }
  function addGoal(evt){
    evt.preventDefault();
    let cat = byId('goal-cat').value.trim(), amt = Number(byId('goal-amt').value.trim());
    let deadline = byId('goal-date').value, saved = 0;
    if(!cat||!amt||amt<1){ showToast("Set goal/target!"); return;}
    budgetData.goals.push({cat,amt,deadline:safeDate(deadline),saved,date:new Date().toISOString().slice(0,10)});
    byId('goal-cat').value=""; byId('goal-amt').value=""; byId('goal-date').value="";
    budgetData.transactions.unshift({type:"goal",cat,amt,delta:0,date:new Date().toLocaleDateString()});
    renderAll();
  }
  // Utility
  function safeDate(str){ if(!str||str.length<4) return ""; return str; }
  function fiat(val){ return "$"+(+val).toLocaleString(undefined,{maximumFractionDigits:0}); }
  // Renderers
  function renderTable(arr, tbody, cols){
    tbody.innerHTML="";
    arr.forEach((entry,i)=>{
      let row = document.createElement('tr');
      for(let col of cols){
        let td=document.createElement('td');
        let val = entry[col.key] || (col.calc?col.calc(entry):"");
        td.textContent = val;
        if(col.type) td.setAttribute('data-type',col.type);
        row.appendChild(td);
      }
      // Del btn
      let td = document.createElement('td');
      let btn = document.createElement('button');
      btn.className="del-btn";
      btn.innerHTML="&#10005;";
      btn.title="Remove";
      btn.onclick = ()=>{ arr.splice(i,1); renderAll(); };
      td.appendChild(btn); row.appendChild(td);
      tbody.appendChild(row);
    });
  }
  function renderIncomeEss(){
    byId('ess-table').querySelector("tbody").innerHTML = "";
    let tbody = byId('ess-table').querySelector("tbody");
    let all = budgetData.income.map(e=>({...e, type:"Income"}))
      .concat(budgetData.essentials.map(e=>({...e, type:"Essential"})));
    all.forEach((entry,i)=>{
      let tr = document.createElement('tr');
      let typ = entry.type=="Income"? "income":"essential";
      tr.innerHTML = `<td data-type="${typ}">${entry.type}</td>
        <td>${entry.cat}</td><td>${fiat(entry.amt)}</td>
        <td><button class="del-btn" title="Delete">&#10005;</button></td>`;
      tr.querySelector(".del-btn").onclick = ()=>{
        if(typ=="income") budgetData.income.splice(i,1);
        else budgetData.essentials.splice(i-budgetData.income.length,1);
        renderAll();
      };
      tbody.appendChild(tr);
    });
  }
  function renderDebts(){
    renderTable(budgetData.debts, byId('debt-table').querySelector("tbody"),
      [{key:'cat'},{key:'amt',calc:e=>fiat(e.amt)},{key:'min',calc:e=>fiat(e.min)},{key:'intRate'}]
    );
  }
  function renderGoals(){
    renderTable(budgetData.goals, byId('goal-table').querySelector("tbody"),
      [{key:'cat'},{key:'amt',calc:e=>fiat(e.amt)},{key:'saved',calc:e=>e.saved?fiat(e.saved):"$0"},
        {key:'deadline',calc:e=>e.deadline||"--"}]
    );
  }
  function renderTrans(){
    let tbody=byId('trans-table').querySelector("tbody");
    tbody.innerHTML = "";
    budgetData.transactions.slice(0,10).forEach((t,i)=>{
      // show last 10
      let row = document.createElement('tr');
      row.innerHTML = `<td>${t.date||""}</td>
      <td data-type="${t.type||""}">${capitalize(t.type||"-")}</td>
      <td>${t.cat||""}</td>
      <td>${t.delta < 0 ? '-' : '+'}${fiat(Math.abs(t.delta||t.amt||0))}</td>
      <td><button class="del-btn" title="Undo">&#8630;</button></td>`;
      row.querySelector('.del-btn').onclick=()=>{ budgetData.transactions.splice(i,1); renderAll();};
      tbody.appendChild(row);
    });
  }
  function renderProj(){
    // Compute available income, expenses, etc.
    let income = budgetData.income.reduce((s,e)=>s+e.amt,0),
      essentials = budgetData.essentials.reduce((s,e)=>s+e.amt,0),
      debtMin = budgetData.debts.reduce((s,e)=>s+e.min,0),
      debtTotal = budgetData.debts.reduce((s,e)=>s+e.amt,0),
      goalTotal = budgetData.goals.reduce((s,e)=>s+e.amt,0),
      discretionary = income - (essentials + debtMin),
      summary = `Available after essentials/debts: <b>${fiat(discretionary)}</b><br>`;
    let rem = income-essentials-debtMin, goalProgress=0, filled=100;
    if(budgetData.goals.length>0){
      let saved=budgetData.goals.reduce((s,e)=>s+(e.saved||0),0);
      goalProgress = (saved/goalTotal*100)|0;
      summary += `You have saved <b>${fiat(saved)}</b> toward <b>${fiat(goalTotal)}</b> in goals (${goalProgress}%). <br>`;
      filled=goalProgress;
    }
    summary += `Minimum due on all debts this month: <b>${fiat(debtMin)}</b>.`;
    byId('proj-summary').innerHTML = summary;
    byId('proj-bar-fill').style.width=filled+"%";
    byId('proj-bar-label').textContent = filled+"%";
    // Details
    let dt = "";
    if(budgetData.debts.length>0){
      let payoffMonths = budgetData.debts.map(debt=>{
        if(!debt.min||debt.min<1)return`--`;
        let months = Math.ceil(debt.amt/debt.min);
        return `<b>${months}</b> mo (<span>${debt.cat}</span>)`;
      }).join(', ');
      dt+=`<span style="color:var(--color-warning);">Debt payoff (min payments): ${payoffMonths}</span><br>`;
    }
    if(budgetData.goals.length>0){
      budgetData.goals.forEach(goal=>{
        let rem=goal.amt-(goal.saved||0||(0)), perMonth=discretionary>0?(discretionary/budgetData.goals.length):0;
        let months = perMonth>0?Math.ceil(rem/perMonth):"--";
        dt+=`Goal <b>${goal.cat}</b>: <b>${fiat(rem)}</b> left, est.<b> ${months} mo.</b><br>`;
      });
    }
    byId('proj-details').innerHTML = dt;
  }
  function renderAll(){
    catSet.clear();
    gatherCategories();
    renderIncomeEss(); renderDebts(); renderGoals(); renderTrans(); renderProj();
  }
  function capitalize(str){return str.slice(0,1).toUpperCase()+str.slice(1);}
  // Add handlers for forms
  byId('income-form').onsubmit = addIncome;
  byId('essential-form').onsubmit = addEssential;
  byId('debt-form').onsubmit = addDebt;
  byId('goal-form').onsubmit = addGoal;
  renderAll();
})();

// ---- DATALIST FILTER (Fuzzy Match for Multiple Words) ----
(function(){
  // All fields using datalist use the global gatherCategories (called during renderAll)
  // For improved UX, in all fields listening to input event, filter by matching any token:
  let fields = [byId('income-cat'),byId('ess-cat'),byId('debt-cat'),byId('goal-cat')];
  fields.forEach(fld => {
    fld.addEventListener('input', function(){
      let val = fld.value.toLowerCase();
      let opts = Array.from(byId('cat-datalist').children);
      for(let opt of opts){
        opt.disabled = val.split(' ').some(tok=>
          !opt.value.toLowerCase().includes(tok)
        );
      }
    });
  });
})();

// ---- PRINT MEDIA: auto triggers on user action; handled by btn ---

// ---- GUIDED MODE OVERLAY SKELETON (hooks for future expansion) ----
(function(){
  let guidedModeActive = false;
  // For extension: stepwise messages, overlays, etc.
  // Controlled by byId('guided-overlay'), shown when guidedModeActive.
})();

// ---- PLAY STORE BUILD DETECTION + SUPPORT/IN-APP PURCHASE UI ----
(function(){
  /* Build detection: Show IAP section in Play Store build (Android+standalone+Chrome+Digital Goods API), otherwise show payment service links. */
  function isAndroid(){ return /Android/i.test(navigator.userAgent); }
  function isStandalone(){ return (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone || document.referrer.startsWith('android-app://')); }
  function isChrome(){ return /Chrome\//i.test(navigator.userAgent)&&(navigator.vendor||"").includes("Google"); }
  function hasDigitalGoodsApi(){ return 'getDigitalGoodsService' in window;}
  function isPlayStoreBuild(){
    return isAndroid() && isStandalone() && isChrome() && hasDigitalGoodsApi();
  }
  /* Payment Services (Web build only): CashApp, PayPal, Venmo. */
  const paymentLinks = [
    {label:"CashApp",icon:"assets/icon-cashapp.png",url:"https://cash.app/$h3xto"},
    {label:"PayPal",icon:"assets/icon-paypal.png",url:"https://paypal.me/h3xto"},
    {label:"Venmo",icon:"assets/icon-venmo.png",url:"https://www.venmo.com/u/HEXTO"}
  ];
  /* Trend icons for Play Store IAP tips */
  const iapProducts = [
    {id:"tip_small",label:"$1 Tip",icon:"assets/icon-trend-green.png",color:"#1ad11a"},
    {id:"tip_medium",label:"$3 Tip",icon:"assets/icon-trend-blue.png",color:"#1090f5"},
    {id:"tip_large",label:"$5 Tip",icon:"assets/icon-trend-orange.png",color:"#f69720"}
  ];
  /* Build the support/payment UI accordingly */
  function renderSupportFooter(){
    let logoArea=byId('footer-logo-area'), supportArea=byId('footer-support-area');
    logoArea.innerHTML='<img class="footer-logo" src="assets/icon-trend-blue.png" alt="Logo" title="Click to zoom" tabindex="0">';
    logoArea.firstElementChild.onclick=()=>byId('app-logo').click();
    let inPlayStore=isPlayStoreBuild();
    // In Play Store: show IAP, hide payment links entirely
    if(inPlayStore){
      let out = `<div class="iap-links" id="iap-links">`;
      iapProducts.forEach((p,i)=>{
        out += `<button class="iap-product-btn" data-id="${p.id}" tabindex="0" title="${p.label}">
           <img class="iap-icon" src="${p.icon}" alt="">${p.label}
        </button>`;
      });
      out += `</div>
      <div class="iap-disclaimer" style="margin-top:.45rem;">Paying does not unlock or add any features or functionality to the app. It only helps keep the app completely ad‑free and support the developer.</div>
      <div class="iap-fallback" id="iap-fallback-msg" style="display:none;">In-app purchases may not be available on this device/version. Please try again later.</div>
      `;
      supportArea.innerHTML = out;
      // Add IAP handlers
      for(let btn of document.querySelectorAll('.iap-product-btn')){
        btn.onclick = function(){
          let pId = btn.getAttribute('data-id');
          handleIAPurchase(pId, btn);
        };
      }
      // Digital Goods API fallback
      if(!hasDigitalGoodsApi()){
        byId('iap-fallback-msg').style.display="";
      }
    } else {
      // On Web build, show payment services/links
      let out = '<div class="support-links">';
      for(let p of paymentLinks){
        out += `<a class="support-link" href="${p.url}" target="_blank" rel="noopener">
          <img src="${p.icon}" alt="${p.label}" />${p.label}
        </a>`;
      }
      out +='</div><div class="iap-disclaimer" style="margin-top:.26rem;color:#fff8cf;">Thanks for supporting development! 100% open source, ad-free. </div>';
      supportArea.innerHTML = out;
      // Hide payment links from Play Store per policy. (Should never get here in proper Play build)
    }
  }
  // Digital Goods API + PaymentRequest flow
  async function handleIAPurchase(productId, btn){
    if(!hasDigitalGoodsApi()){
      showToast("In-app purchases not supported here.");
      return false;
    }
    // Get DG Service
    try {
      const service = await window.getDigitalGoodsService("https://play.google.com/billing");
      // Query details for the given product
      const details = await service.getDetails([productId]);
      if(!details.length){ showToast("Purchase unavailable."); return false;}
      // Create PaymentRequest
      const pr = new window.PaymentRequest([
        {supportedMethods:"https://play.google.com/billing",data:{sku:productId}}
      ]);
      pr.show().then(paymentResp=>{
        // Confirm purchase (no actual entitlement to deliver, just tip)
        // Consume purchase if needed (DG API), but only for consumables.
        showThankYou(); btn.classList.add("success");
        btn.disabled=true; btn.innerHTML="Thank you!";
        setTimeout(()=>btn.classList.remove("success"),2600);
        paymentResp.complete('success');
      }).catch(err=>{ showToast("Purchase cancelled."); });
    } catch(e) {
      showToast("In-app purchase error!");
      byId('iap-fallback-msg').style.display="";
    }
  }
  function showThankYou(){
    let popup = byId('thankyou-popup');
    popup.textContent="Thank you for supporting ad-free open source!";
    popup.style.display="block";
    setTimeout(()=>{popup.style.display="none";}, 2300);
  }
  renderSupportFooter();
  // Re-check build on page visibility change
  document.addEventListener('visibilitychange', renderSupportFooter);
})();
</script>

</body>
</html>
