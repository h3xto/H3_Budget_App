<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>H³ Budget Tool</title>
  <meta name="theme-color" content="#0f172a" />
  <link rel="icon" href="https://github.com/h3xto/H3_Budget_App/blob/main/icons/app-h3-cube-contrast-Hwhite.svg?raw=true" />
  <style>
    /* ---- Design system (dark and light) ---- */
    :root {
      --bg: #0b0f19;
      --panel: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --primary: #60a5fa;
      --accent: #34d399;
      --warn: #fbbf24;
      --danger: #f87171;
      --border: #1f2937;
      --shadow: 0 6px 18px rgba(0,0,0,0.35);
      --input: #0f172a;
      --chip: #0b1220;
      --radius: 14px;
      --radius-sm: 10px;
      --radius-lg: 18px;
    }
    :root[data-theme="light"] {
      --bg: #f7fafc;
      --panel: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --primary: #2563eb;
      --accent: #059669;
      --warn: #b45309;
      --danger: #b91c1c;
      --border: #e5e7eb;
      --shadow: 0 6px 18px rgba(0,0,0,0.06);
      --input: #f1f5f9;
      --chip: #eef2ff;
    }

    /* ---- Base ---- */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 15px/1.5 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .app { max-width: 820px; margin: 0 auto; padding: 12px 12px 80px; }

    /* ---- Header ---- */
    header {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 12px;
      align-items: center;
      padding: 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: saturate(1.2) blur(8px);
    }
    header img.logo {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      display: block;
      cursor: zoom-in;
      transition: transform .2s ease, box-shadow .2s ease;
      box-shadow: 0 2px 10px rgba(0,0,0,.25);
      background: #fff;
    }
    header img.logo:hover { transform: translateY(-1px); }
    .title { display: flex; flex-direction: column; gap: 2px; }
    .title .name { font-weight: 900; letter-spacing: 0.2px; font-size: 22px; line-height: 1.2; }
    .title .motto { color: var(--muted); font-size: 12px; letter-spacing: 0.3px; }
    .controls { display: flex; gap: 8px; align-items: center; }

    /* Theme toggle */
    #themeToggle {
      width: 38px;
      height: 38px;
      padding: 0;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: conic-gradient(#000 0 50%, #fff 50% 100%);
      box-shadow: var(--shadow);
      cursor: pointer;
    }
    :root[data-theme="light"] #themeToggle {
      background: conic-gradient(#0f172a 0 50%, #f8fafc 50% 100%);
    }
    #themeToggle:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }

    .chip {
      background: var(--chip); border: 1px solid var(--border); color: var(--text);
      border-radius: 999px; padding: 8px 12px; font-weight: 700; cursor: pointer;
    }
    .chip.primary { background: var(--primary); color: #fff; border: none; }
    .chip.ghost { background: transparent; }

    /* ---- Sections ---- */
    .section {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-top: 14px;
      padding: 12px;
      box-shadow: var(--shadow);
    }
    .section h2 {
      margin: 0 0 10px;
      font-size: 16px;
      display: flex; justify-content: space-between; align-items: center;
    }

    /* ---- Layout ---- */
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .row-4 { display: grid; grid-template-columns: 1.2fr .8fr .8fr .8fr; gap: 10px; }
    .row-5 { display: grid; grid-template-columns: 1fr .8fr .8fr .8fr .6fr; gap: 10px; }
    @media (max-width: 520px) {
      .row, .row-3, .row-4, .row-5 { grid-template-columns: 1fr; }
    }

    /* ---- Form ---- */
    label { display: flex; flex-direction: column; gap: 6px; font-size: 12px; color: var(--muted); }
    input, select, button {
      border: 1px solid var(--border);
      background: var(--input);
      color: var(--text);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      font-size: 15px;
    }
    input::placeholder { color: #8b97a8; }
    button.add { background: var(--primary); color: #fff; border: none; }
    button.minor { background: transparent; }
    .right { text-align: right; }

    /* ---- Collections ---- */
    .list { display: flex; flex-direction: column; gap: 10px; margin-top: 8px; }
    .card {
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
      border-radius: var(--radius);
      padding: 10px;
      display: grid; gap: 8px;
    }
    .line { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }

    /* ---- Text & badges ---- */
    .mono { font-variant-numeric: tabular-nums; font-feature-settings: "tnum"; }
    .muted { color: var(--muted); }
    .ok { color: var(--accent); }
    .danger { color: var(--danger); }
    .warn { color: var(--warn); }
    .totals { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 6px; }
    .badge {
      background: var(--chip); border: 1px solid var(--border);
      padding: 6px 10px; border-radius: 999px; font-weight: 800; font-size: 12px;
    }

    /* ---- Summary & KPIs ---- */
    .grid-2 { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 680px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
    .kpi { border: 1px dashed var(--border); border-radius: var(--radius); padding: 10px; background: rgba(255,255,255,0.02); }
    .kpi h3 { margin: 0 0 6px; font-size: 14px; }

    /* ---- Tip Jar ---- */
    .tip-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 16px;
      width: 100%;
      align-items: stretch;
    }
    .tip-col.brand {
      flex: 1 1 30%;
      max-width: 32%;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      text-align: center;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }
    .tip-col.brand img {
      width: 80px;
      height: 80px;
      object-fit: contain;
      background: transparent;
      border-radius: 10px;
    }
    .tip-info { display: flex; flex-direction: column; gap: 6px; align-items: center; }
    .nowrap { white-space: nowrap; }

    @media (max-width: 600px) {
      .tip-col.brand { flex: 1 1 100%; max-width: 100%; }
    }
    .hide { display: none !important; }

    /* ---- Guided Mode ---- */
    #guidedControls {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 20;
      background: rgba(17,24,39,0.98);
      border-top: 1px solid var(--border);
      padding: 8px 12px;
      display: none;
    }
    #guidedControls.show { display: block; }
    .guided-dim .section { opacity: 0.12; filter: blur(1px); transition: opacity .15s ease; }
    .guided-focus { opacity: 1 !important; filter: none !important; }
    .guided-hint { color: var(--muted); font-size: 12px; }

    /* ---- Print/PDF view ---- */
    @media print {
      header, #themeToggle, #playTips, #webTips, #guidedControls { display: none !important; }
      body { background: #fff; color: #000; }
      .section { break-inside: avoid; box-shadow: none; border-color: #ccc; }
    }

    /* ---- Logo zoom overlay ---- */
    #logoOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      cursor: zoom-out;
    }
    #logoOverlay.show { display: flex; }
    #logoOverlay img {
      max-width: 80vw;
      max-height: 80vh;
      border-radius: 16px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
      background: #fff;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <img
        class="logo"
        id="logoImg"
        src="https://github.com/h3xto/H3_Budget_App/blob/main/icons/app-h3-cube-contrast-Hwhite.svg?raw=true"
        alt="H3 Logo" />
      <div class="title">
        <div class="name">H³ Budget Tool</div>
        <div class="motto">Private • Goal‑Focused • Offline</div>
      </div>
      <div class="controls">
        <button id="guidedToggle" class="chip ghost" type="button" aria-pressed="false" title="Step-by-step mode">Guided</button>
        <button id="themeToggle" class="chip" type="button" aria-label="Toggle theme"></button>
      </div>
    </header>

    <!-- Profile & cadence -->
    <div class="section" id="profileSec">
      <h2>Profile & cadence</h2>
      <div class="row">
        <label>Display name
          <input id="displayName" placeholder="Name for your plan" />
        </label>
        <label>Pay cadence
          <select id="cadence">
            <option value="52">Weekly (52/yr)</option>
            <option value="26">Bi‑Weekly (26/yr)</option>
            <option value="24">Bi‑Monthly (24/yr)</option>
          </select>
        </label>
      </div>
    </div>

    <!-- Income -->
    <div class="section" id="incomeSec">
      <h2>
        Income
        <span>
          <button class="chip ghost" id="filterIncome" type="button" disabled>All</button>
          <button class="chip" id="addIncome" type="button">+ Add income</button>
        </span>
      </h2>
      <div id="incomeList" class="list"></div>
      <div class="totals">
        <div class="badge">Monthly income: <span id="incomeTotal" class="mono">$0.00</span></div>
      </div>
    </div>

    <!-- Essentials -->
    <div class="section" id="essentialsSec">
      <h2>
        Essentials
        <span>
          <select id="essCatFilter" title="Filter by category"></select>
          <button class="chip" id="addEssential" type="button">+ Add expense</button>
        </span>
      </h2>
      <div id="essentialsList" class="list"></div>
      <div class="totals">
        <div class="badge">Monthly essentials: <span id="essentialsTotal" class="mono">$0.00</span></div>
      </div>
    </div>

    <!-- Debts -->
    <div class="section" id="debtsSec">
      <h2>
        Debts
        <span>
          <select id="debtCatFilter" title="Filter by category"></select>
          <button class="chip" id="addDebt" type="button">+ Add debt</button>
        </span>
      </h2>
      <div id="debtsList" class="list"></div>
      <div class="totals">
        <div class="badge">Total balance: <span id="totBal" class="mono">$0.00</span></div>
        <div class="badge">Total minimums: <span id="totMin" class="mono">$0.00</span></div>
      </div>
    </div>

    <!-- Savings Goals -->
    <div class="section" id="goalsSec">
      <h2>
        Savings Goal(s)
        <button class="chip" id="addGoal" type="button">+ Add goal</button>
      </h2>
      <div id="goalsList" class="list"></div>
      <div class="totals">
        <div class="badge">Monthly required saving: <span id="reqSaveBadge" class="mono">$0.00</span></div>
        <div class="badge">Months to goal: <span id="monthsBadge" class="mono">—</span></div>
      </div>
    </div>

    <!-- Plan summary -->
    <div class="section summary" id="summarySec">
      <h2>Plan summary</h2>
      <div class="grid-2">
        <div class="kpi">
          <h3>Cash flow</h3>
          <p class="muted">Income − Essentials − Debt minimums − Required saving</p>
          <p class="line"><span>Free cash each month</span><span id="extraPool" class="mono right">$0.00</span></p>
          <p class="line"><span>Debt‑to‑income (DTI)</span><span id="dti" class="mono right">—</span></p>
        </div>
        <div class="kpi">
          <h3>Recommendations</h3>
          <p class="line"><span>Strategy</span>
            <select id="strategy">
              <option value="avalanche">Avalanche (highest APR first)</option>
              <option value="snowball">Snowball (smallest balance first)</option>
            </select>
          </p>
          <p class="line"><span>Target debt this month</span><span id="targetDebt" class="mono right">—</span></p>
          <p class="line"><span>Projected debt‑free date</span><span id="projDone" class="mono right">—</span></p>
        </div>
      </div>
      <div id="flags" style="margin-top:10px;"></div>

      <div class="kpi" style="margin-top:10px;">
        <h3>Goal progress</h3>
        <p class="muted">Updates as you enter “Saved so far” and a target date.</p>
        <p class="line"><span>Required monthly saving</span><span id="reqSave" class="mono right">$0.00</span></p>
        <p class="line"><span>Months to goal</span><span id="monthsToGoal" class="mono right">—</span></p>
      </div>
    </div>

    <!-- Export / Import -->
    <div class="section" id="exportSec">
      <h2>Export & import</h2>
      <div class="export-controls">
        <div class="checks">
          <label><input type="checkbox" id="incChk" checked /> Income</label>
          <label><input type="checkbox" id="essChk" checked /> Essentials</label>
          <label><input type="checkbox" id="debChk" checked /> Debts</label>
          <label><input type="checkbox" id="goaChk" checked /> Goals</label>
          <label><input type="checkbox" id="sumChk" checked /> Plan summary</label>
        </div>
        <div class="tip-row">
          <button id="exportCsv" class="chip">Export CSV</button>
          <button id="exportPdf" class="chip">Export PDF</button>
          <button id="blankCsv" class="chip ghost">Download blank CSV template</button>
          <label class="chip ghost" for="importCsvInput" style="cursor:pointer;">Import CSV</label>
          <input id="importCsvInput" type="file" accept=".csv" style="display:none;" />
        </div>
        <div id="importErrors" class="muted"></div>
      </div>
    </div>

    <!-- Tip jar -->
    <div class="section" id="tipSec">
      <h2>Tip jar</h2>
      <p class="muted tip-note" style="display:none;">On Google Play, tips use Play Billing. On the web, you can scan a QR or use the direct links.</p>

      <!-- Google Play tips (auto-shown on Play-capable context) -->
      <div id="playTips" class="tip-row hide">
        <button class="chip" data-tip="tip_small">$1</button>
        <button class="chip" data-tip="tip_medium">$3</button>
        <button class="chip" data-tip="tip_large">$5</button>
        <span id="tipState" class="muted"></span>
      </div>

      <!-- Web tips with brand icons (must show in browsers) -->
      <div id="webTips" class="tip-row">
        <div class="tip-col brand">
          <img src="assets/icon-cashapp.png" alt="CashApp logo" />
          <div class="tip-info">
            <div class="nowrap">CashApp</div>
            <a class="chip" id="tipCashApp" href="https://cash.app/$h3xto" target="_blank" rel="noopener">Open link</a>
          </div>
        </div>
        <div class="tip-col brand">
          <img src="assets/icon-paypal.png" alt="PayPal logo" />
          <div class="tip-info">
            <div class="nowrap">PayPal</div>
            <a class="chip" id="tipPayPal" href="https://paypal.me/h3xto" target="_blank" rel="noopener">Open link</a>
          </div>
        </div>
        <div class="tip-col brand">
          <img src="assets/icon-venmo.png" alt="Venmo logo" />
          <div class="tip-info">
            <div class="nowrap">Venmo</div>
            <a class="chip" id="tipVenmo" href="https://www.venmo.com/u/HEXTO" target="_blank" rel="noopener">Open link</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Guided sticky controls -->
  <div id="guidedControls">
    <div class="app" style="padding-top:6px; padding-bottom:6px;">
      <div class="row" style="grid-template-columns: 1fr auto; align-items:center;">
        <div class="guided-hint">Guided Mode: fill this section, then click Next. You can exit anytime.</div>
        <div>
          <button id="guidedBack" class="chip ghost" type="button">Back</button>
          <button id="guidedNext" class="chip" type="button">Next</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Logo zoom overlay -->
  <div id="logoOverlay" aria-hidden="true">
    <img src="https://github.com/h3xto/H3_Budget_App/blob/main/icons/app-h3-cube-contrast-Hwhite.svg?raw=true" alt="H3 Logo Large" />
  </div>

  <script>
    // ---- Currency helpers ----
    const CURRENCY = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', currencyDisplay: 'symbol' });
    const fmtMoney = v => CURRENCY.format(Number(v||0));
    const parseMoney = s => {
      const n = parseFloat(String(s||'').replace(/[^0-9.-]/g, ''));
      return Number.isFinite(n) ? n : 0;
    };

    // ---- DOM helpers ----
    const $ = id => document.getElementById(id);
    const todayISO = () => new Date().toISOString().slice(0,10);
    const monthsBetween = (a, b) => {
      const d1 = new Date(a), d2 = new Date(b);
      const years = d2.getFullYear() - d1.getFullYear();
      const months = d2.getMonth() - d1.getMonth();
      const total = years*12 + months + (d2.getDate() >= d1.getDate() ? 0 : -1);
      return Math.max(1, total);
    };

    // ---- State ----
    const empty = () => ({
      displayName: '',
      cadence: 26,                // paychecks per year
      strategy: 'avalanche',
      incomes: [],                // {name, amountPerPeriod}
      essentials: [],             // {name, category, amountMonthly, cadenceMonths}
      debts: [],                  // {name, category, balance, apr, min, term}
      goals: []                   // {name, goalAmt, goalDate, goalNow}
    });
    let state = empty();

    function save(){ localStorage.setItem('h3-budget', JSON.stringify(state)); }
    function load(){
      try{
        const raw = localStorage.getItem('h3-budget');
        if (raw) {
          const parsed = JSON.parse(raw);
          // Back-compat: migrate incomes.amountMonthly -> amountPerPeriod
          if (Array.isArray(parsed.incomes)) {
            parsed.incomes = parsed.incomes.map(x => {
              if (x && x.amountPerPeriod == null && x.amountMonthly != null) {
                // reverse out monthly into per-period using cadence
                const cad = Number(parsed.cadence || 26);
                const perMonth = Number(x.amountMonthly || 0);
                const perPeriod = cad ? perMonth * 12 / cad : perMonth;
                return { name: x.name || '', amountPerPeriod: perPeriod };
              }
              return { name: x?.name || '', amountPerPeriod: Number(x?.amountPerPeriod||0) };
            });
          }
          // Back-compat: essentials cadence
          if (Array.isArray(parsed.essentials)) {
            parsed.essentials = parsed.essentials.map(e => ({ ...e, cadenceMonths: parseInt(e?.cadenceMonths)||1 }));
          }
          state = { ...empty(), ...parsed };
        }
      }catch{}
    }

    // ---- Theme ----
    (function initTheme(){
      const saved = localStorage.getItem('h3-theme') || 'dark';
      document.documentElement.dataset.theme = saved;
      $('themeToggle').onclick = () => {
        const cur = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
        document.documentElement.dataset.theme = cur;
        localStorage.setItem('h3-theme', cur);
      };
    })();

    // ---- Orientation lock best-effort ----
    (async function lockPortrait(){ try { await screen.orientation?.lock?.('portrait'); } catch {} })();

    // ---- Binders ----
    function bindText(el, obj, key){ el.addEventListener('input', () => { obj[key] = el.value; compute(); save(); }); }
    function bindNumber(el, obj, key){ el.addEventListener('input', () => { obj[key] = parseMoney(el.value); compute(); save(); }); }
    function bindMoney(input, obj, key) {
      const syncState = () => { obj[key] = parseMoney(input.value); compute(); save(); };
      input.addEventListener('input', syncState);
      input.addEventListener('blur', () => {
        const v = obj[key] || 0;
        input.value = v ? fmtMoney(v) : '';
      });
      input.addEventListener('focus', () => {
        const v = obj[key] || 0;
        input.value = v ? String(v) : '';
      });
    }
    function removeAt(list, i, rerender){ list.splice(i,1); save(); rerender(); compute(); }

    // ---- Income (per-pay-period inputs) ----
    function addIncomeRow(item={name:'', amountPerPeriod:0}){ state.incomes.push(item); save(); renderIncomes(); }
    function renderIncomes(){
      const host = $('incomeList'); host.innerHTML = '';
      state.incomes.forEach((it,i)=>{
        const div = document.createElement('div'); div.className='card';
        div.innerHTML = `
          <div class="row">
            <label>Source <input value="${it.name||''}" placeholder="e.g., Salary" /></label>
            <label>Paycheck amount (net) <input type="text" inputmode="decimal" class="currency-input" value="${it.amountPerPeriod||0}" /></label>
          </div>
          <div class="right"><button class="minor" type="button" data-del>Remove</button></div>`;
        const [src, amt] = div.querySelectorAll('input');
        bindText(src, it, 'name');
        bindMoney(amt, it, 'amountPerPeriod');
        amt.value = it.amountPerPeriod ? fmtMoney(it.amountPerPeriod) : '';
        div.querySelector('[data-del]').onclick=()=>removeAt(state.incomes,i,renderIncomes);
        host.appendChild(div);
      });
      $('incomeTotal').textContent = fmtMoney(totalIncomeMonthly());
      compute();
    }

    // ---- Essentials (with cadence conversion) ----
    function addEssentialRow(item={name:'', category:'General', amountMonthly:0, cadenceMonths:1}){ state.essentials.push(item); save(); renderEssentials(); }
    function renderEssentials(){
      const host = $('essentialsList'); host.innerHTML = '';
      const filter = $('essCatFilter').value || 'All';
      state.essentials
        .filter(it => filter==='All' || (it.category||'General')===filter)
        .forEach((it,i)=>{
        const div = document.createElement('div'); div.className='card';
        const c = (+it.cadenceMonths||1);
        div.innerHTML = `
          <div class="row-4">
            <label>Expense <input value="${it.name||''}" placeholder="e.g., Rent" /></label>
            <label>Category
              <input list="essCats" value="${it.category||'General'}" placeholder="e.g., Housing" />
            </label>
            <label>Amount (gross) <input type="text" inputmode="decimal" class="currency-input" value="${it.amountMonthly||0}" /></label>
            <label>Cadence
              <select class="cadence-select">
                <option value="1" ${c===1?'selected':''}>Monthly</option>
                <option value="3" ${c===3?'selected':''}>Quarterly</option>
                <option value="6" ${c===6?'selected':''}>Bi-annual</option>
                <option value="12" ${c===12?'selected':''}>Annual</option>
              </select>
            </label>
          </div>
          <div class="right"><button class="minor" type="button" data-del>Remove</button></div>`;
        const inputs = div.querySelectorAll('input');
        const selCad = div.querySelector('.cadence-select');
        bindText(inputs[0], it, 'name');
        bindText(inputs[1], it, 'category');
        bindMoney(inputs[2], it, 'amountMonthly');
        inputs[2].value = it.amountMonthly ? fmtMoney(it.amountMonthly) : '';
        selCad.addEventListener('change', () => {
          it.cadenceMonths = parseInt(selCad.value, 10) || 1;
          compute(); save();
        });
        div.querySelector('[data-del]').onclick=()=>{ const idx = state.essentials.indexOf(it); removeAt(state.essentials, idx, renderEssentials); };
        host.appendChild(div);
      });
      $('essentialsTotal').textContent = fmtMoney(totalEssentialsMonthly());
      refreshEssCategories();
      compute();
    }

    // ---- Debts ----
    function addDebtRow(item={name:'', category:'General', balance:0, apr:0, min:0, term:0}){ state.debts.push(item); save(); renderDebts(); }
    function renderDebts(){
      const host = $('debtsList'); host.innerHTML = '';
      const filter = $('debtCatFilter').value || 'All';
      state.debts
        .filter(d => filter==='All' || (d.category||'General')===filter)
        .forEach((d,i)=>{
        const div = document.createElement('div'); div.className='card';
        div.innerHTML = `
          <div class="row-5">
            <label>Debt name <input value="${d.name||''}" placeholder="e.g., Visa"/></label>
            <label>Balance <input type="text" inputmode="decimal" class="currency-input" value="${d.balance||0}" /></label>
            <label>APR % <input type="number" step="0.01" value="${d.apr||0}" /></label>
            <label>Min (optional) <input type="text" inputmode="decimal" class="currency-input" value="${d.min||0}" /></label>
            <label>Term months (opt) <input type="number" step="1" value="${d.term||0}" /></label>
          </div>
          <div class="row">
            <label>Category <input list="debtCats" value="${d.category||'General'}" placeholder="e.g., Credit Card"/></label>
            <div class="right"><button class="minor" type="button" data-del>Remove</button></div>
          </div>`;
        const ins = div.querySelectorAll('input');
        bindText(ins[0], d, 'name');
        bindMoney(ins[1], d, 'balance');
        bindNumber(ins[2], d, 'apr');
        bindMoney(ins[3], d, 'min');
        bindNumber(ins[4], d, 'term');
        bindText(ins[5], d, 'category');
        ins[1].value = d.balance ? fmtMoney(d.balance) : '';
        ins[3].value = d.min ? fmtMoney(d.min) : '';
        div.querySelector('[data-del]').onclick=()=>{ const idx = state.debts.indexOf(d); removeAt(state.debts, idx, renderDebts); };
        host.appendChild(div);
      });
      refreshDebtCategories();
      compute();
    }

    // ---- Goals ----
    function addGoalRow(item={name:'', goalAmt:0, goalDate:todayISO(), goalNow:0}){ state.goals.push(item); save(); renderGoals(); }
    function renderGoals(){
      const host = $('goalsList'); host.innerHTML = '';
      state.goals.forEach((g,i)=>{
        const div = document.createElement('div'); div.className='card';
        div.innerHTML = `
          <div class="row-4">
            <label>Goal name <input value="${g.name||''}" placeholder="e.g., Emergency fund"/></label>
            <label>Target amount <input type="text" inputmode="decimal" class="currency-input" value="${g.goalAmt||0}" /></label>
            <label>Target date <input type="date" value="${g.goalDate||todayISO()}" /></label>
            <label>Saved so far <input type="text" inputmode="decimal" class="currency-input" value="${g.goalNow||0}" /></label>
          </div>
          <div class="right"><button class="minor" type="button" data-del>Remove</button></div>`;
        const [name, amt, date, now] = div.querySelectorAll('input');
        bindText(name, g, 'name');
        bindMoney(amt, g, 'goalAmt');
        date.addEventListener('change', ()=>{ g.goalDate = date.value; compute(); save(); });
        bindMoney(now, g, 'goalNow');
        amt.value = g.goalAmt ? fmtMoney(g.goalAmt) : '';
        now.value = g.goalNow ? fmtMoney(g.goalNow) : '';
        div.querySelector('[data-del]').onclick=()=>removeAt(state.goals, i, renderGoals);
        host.appendChild(div);
      });
      compute();
    }

    // ---- Totals ----
    const periodsPerMonth = () => (Number(state.cadence||26) / 12);
    const totalIncomeMonthly = () => state.incomes.reduce((s,x)=> s + (parseMoney(x.amountPerPeriod)||0) * periodsPerMonth(), 0);
    const totalEssentialsMonthly = () =>
      state.essentials.reduce((s, x) => {
        const amt = parseMoney(x.amountMonthly);
        const cad = parseInt(x.cadenceMonths, 10) || 1; // Monthly=1, Quarterly=3, Bi-annual=6, Annual=12
        return s + (amt / cad);
      }, 0);

    // ---- Categories ----
    function refreshEssCategories(){
      const sel = $('essCatFilter');
      const cats = Array.from(new Set(state.essentials.map(e=>e.category||'General')));
      const values = ['All', ...cats].filter((v,i,self)=>self.indexOf(v)===i);
      const cur = sel.value || 'All';
      sel.innerHTML = values.map(v=>`<option>${v}</option>`).join('');
      sel.value = values.includes(cur)?cur:'All';
    }
    function refreshDebtCategories(){
      const sel = $('debtCatFilter');
      const cats = Array.from(new Set(state.debts.map(d=>d.category||'General')));
      const values = ['All', ...cats].filter((v,i,self)=>self.indexOf(v)===i);
      const cur = sel.value || 'All';
      sel.innerHTML = values.map(v=>`<option>${v}</option>`).join('');
      sel.value = values.includes(cur)?cur:'All';
    }

    // ---- Math & planning ----
    function compute(){
      // Sync header inputs
      $('displayName').value = state.displayName || '';
      $('cadence').value = String(state.cadence || 26);
      $('strategy').value = state.strategy || 'avalanche';

      // Goal KPIs from first goal
      const g = state.goals[0] || {};
      const months = g.goalDate ? monthsBetween(new Date(), g.goalDate) : '';
      $('monthsToGoal').textContent = months || '—';
      $('monthsBadge').textContent = months || '—';
      const reqSave = (parseMoney(g.goalAmt) > 0 && months) ? Math.max(0, (parseMoney(g.goalAmt)-parseMoney(g.goalNow))/months) : 0;
      $('reqSave').textContent = fmtMoney(reqSave);
      $('reqSaveBadge').textContent = fmtMoney(reqSave);

      // Debts normalization
      let totBal=0, totMin=0;
      const normalized = state.debts.filter(d=>(parseMoney(d.balance)||0)>0).map(d=>{
        const balance = parseMoney(d.balance);
        const minIn = parseMoney(d.min);
        const apr = parseMoney(d.apr);
        const term = parseInt(d.term)||0;
        const r = (apr||0)/100/12;
        const amortMin = (term>0 && r>0) ? ((balance*r)/(1 - Math.pow(1+r, -term))) : 0;
        const floorMin = Math.min(balance||0, 25);
        const min = minIn>0 ? minIn : (amortMin>0 ? amortMin : floorMin);
        totBal += (balance||0); totMin += min;
        return {...d, balance, apr, term, r, min};
      });
      $('totBal').textContent = fmtMoney(totBal);
      $('totMin').textContent = fmtMoney(totMin);

      const inc = totalIncomeMonthly();
      const fixed = totalEssentialsMonthly();
      const extraPool = (inc - fixed - totMin - reqSave);
      $('extraPool').textContent = fmtMoney(extraPool);

      const dti = inc>0 ? (totMin/inc) : 0;
      $('dti').textContent = inc>0 ? (dti*100).toFixed(1)+'%' : '—';

      // Avalanche vs Snowball target
      let target='—';
      if (normalized.length){
        const sorted = normalized.slice().sort((a,b) => state.strategy==='avalanche' ? (b.apr - a.apr) : ((a.balance||0) - (b.balance||0)));
        target = sorted[0]?.name || '—';
      }
      $('targetDebt').textContent = target;

      const flags=[];
      if (extraPool < 0) flags.push('⚠️ Negative cash flow — raise income, reduce essentials, delay goal, or adjust debt terms.');
      if ((parseMoney(g.goalAmt)||0)>0 && !g.goalDate) flags.push('ℹ️ Set a goal date to compute required monthly saving.');
      if (normalized.some(d=> (d.min||0) < (d.balance||0)*d.r)) flags.push('⚠️ A minimum payment is below monthly interest (negative amortization).');
      $('flags').innerHTML = flags.length
        ? `<div class="${extraPool<0?'danger':'warn'}">${flags.join('<br>')}</div>`
        : `<div class="ok">✅ Plan is feasible based on current inputs.</div>`;

      $('projDone').textContent = projection(normalized, Math.max(0, extraPool), state.strategy);

      // Totals UI
      $('incomeTotal').textContent = fmtMoney(inc);
      $('essentialsTotal').textContent = fmtMoney(fixed);

      save();
    }

    function projection(debts, extra, strategy){
      debts = debts.map(d=>({...d, bal:d.balance, alive:(d.balance||0)>0}));
      let month=0, guard=0;
      while(debts.some(d=>d.alive) && guard<1200){
        debts.forEach(d=>{
          if(!d.alive) return;
          const interest = d.bal * d.r;
          const due = d.bal + interest;
          const pay = Math.min(d.min, due);
          d.bal = due - pay;
          if (d.bal <= 0.01){ d.bal=0; d.alive=false; }
        });
        const alive = debts.filter(d=>d.alive);
        if (!alive.length) break;
        alive.sort((a,b)=> strategy==='avalanche' ? (b.apr - a.apr) : (a.bal - b.bal));
        let t = alive[0];
        if (extra>0 && t.alive){
          t.bal = Math.max(0, t.bal - extra);
          if (t.bal <= 0.01){ t.bal=0; t.alive=false; }
        }
        month++; guard++;
      }
      if (guard>=1200) return '—';
      const done = new Date(); done.setMonth(done.getMonth()+month);
      return done.toLocaleDateString();
    }

    // ---- Static controls ----
    $('displayName').addEventListener('input', e=>{ state.displayName = e.target.value; save(); });
    $('cadence').addEventListener('change', e=>{ state.cadence = parseInt(e.target.value,10); save(); compute(); });
    $('strategy').addEventListener('change', e=>{ state.strategy = e.target.value; save(); compute(); });

    // ---- Add buttons ----
    $('addIncome').onclick = ()=>addIncomeRow();
    $('addEssential').onclick = ()=>addEssentialRow();
    $('addDebt').onclick = ()=>addDebtRow();
    $('addGoal').onclick = ()=>addGoalRow({name:'', goalAmt:0, goalDate:todayISO(), goalNow:0});

    // ---- Filters ----
    $('essCatFilter').addEventListener('change', renderEssentials);
    $('debtCatFilter').addEventListener('change', renderDebts);

    // ---- Tip links (web) ----
    (function initLinks(){
      $('tipCashApp').href = 'https://cash.app/$h3xto';
      $('tipPayPal').href = 'https://paypal.me/h3xto';
      $('tipVenmo').href = 'https://www.venmo.com/u/HEXTO';
    })();

    // ---- Tip Jar (Play Billing) — single policy-safe implementation ----
  const PLAY_ORIGIN = 'https://play.google.com/billing';

  async function setupTips() {
    const hint = $('tipState');

    // Default: show web tips, hide Play tips
    $('webTips').classList.remove('hide');
    $('playTips').classList.add('hide');

    // If Play Billing API not present, stop here
    if (typeof getDigitalGoodsService !== 'function') {
      return;
    }

    // Try to init Play Billing — if it fails, leave web tips visible
    try {
      const dgs = await getDigitalGoodsService(PLAY_ORIGIN);

      // If we got here, we’re in a real Play‑capable context: hide web tips for policy
      $('webTips').classList.add('hide');

      try {
        await dgs.listPurchasableItems(['tip_small', 'tip_medium', 'tip_large']);
        if (hint) hint.textContent = '';
      } catch {
        if (hint) hint.textContent = 'Tip products unavailable.';
      }

      async function buy(id) {
        try {
          const details = await dgs.getDetails([id]);
          if (!details?.length) { alert('Product not available.'); return; }
          const p = await dgs.launchBillingFlow({ itemId: id });
          if (p?.purchaseToken) {
            await dgs.acknowledge({ purchaseToken: p.purchaseToken });
            alert('Thanks for the tip! 🙏');
          }
        } catch {
          alert('Purchase cancelled or failed.');
        }
      }

      document.querySelectorAll('[data-tip]').forEach(b => {
        b.onclick = () => buy(b.dataset.tip);
      });

      $('playTips').classList.remove('hide');

    } catch {
      // Billing init failed — leave web tips visible
      $('playTips').classList.add('hide');
      if (hint) hint.textContent = 'Tips unavailable at the moment.';
    }
  }

    // ---- CSV / PDF ----
    const includeMap = () => ({
      income: $('incChk').checked,
      essentials: $('essChk').checked,
      debts: $('debChk').checked,
      goals: $('goaChk').checked,
      summary: $('sumChk').checked
    });

    function toCsv(rows){
      const esc = v => {
        v = (v ?? '').toString();
        if (/[",\n]/.test(v)) v = '"' + v.replace(/"/g,'""') + '"';
        return v;
      };
      return rows.map(r=> r.map(esc).join(',')).join('\n');
    }

    function buildCsv(include){
      const rows = [];
      rows.push(['section','name','category','amountPerPeriod','balance','apr','min','term','goalAmt','goalDate','goalNow','cadence','strategy','displayName','cadenceMonths','amountMonthlyLegacy']);
      if (include.income){
        state.incomes.forEach(x=> rows.push(['income', x.name||'', '', parseMoney(x.amountPerPeriod)||0, '', '', '', '', '', '', '', state.cadence, state.strategy, state.displayName, '', '']));
      }
      if (include.essentials){
        state.essentials.forEach(x=> rows.push(['essentials', x.name||'', x.category||'General', '', '', '', '', '', '', '', '', state.cadence, state.strategy, state.displayName, (parseInt(x.cadenceMonths)||1), parseMoney(x.amountMonthly)||0]));
      }
      if (include.debts){
        state.debts.forEach(d=> rows.push(['debts', d.name||'', d.category||'General', '', parseMoney(d.balance)||0, parseMoney(d.apr)||0, parseMoney(d.min)||0, parseInt(d.term)||0, '', '', '', state.cadence, state.strategy, state.displayName, '', '']));
      }
      if (include.goals){
        state.goals.forEach(g=> rows.push(['goals', g.name||'', '', '', '', '', '', '', parseMoney(g.goalAmt)||0, g.goalDate||'', parseMoney(g.goalNow)||0, state.cadence, state.strategy, state.displayName, '', '']));
      }
      if (include.summary){
        const inc = totalIncomeMonthly(), ess = totalEssentialsMonthly();
        rows.push(['summary','incomeTotal','', inc,'','','','','','','', state.cadence, state.strategy, state.displayName, '', '']);
        rows.push(['summary','essentialsTotal','', ess,'','','','','','','', state.cadence, state.strategy, state.displayName, '', '']);
      }
      return toCsv(rows);
    }

    function download(filename, content, type='text/plain'){
      const blob = new Blob([content], {type});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    $('exportCsv').onclick = ()=>{
      const csv = buildCsv(includeMap());
      download(`h3-budget-${Date.now()}.csv`, csv, 'text/csv');
    };

    $('blankCsv').onclick = ()=>{
      const header = ['section','name','category','amountPerPeriod','balance','apr','min','term','goalAmt','goalDate','goalNow','cadence','strategy','displayName','cadenceMonths','amountMonthlyLegacy'];
      const example = [
        ['income','Salary','', '2500','','','','','','','','26','avalanche','', '', ''],  // example net per paycheck
        ['essentials','Rent','Housing','', '', '', '', '', '', '', '', '26','avalanche','', '1', '1800'],
        ['debts','Visa','Credit Card','', '3000','24.99','','','', '', '', '26','avalanche','', '', ''],
        ['goals','Emergency Fund','', '', '','','','', '6000','2026-12-01','1500','26','avalanche','', '', '']
      ];
      const csv = toCsv([header, ...example]);
      download('h3-blank-template.csv', csv, 'text/csv');
    };

    $('importCsvInput').addEventListener('change', (e)=>{
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev)=>{
        const text = (ev.target.result||'').toString();
        const lines = text.split(/\r?\n/).filter(Boolean);
        const err = [];
        if (!lines.length) { $('importErrors').textContent = 'Empty CSV.'; return; }
        const header = lines[0].split(',');
        const get = (cells, key) => {
          const idx = header.indexOf(key);
          return idx>=0 ? cells[idx] : '';
        };
        const next = empty();
        for (let i=1;i<lines.length;i++){
          const raw = lines[i];
          const cells = [];
          let cur='', inQ=false;
          for (let j=0;j<raw.length;j++){
            const ch=raw[j];
            if (inQ){
              if (ch==='"' && raw[j+1]==='"'){ cur+='"'; j++; }
              else if (ch==='"' ){ inQ=false; }
              else cur+=ch;
            } else {
              if (ch===','){ cells.push(cur); cur=''; }
              else if (ch==='"'){ inQ=true; }
              else cur+=ch;
            }
          }
          cells.push(cur);
          const section = (get(cells,'section')||'').toLowerCase();
          try{
            if (section==='income'){
              // prefer amountPerPeriod; fallback to legacy amountMonthly
              const per = parseMoney(get(cells,'amountPerPeriod'));
              const legacy = parseMoney(get(cells,'amountMonthly'));
              const cad = parseInt(get(cells,'cadence'))||next.cadence||26;
              const amountPerPeriod = per || (legacy ? (legacy*12/(cad||26)) : 0);
              next.incomes.push({ name:get(cells,'name'), amountPerPeriod });
            } else if (section==='essentials'){
              next.essentials.push({
                name:get(cells,'name'),
                category:get(cells,'category')||'General',
                amountMonthly: parseMoney(get(cells,'amountMonthlyLegacy')) || parseMoney(get(cells,'amountMonthly')) || 0,
                cadenceMonths: parseInt(get(cells,'cadenceMonths'))||1
              });
            } else if (section==='debts'){
              next.debts.push({
                name:get(cells,'name'),
                category:get(cells,'category')||'General',
                balance: parseMoney(get(cells,'balance'))||0,
                apr: parseMoney(get(cells,'apr'))||0,
                min: parseMoney(get(cells,'min'))||0,
                term: parseInt(get(cells,'term'))||0
              });
            } else if (section==='goals'){
              next.goals.push({
                name:get(cells,'name'),
                goalAmt: parseMoney(get(cells,'goalAmt'))||0,
                goalDate: get(cells,'goalDate')||todayISO(),
                goalNow: parseMoney(get(cells,'goalNow'))||0
              });
            }
            const cad = parseInt(get(cells,'cadence'));
            if (!Number.isNaN(cad)) next.cadence = cad;
            next.strategy = get(cells,'strategy') || next.strategy;
            next.displayName = get(cells,'displayName') || next.displayName;
          }catch(ex){
            err.push(`Row ${i+1}: ${ex?.message||'parse error'}`);
          }
        }
        state = next;
        save();
        renderAll();
        $('importErrors').textContent = err.length ? `Imported with warnings:\n${err.join('\n')}` : 'Import successful.';
      };
      reader.onerror = ()=>{ $('importErrors').textContent = 'Failed to read file.'; };
      reader.readAsText(file);
      e.target.value = '';
    });

    // PDF via print-friendly view
    $('exportPdf').onclick = ()=>{
      const include = includeMap();
      const w = window.open('', '_blank');
      const style = `
        <style>
          body { font: 14px/1.5 Inter, Arial; padding: 16px; color: #000; }
          h1 { margin: 0 0 10px; }
          h2 { margin: 18px 0 8px; border-bottom: 1px solid #ccc; padding-bottom: 4px; }
          table { width: 100%; border-collapse: collapse; margin: 8px 0; }
          th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; }
          .mono { font-variant-numeric: tabular-nums; }
        </style>`;
      const esc = s => (s??'').toString().replace(/[&<>]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
      const rows = (arr, cols) => arr.map(o=> `<tr>${cols.map(k=>`<td>${esc(o[k]??'')}</td>`).join('')}</tr>`).join('');
      const inc = totalIncomeMonthly(), ess = totalEssentialsMonthly();
      const g = state.goals[0]||{};
      const content = [];
      content.push(`<h1>H³ Budget Tool — ${esc(state.displayName||'Plan')}</h1>`);
      if (include.summary){
        content.push(`<h2>Plan summary</h2>
          <table><tbody>
          <tr><th>Income</th><td class="mono">${fmtMoney(inc)}</td></tr>
          <tr><th>Essentials (monthly equivalent)</th><td class="mono">${fmtMoney(ess)}</td></tr>
          <tr><th>Debt minimums</th><td class="mono">${document.getElementById('totMin').textContent}</td></tr>
          <tr><th>Required saving</th><td class="mono">${document.getElementById('reqSave').textContent}</td></tr>
          <tr><th>Free cash</th><td class="mono">${document.getElementById('extraPool').textContent}</td></tr>
          <tr><th>DTI</th><td>${document.getElementById('dti').textContent}</td></tr>
          <tr><th>Strategy</th><td>${esc(state.strategy)}</td></tr>
          <tr><th>Target debt</th><td>${esc(document.getElementById('targetDebt').textContent)}</td></tr>
          <tr><th>Projected debt‑free date</th><td>${esc(document.getElementById('projDone').textContent)}</td></tr>
          <tr><th>Primary goal</th><td>${esc(g.name||'—')}</td></tr>
          <tr><th>Months to goal</th><td>${document.getElementById('monthsToGoal').textContent}</td></tr>
          </tbody></table>`);
      }
      if (include.income && state.incomes.length){
        content.push(`<h2>Income</h2>
          <table><thead><tr><th>Source</th><th>Paycheck amount (net)</th></tr></thead><tbody>
          ${rows(state.incomes.map(x=>({name:x.name||'', amt:fmtMoney(parseMoney(x.amountPerPeriod)||0)})), ['name','amt'])}
          </tbody></table>`);
      }
      if (include.essentials && state.essentials.length){
        content.push(`<h2>Essentials</h2>
          <table><thead><tr><th>Expense</th><th>Category</th><th>Amount (gross)</th><th>Cadence</th></tr></thead><tbody>
          ${rows(state.essentials.map(x=>({
            name:x.name||'',
            cat:x.category||'General',
            amt:fmtMoney(parseMoney(x.amountMonthly)||0),
            cad:(parseInt(x.cadenceMonths)||1)
          })), ['name','cat','amt','cad'])}
          </tbody></table>`);
      }
      if (include.debts && state.debts.length){
        content.push(`<h2>Debts</h2>
          <table><thead><tr><th>Name</th><th>Category</th><th>Balance</th><th>APR %</th><th>Min</th><th>Term (mo)</th></tr></thead><tbody>
          ${rows(state.debts.map(d=>({
            name:d.name||'', cat:d.category||'General',
            bal:fmtMoney(parseMoney(d.balance)||0), apr:(parseMoney(d.apr)||0).toFixed(2),
            min:fmtMoney(parseMoney(d.min)||0), term: parseInt(d.term)||0
          })), ['name','cat','bal','apr','min','term'])}
          </tbody></table>`);
      }
      if (include.goals && state.goals.length){
        content.push(`<h2>Savings Goal(s)</h2>
          <table><thead><tr><th>Name</th><th>Target amount</th><th>Target date</th><th>Saved so far</th></tr></thead><tbody>
          ${rows(state.goals.map(g=>({name:g.name||'', amt:fmtMoney(parseMoney(g.goalAmt)||0), date:g.goalDate||'', now:fmtMoney(parseMoney(g.goalNow)||0)})), ['name','amt','date','now'])}
          </tbody></table>`);
      }
      w.document.write(`<html><head><title>H3 Budget Export</title>${style}</head><body>${content.join('')}</body></html>`);
      w.document.close();
      w.focus();
      w.print();
    };

    // ---- Datalists ----
    const dlEss = document.createElement('datalist'); dlEss.id = 'essCats';
    const dlDebt = document.createElement('datalist'); dlDebt.id = 'debtCats';
    document.body.appendChild(dlEss); document.body.appendChild(dlDebt);
    function refreshDatalists(){
      const ess = Array.from(new Set(state.essentials.map(e=>e.category||'General'))).filter(Boolean).sort();
      const deb = Array.from(new Set(state.debts.map(d=>d.category||'General'))).filter(Boolean).sort();
      dlEss.innerHTML = ess.map(c=>`<option value="${c}">`).join('');
      dlDebt.innerHTML = deb.map(c=>`<option value="${c}">`).join('');
    }
    const _save = save;
    save = function(){ _save(); refreshDatalists(); };

    // ---- Guided Mode (toggle + sticky footer + focus) ----
    const guided = {
      enabled: false,
      order: ['incomeSec','essentialsSec','debtsSec','goalsSec'],
      idx: 0
    };
    function applyGuided() {
      document.body.classList.toggle('guided-dim', guided.enabled);
      $('guidedControls').classList.toggle('show', guided.enabled);
      $('guidedToggle').setAttribute('aria-pressed', guided.enabled ? 'true' : 'false');
      $('guidedToggle').classList.toggle('primary', guided.enabled);

      // Dim all sections, focus only active
      const ids = ['profileSec','incomeSec','essentialsSec','debtsSec','goalsSec','summarySec','exportSec','tipSec'];
      ids.forEach(id => {
        const sec = $(id);
        if (!sec) return;
        if (!guided.enabled) {
          sec.classList.remove('guided-focus');
          sec.style.opacity = '';
          sec.style.filter = '';
        } else {
          const activeId = guided.order[guided.idx];
          const focus = (id === activeId);
          sec.classList.toggle('guided-focus', focus);
          sec.style.opacity = focus ? '1' : '';
          sec.style.filter = focus ? 'none' : '';
        }
      });

      // Scroll active into view
      if (guided.enabled) {
        const active = $(guided.order[guided.idx]);
        if (active) active.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }
    function nextStep() { if (guided.idx < guided.order.length - 1) guided.idx++; applyGuided(); }
    function prevStep() { if (guided.idx > 0) guided.idx--; applyGuided(); }

    (function initGuided(){
      $('guidedToggle').addEventListener('click', () => {
        guided.enabled = !guided.enabled;
        if (guided.enabled) guided.idx = 0;
        applyGuided();
      });
      $('guidedBack').addEventListener('click', prevStep);
      $('guidedNext').addEventListener('click', nextStep);

      // If user clicks a section header while guided is on, jump to that section
      [['incomeSec','Income'],['essentialsSec','Essentials'],['debtsSec','Debts'],['goalsSec','Savings Goal(s)']].forEach(([id])=>{
        const sec = $(id);
        if (sec) {
          sec.querySelector('h2')?.addEventListener('click', ()=>{
            if (!guided.enabled) return;
            const idx = guided.order.indexOf(id);
            if (idx >= 0) { guided.idx = idx; applyGuided(); }
          });
        }
      });
    })();

    // ---- Logo zoom ----
    (function initLogoZoom(){
      const overlay = $('logoOverlay');
      const logo = $('logoImg');
      logo.addEventListener('click', ()=> overlay.classList.add('show'));
      overlay.addEventListener('click', ()=> overlay.classList.remove('show'));
      document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') overlay.classList.remove('show'); });
    })();

    // ---- Boot ----
    function renderAll(){
      $('displayName').value = state.displayName || '';
      $('cadence').value = String(state.cadence || 26);
      $('strategy').value = state.strategy || 'avalanche';
      refreshEssCategories();
      refreshDebtCategories();
      if (!$('essCatFilter').value) $('essCatFilter').value = 'All';
      if (!$('debtCatFilter').value) $('debtCatFilter').value = 'All';
      renderIncomes();
      renderEssentials();
      renderDebts();
      renderGoals();
      compute();
    }

    load();
    renderAll();
    setupTips();
  </script>
</body>
</html>
